<!doctype html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Associations — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style-9e7329e5b4c46ecb619db14d43a6724d.css" data-turbo-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print-a4d2686c548e59657450d04dc27f7787.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight-a0d2133dd0073968b2d33b1f1360a2a3.css" data-turbo-track="reload">

  <link rel="icon" href="images/favicon.ico" sizes="any">

  <link rel="apple-touch-icon" href="images/icon.png">

  <script src="javascripts/@hotwired--turbo-764f59c7edbeb902a9068c0340dd274e.js" data-turbo-track="reload"></script>
  <script src="javascripts/clipboard-8b7aed6f069f0cf58eeae353cd2f898b.js" data-turbo-track="reload"></script>
  <script src="javascripts/guides-be644dbd164a32c619aa8f714fc0b4bf.js" data-turbo-track="reload"></script>

  <meta property="og:title" content="Active Record Associations — Ruby on Rails Guides" />
  <meta name="description" content="Active Record AssociationsThis guide covers the association features of Active Record.After reading this guide, you will know how to: Understand the various types of associations. Declare associations between Active Record models. Choose the right association type for your models. Use Single Table Inheritance. Setting up and using Delegated Types." />
  <meta property="og:description" content="Active Record AssociationsThis guide covers the association features of Active Record.After reading this guide, you will know how to: Understand the various types of associations. Declare associations between Active Record models. Choose the right association type for your models. Use Single Table Inheritance. Setting up and using Delegated Types." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100..900&family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#C81418">
</head>

<body class="guide">
  <nav id="topNav" aria-label="Secondary">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </nav>
  <header id="page_header">
    <div class="wrapper clearfix">
      <nav id="feature_nav">
        <div class="header-logo">
          <a href="index.html" title="Return to the Guides Home for Edge Guides">Guides</a>
          <span id="version_switcher">
            Version:
            <select class="guides-version">
              <option value="https://edgeguides.rubyonrails.org/" selected>Edge</option>
                <option value="https://guides.rubyonrails.org/v7.2/">7.2</option>
                <option value="https://guides.rubyonrails.org/v7.1/">7.1</option>
                <option value="https://guides.rubyonrails.org/v7.0/">7.0</option>
                <option value="https://guides.rubyonrails.org/v6.1/">6.1</option>
                <option value="https://guides.rubyonrails.org/v6.0/">6.0</option>
                <option value="https://guides.rubyonrails.org/v5.2/">5.2</option>
                <option value="https://guides.rubyonrails.org/v5.1/">5.1</option>
                <option value="https://guides.rubyonrails.org/v5.0/">5.0</option>
                <option value="https://guides.rubyonrails.org/v4.2/">4.2</option>
                <option value="https://guides.rubyonrails.org/v4.1/">4.1</option>
                <option value="https://guides.rubyonrails.org/v4.0/">4.0</option>
                <option value="https://guides.rubyonrails.org/v3.2/">3.2</option>
                <option value="https://guides.rubyonrails.org/v3.1/">3.1</option>
                <option value="https://guides.rubyonrails.org/v3.0/">3.0</option>
                <option value="https://guides.rubyonrails.org/v2.3/">2.3</option>
            </select>
          </span>
        </div>
        <ul class="nav">
          <li><a class="nav-item" id="home_nav" href="https://rubyonrails.org/">Home</a></li>
          <li class="guides-index guides-index-large">
            <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
            <div id="guides" class="clearfix" style="display: none;">
              <hr />
              <dl class="guides-section-container">
                  <div class="guides-section">
                    <dt>Start Here</dt>
                    <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Models</dt>
                    <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                    <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                    <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                    <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                    <dd><a href="association_basics.html">Active Record Associations</a></dd>
                    <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                    <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Views</dt>
                    <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                    <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                    <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                    <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Controllers</dt>
                    <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                    <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Other Components</dt>
                    <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                    <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                    <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                    <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                    <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                    <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                    <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Digging Deeper</dt>
                    <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                    <dd><a href="testing.html">Testing Rails Applications</a></dd>
                    <dd><a href="security.html">Securing Rails Applications</a></dd>
                    <dd><a href="error_reporting.html">Error Reporting in Rails Applications</a></dd>
                    <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                    <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                    <dd><a href="command_line.html">The Rails Command Line</a></dd>
                    <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                    <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                    <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading</a></dd>
                    <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                    <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                    <dd><a href="tuning_performance_for_deployment.html">Tuning Performance for Deployment</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Advanced Active Record</dt>
                    <dd><a href="active_record_multiple_databases.html">Multiple Databases</a></dd>
                    <dd><a href="active_record_composite_primary_keys.html">Composite Primary Keys</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Extending Rails</dt>
                    <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                    <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Contributing</dt>
                    <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                    <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                    <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                    <dd><a href="development_dependencies_install.html">Installing Rails Core Development Dependencies</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Policies</dt>
                    <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Release Notes</dt>
                    <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                    <dd><a href="7_2_release_notes.html">Version 7.2 - August 2024</a></dd>
                    <dd><a href="7_1_release_notes.html">Version 7.1 - October 2023</a></dd>
                    <dd><a href="7_0_release_notes.html">Version 7.0 - December 2021</a></dd>
                    <dd><a href="6_1_release_notes.html">Version 6.1 - December 2020</a></dd>
                    <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                    <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                    <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                    <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                    <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                    <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                    <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                    <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                    <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                    <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                    <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                    <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                  </div>
              </dl>
            </div>
          </li>
          <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
          <li class="guides-index guides-index-small">
            <select class="guides-index-item nav-item">
              <option value="index.html">Guides Index</option>
                <optgroup label="Start Here">
                    <option value="getting_started.html">Getting Started with Rails</option>
                </optgroup>
                <optgroup label="Models">
                    <option value="active_record_basics.html">Active Record Basics</option>
                    <option value="active_record_migrations.html">Active Record Migrations</option>
                    <option value="active_record_validations.html">Active Record Validations</option>
                    <option value="active_record_callbacks.html">Active Record Callbacks</option>
                    <option value="association_basics.html">Active Record Associations</option>
                    <option value="active_record_querying.html">Active Record Query Interface</option>
                    <option value="active_model_basics.html">Active Model Basics</option>
                </optgroup>
                <optgroup label="Views">
                    <option value="action_view_overview.html">Action View Overview</option>
                    <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                    <option value="action_view_helpers.html">Action View Helpers</option>
                    <option value="form_helpers.html">Action View Form Helpers</option>
                </optgroup>
                <optgroup label="Controllers">
                    <option value="action_controller_overview.html">Action Controller Overview</option>
                    <option value="routing.html">Rails Routing from the Outside In</option>
                </optgroup>
                <optgroup label="Other Components">
                    <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                    <option value="action_mailer_basics.html">Action Mailer Basics</option>
                    <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                    <option value="action_text_overview.html">Action Text Overview</option>
                    <option value="active_job_basics.html">Active Job Basics</option>
                    <option value="active_storage_overview.html">Active Storage Overview</option>
                    <option value="action_cable_overview.html">Action Cable Overview</option>
                </optgroup>
                <optgroup label="Digging Deeper">
                    <option value="i18n.html">Rails Internationalization (I18n) API</option>
                    <option value="testing.html">Testing Rails Applications</option>
                    <option value="security.html">Securing Rails Applications</option>
                    <option value="error_reporting.html">Error Reporting in Rails Applications</option>
                    <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                    <option value="configuring.html">Configuring Rails Applications</option>
                    <option value="command_line.html">The Rails Command Line</option>
                    <option value="asset_pipeline.html">The Asset Pipeline</option>
                    <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                    <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading</option>
                    <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                    <option value="api_app.html">Using Rails for API-only Applications</option>
                    <option value="tuning_performance_for_deployment.html">Tuning Performance for Deployment</option>
                </optgroup>
                <optgroup label="Advanced Active Record">
                    <option value="active_record_multiple_databases.html">Multiple Databases</option>
                    <option value="active_record_composite_primary_keys.html">Composite Primary Keys</option>
                </optgroup>
                <optgroup label="Extending Rails">
                    <option value="rails_on_rack.html">Rails on Rack</option>
                    <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                </optgroup>
                <optgroup label="Contributing">
                    <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                    <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                    <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
                    <option value="development_dependencies_install.html">Installing Rails Core Development Dependencies</option>
                </optgroup>
                <optgroup label="Policies">
                    <option value="maintenance_policy.html">Maintenance Policy</option>
                </optgroup>
                <optgroup label="Release Notes">
                    <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                    <option value="7_2_release_notes.html">Version 7.2 - August 2024</option>
                    <option value="7_1_release_notes.html">Version 7.1 - October 2023</option>
                    <option value="7_0_release_notes.html">Version 7.0 - December 2021</option>
                    <option value="6_1_release_notes.html">Version 6.1 - December 2020</option>
                    <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                    <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                    <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                    <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                    <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                    <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                    <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                    <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                    <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                    <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                    <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                    <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
                </optgroup>
            </select>
          </li>
      </ul>
      </nav>
    </div>
  </header>
  <hr class="hide" />

  <section id="feature">
    <div class="wrapper">
      <h1>Active Record Associations</h1><p>This guide covers the association features of Active Record.</p><p>After reading this guide, you will know how to:</p>
<ul>
<li>Understand the various types of associations.</li>
<li>Declare associations between Active Record models.</li>
<li>Choose the right association type for your models.</li>
<li>Use Single Table Inheritance.</li>
<li>Setting up and using Delegated Types.</li>
</ul>


                <nav id="subCol">
            <h3 class="chapter">
              <picture>
                <!-- Using the `source`  HTML tag to set the dark theme image -->
                <source
                  srcset="images/icon_book-close-bookmark-1-wht.svg"
                  media="(prefers-color-scheme: dark)"
                />
                <img src="images/icon_book-close-bookmark-1.svg" alt="Chapter Icon" />
              </picture>
              Chapters
            </h3>
            <ol class="chapters">
<li><a href="#associations-overview">Associations Overview</a>

<ul>
<li><a href="#without-associations">Without Associations</a></li>
<li><a href="#using-associations">Using Associations</a></li>
</ul></li>
<li><a href="#types-of-associations">Types of Associations</a>

<ul>
<li><a href="#belongs-to"><code>belongs_to</code></a></li>
<li><a href="#has-one"><code>has_one</code></a></li>
<li><a href="#has-many"><code>has_many</code></a></li>
<li><a href="#has-many-through"><code>has_many :through</code></a></li>
<li><a href="#has-one-through"><code>has_one :through</code></a></li>
<li><a href="#has-and-belongs-to-many"><code>has_and_belongs_to_many</code></a></li>
</ul></li>
<li><a href="#choosing-an-association">Choosing an Association</a>

<ul>
<li><a href="#belongs-to-vs-has-one"><code>belongs_to</code> vs <code>has_one</code></a></li>
<li><a href="#has-many-through-vs-has-and-belongs-to-many"><code>has_many :through</code> vs <code>has_and_belongs_to_many</code></a></li>
</ul></li>
<li><a href="#advanced-associations">Advanced Associations</a>

<ul>
<li><a href="#polymorphic-associations">Polymorphic Associations</a></li>
<li><a href="#models-with-composite-primary-keys">Models with Composite Primary Keys</a></li>
<li><a href="#self-joins">Self Joins</a></li>
</ul></li>
<li><a href="#single-table-inheritance-sti">Single Table Inheritance (STI)</a>

<ul>
<li><a href="#generating-the-base-vehicle-model">Generating the Base Vehicle Model</a></li>
<li><a href="#generating-child-models">Generating Child Models</a></li>
<li><a href="#creating-records">Creating Records</a></li>
<li><a href="#querying-records">Querying Records</a></li>
<li><a href="#adding-specific-behavior">Adding Specific Behavior</a></li>
<li><a href="#controllers">Controllers</a></li>
<li><a href="#overriding-the-inheritance-column">Overriding the inheritance column</a></li>
<li><a href="#disabling-the-inheritance-column">Disabling the inheritance column</a></li>
<li><a href="#considerations">Considerations</a></li>
</ul></li>
<li><a href="#delegated-types">Delegated Types</a>

<ul>
<li><a href="#setting-up-delegated-types">Setting up Delegated Types</a></li>
<li><a href="#generating-models">Generating Models</a></li>
<li><a href="#declaring-delegated-type">Declaring <code>delegated_type</code></a></li>
<li><a href="#defining-the-entryable-module">Defining the <code>Entryable</code> Module</a></li>
<li><a href="#object-creation">Object creation</a></li>
<li><a href="#adding-further-delegation">Adding further delegation</a></li>
</ul></li>
<li><a href="#tips-tricks-and-warnings">Tips, Tricks, and Warnings</a>

<ul>
<li><a href="#controlling-association-caching">Controlling Association Caching</a></li>
<li><a href="#avoiding-name-collisions">Avoiding Name Collisions</a></li>
<li><a href="#updating-the-schema">Updating the Schema</a></li>
<li><a href="#controlling-association-scope">Controlling Association Scope</a></li>
<li><a href="#bi-directional-associations">Bi-directional Associations</a></li>
</ul></li>
<li><a href="#association-references">Association References</a>

<ul>
<li><a href="#options">Options</a></li>
<li><a href="#scopes">Scopes</a></li>
<li><a href="#counter-cache">Counter Cache</a></li>
<li><a href="#callbacks">Callbacks</a></li>
<li><a href="#extensions">Extensions</a></li>
</ul></li>
</ol>

          </nav>


      <hr>
    </div>
  </section>

  <main id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h2 id="associations-overview"><a class="anchorlink" href="#associations-overview"><span>1</span> Associations Overview</a></h2><p>Active Record associations allow you to define relationships between models.
<em>Associations</em> are implemented as special macro style calls that make it easy to
tell Rails how your models relate to each other, which helps you manage your
data more effectively, and makes common operations simpler and easier to read.</p><div class="interstitial info"><p>A macro-style call is a method that generates or modifies other methods at
runtime, allowing for concise and expressive declarations of functionality, such
as defining model associations in Rails. For example, <code>has_many :comments</code>.</p></div><p>When you set up an association, Rails helps define and manage the <a href="https://en.wikipedia.org/wiki/Primary_key">Primary
Key</a> and <a href="https://en.wikipedia.org/wiki/Foreign_key">Foreign
Key</a> relationships between instances
of the two models, while the database ensures that your data stays consistent
and properly linked.</p><p>This makes it easy to keep track of which records are related. It also adds
useful methods to your models so you can work with related data more easily.</p><p>Consider a simple Rails application with models for authors and books.</p><h3 id="without-associations"><a class="anchorlink" href="#without-associations"><span>1.1</span> Without Associations</a></h3><p>Without associations, creating and deleting books for that author would require
a tedious and manual process. Here's what that would look like:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAuthors < ActiveRecord::Migration[8.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.references :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
end

class Book < ApplicationRecord
end
">Copy</button>
</div>
<p>To add a new book for an existing author, you'd need to provide the <code>author_id</code>
value when creating the book.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = Book.create(author_id: @author.id, published_at: Time.now)
">Copy</button>
</div>
<p>To delete an author and ensure all their books are also deleted, you need to
retrieve all the author's <code>books</code>, loop through each <code>book</code> to destroy it, and
then destroy the author.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = Book.where(author_id: @author.id)
@books.each do |book|
  book.destroy
end
@author.destroy
">Copy</button>
</div>
<h3 id="using-associations"><a class="anchorlink" href="#using-associations"><span>1.2</span> Using Associations</a></h3><p>However, with associations, we can streamline these operations, as well as
others, by explicitly informing Rails about the relationship between the two
models. Here's the revised code for setting up authors and books using
associations:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, dependent: :destroy
end

class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>With this change, creating a new book for a particular author is simpler:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now)
">Copy</button>
</div>
<p>Deleting an author and all of its books is much easier:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.destroy
">Copy</button>
</div>
<p>When you set up an association in Rails, you still need to create a
<a href="active_record_migrations.html">migration</a> to ensure that the database is
properly configured to handle the association. This migration will need to add
the necessary foreign key columns to your database tables.</p><p>For example, if you set up a <code>belongs_to :author</code> association in the <code>Book</code>
model, you would create a migration to add the <code>author_id</code> column to the <code>books</code>
table:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="go">rails generate migration AddAuthorToBooks author:references
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="">Copy</button>
</div>
<p>This migration will add the <code>author_id</code> column and set up the foreign key
relationship in the database, ensuring that your models and database stay in
sync.</p><p>To learn more about the different types of associations, you can read the next
section of this guide. Following that, you'll find some tips and tricks for
working with associations. Finally, there's a complete reference to the methods
and options for associations in Rails.</p><h2 id="types-of-associations"><a class="anchorlink" href="#types-of-associations"><span>2</span> Types of Associations</a></h2><p>Rails supports six types of associations, each with a particular use-case in
mind.</p><p>Here is a list of all of the supported types with a link to their API docs for
more detailed information on how to use them, their method parameters, etc.</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a></li>
</ul>
<p>In the remainder of this guide, you'll learn how to declare and use the various
forms of associations. First, let's take a quick look at the situations where
each association type is appropriate.</p><h3 id="belongs-to"><a class="anchorlink" href="#belongs-to"><span>2.1</span> <code>belongs_to</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> association sets up a relationship with another model, such
that each instance of the declaring model "belongs to" one instance of the other
model. For example, if your application includes authors and books, and each
book can be assigned to exactly one author, you'd declare the book model this
way:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p><img src="images/association_basics/belongs_to.png" alt="belongs_to Association Diagram"></p><div class="interstitial note"><p>A <code>belongs_to</code> association <em>must</em> use the singular term. If you use the
plural form, like <code>belongs_to :authors</code> in the <code>Book</code> model, and try to create a
book with <code>Book.create(authors: @author)</code>, Rails will give you an "uninitialized
constant Book::Authors" error. This happens because Rails automatically infers
the class name from the association name. If the association name is <code>:authors</code>,
Rails will look for a class named <code>Authors</code> instead of <code>Author</code>.</p></div><p>The corresponding migration might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks < ActiveRecord::Migration[8.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>In database terms, the <code>belongs_to</code> association says that this model's table
contains a column which represents a reference to another table. This can be
used to set up one-to-one or one-to-many relations, depending on the setup. If
the table <em>of the other class</em> contains the reference in a one-to-one relation,
then you should use <code>has_one</code> instead.</p><p>When used alone, <code>belongs_to</code> produces a one-directional one-to-one
relationship. Therefore each book in the above example "knows" its author, but
the authors don't know about their books. To setup a <a href="#bi-directional-associations">bi-directional
association</a> - use <code>belongs_to</code> in combination
with a <code>has_one</code> or <code>has_many</code> on the other model, in this case the Author
model.</p><div class="interstitial note"><p>By default <code>belongs_to</code> validates the presence of the associated record to
guarantee reference consistency.<br><br>If <code>optional</code> is set to true in the
model, then <code>belongs_to</code> does not guarantee reference consistency. This means
that the foreign key in one table might not reliably point to a valid primary
key in the referenced table.</p></div><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, optional: true
end
">Copy</button>
</div>
<p>Hence, depending on the use case, you might also need to add a database-level
foreign key constraint on the reference column, like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>This ensures that even though <code>optional: true</code> allows <code>author_id</code> to be NULL,
when it's not NULL, it must still reference a valid record in the authors table.</p><h4 id="methods-added-by-belongs-to"><a class="anchorlink" href="#methods-added-by-belongs-to"><span>2.1.1</span> Methods Added by <code>belongs_to</code></a></h4><p>When you declare a <code>belongs_to</code> association, the declaring class automatically
gains numerous methods related to the association. Some of these are:</p>
<ul>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>reset_association</code></li>
<li><code>association_changed?</code></li>
<li><code>association_previously_changed?</code></li>
</ul>
<p>We'll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to">ActiveRecord Associations
API</a>.</p><p>In all of the above methods, <code>association</code> is replaced with the symbol passed as
the first argument to <code>belongs_to</code>. For example, given the declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># app/models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="c1"># app/models/author.rb</span>
<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end

class Author < ApplicationRecord
  has_many :books
  validates :name, presence: true
end
">Copy</button>
</div>
<p>An instance of the <code>Book</code> model will have the following methods:</p>
<ul>
<li><code>author</code></li>
<li><code>author=</code></li>
<li><code>build_author</code></li>
<li><code>create_author</code></li>
<li><code>create_author!</code></li>
<li><code>reload_author</code></li>
<li><code>reset_author</code></li>
<li><code>author_changed?</code></li>
<li><code>author_previously_changed?</code></li>
</ul>
<div class="interstitial note"><p>When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use
the <code>build_</code> prefix to build the association, rather than the
<code>association.build</code> method that would be used for <code>has_many</code> or
<code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p></div><h5 id="methods-added-by-belongs-to-retrieving-the-association"><a class="anchorlink" href="#methods-added-by-belongs-to-retrieving-the-association"><span>2.1.1.1</span> Retrieving the association</a></h5><p>The <code>association</code> method returns the associated object, if any. If no associated
object is found, it returns <code>nil</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.author
">Copy</button>
</div>
<p>If the associated object has already been retrieved from the database for this
object, the cached version will be returned. To override this behavior (and
force a database read), call <code>#reload_association</code> on the parent object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.reload_author
">Copy</button>
</div>
<p>To unload the cached version of the associated object—causing the next access,
if any, to query it from the database—call <code>#reset_association</code> on the parent
object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">reset_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.reset_author
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-assigning-the-association"><a class="anchorlink" href="#methods-added-by-belongs-to-assigning-the-association"><span>2.1.1.2</span> Assigning the Association</a></h5><p>The <code>association=</code> method assigns an associated object to this object. Behind
the scenes, this means extracting the primary key from the associated object and
setting this object's foreign key to the same value.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author = @author
">Copy</button>
</div>
<p>The <code>build_association</code> method returns a new object of the associated type. This
object will be instantiated from the passed attributes, and the link through
this object's foreign key will be set, but the associated object will <em>not</em> yet
be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.build_author(author_number: 123,
                             author_name: &quot;John Doe&quot;)
">Copy</button>
</div>
<p>The <code>create_association</code> method takes it a step further and also saves the
associated object once it passes all of the validations specified on the
associated model.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.create_author(author_number: 123,
                              author_name: &quot;John Doe&quot;)
">Copy</button>
</div>
<p>Finally, <code>create_association!</code> does the same, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># This will raise ActiveRecord::RecordInvalid because the name is blank</span>
<span class="k">begin</span>
  <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author!</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">""</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# This will raise ActiveRecord::RecordInvalid because the name is blank
begin
  @book.create_author!(author_number: 123, name: &quot;&quot;)
rescue ActiveRecord::RecordInvalid => e
  puts e.message
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="ss">raise_validation_error: </span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Name</span> <span class="n">can</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">blank</span> <span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="raise_validation_error: Validation failed: Name can't be blank (ActiveRecord::RecordInvalid)
">Copy</button>
</div>
<h5 id="checking-for-association-changes"><a class="anchorlink" href="#checking-for-association-changes"><span>2.1.1.3</span> Checking for Association Changes</a></h5><p>The <code>association_changed?</code> method returns true if a new associated object has
been assigned and the foreign key will be updated in the next save.</p><p>The <code>association_previously_changed?</code> method returns true if the previous save
updated the association to reference a new associate object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author # => #<Author author_number: 123, author_name: &quot;John Doe&quot;>
@book.author_changed? # => false
@book.author_previously_changed? # => false

@book.author = Author.second # => #<Author author_number: 456, author_name: &quot;Jane Smith&quot;>
@book.author_changed? # => true

@book.save!
@book.author_changed? # => false
@book.author_previously_changed? # => true
">Copy</button>
</div>
<div class="interstitial note"><p>Do not confuse <code>model.association_changed?</code> with
<code>model.association.changed?</code>. The former checks if the association has been
replaced with a new record, while the latter tracks changes to the attributes of
the association.</p></div><h5 id="methods-added-by-belongs-to-checking-for-existing-associations"><a class="anchorlink" href="#methods-added-by-belongs-to-checking-for-existing-associations"><span>2.1.1.4</span> Checking for Existing Associations</a></h5><p>You can see if any associated objects exist by using the <code>association.nil?</code>
method:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="if @book.author.nil?
  @msg = &quot;No author found for this book&quot;
end
">Copy</button>
</div>
<h5 id="methods-added-by-belongs-to-saving-behavior-of-associated-objects"><a class="anchorlink" href="#methods-added-by-belongs-to-saving-behavior-of-associated-objects"><span>2.1.1.5</span> Saving Behavior of Associated Objects</a></h5><p>Assigning an object to a <code>belongs_to</code> association does <em>not</em> automatically save
either the current object or the associated object. However, when you save the
current object, the association is saved as well.</p><h3 id="has-one"><a class="anchorlink" href="#has-one"><span>2.2</span> <code>has_one</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> association indicates that one other model has a reference to
this model. That model can be fetched through this association.</p><p>For example, if each supplier in your application has only one account, you'd
declare the supplier model like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>The main difference from <code>belongs_to</code> is that the link column (in this case
<code>supplier_id</code>) is located in the other table, not the table where the <code>has_one</code>
is declared.</p><p><img src="images/association_basics/has_one.png" alt="has_one Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers < ActiveRecord::Migration[8.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>The <code>has_one</code> association creates a one-to-one match with another model. In
database terms, this association says that the other class contains the foreign
key. If this class contains the foreign key, then you should use <code>belongs_to</code>
instead.</p><p>Depending on the use case, you might also need to create a unique index and/or a
foreign key constraint on the supplier column for the accounts table. The unique
index ensures that each supplier is associated with only one account and allows
you to query in an efficient manner, while the foreign key constraint ensures
that the <code>supplier_id</code> in the <code>accounts</code> table refers to a valid <code>supplier</code> in
the <code>suppliers</code> table. This enforces the association at the database level.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :accounts do |t|
  t.belongs_to :supplier, index: { unique: true }, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>This relation can be <a href="#bi-directional-associations">bi-directional</a> when used in
combination with <code>belongs_to</code> on the other model.</p><h4 id="methods-added-by-has-one"><a class="anchorlink" href="#methods-added-by-has-one"><span>2.2.1</span> Methods Added by </a><a href="#has-one"><code>has_one</code></a></h4><p>When you declare a <code>has_one</code> association,  the declaring class automatically
gains numerous methods related to the association. Some of these are:</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>reset_association</code></li>
</ul>
<p>We'll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one">ActiveRecord Associations
API</a>.</p><p>Like with the <a href="#methods-added-by-belongs-to"><code>belongs_to</code> references</a>, in all of
these methods, <code>association</code> is replaced with the symbol passed as the first
argument to <code>has_one</code>. For example, given the declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># app/models/supplier.rb</span>
<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="c1"># app/models/account.rb</span>
<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end

class Account < ApplicationRecord
  validates :terms, presence: true
  belongs_to :supplier
end
">Copy</button>
</div>
<p>Each instance of the <code>Supplier</code> model will have these methods:</p>
<ul>
<li><code>account</code></li>
<li><code>account=</code></li>
<li><code>build_account</code></li>
<li><code>create_account</code></li>
<li><code>create_account!</code></li>
<li><code>reload_account</code></li>
<li><code>reset_account</code></li>
</ul>
<div class="interstitial note"><p>When initializing a new <code>has_one</code> or <code>belongs_to</code> association you must use
the <code>build_</code> prefix to build the association, rather than the
<code>association.build</code> method that would be used for <code>has_many</code> or
<code>has_and_belongs_to_many</code> associations. To create one, use the <code>create_</code> prefix.</p></div><h5 id="methods-added-by-has-one-retrieving-the-association"><a class="anchorlink" href="#methods-added-by-has-one-retrieving-the-association"><span>2.2.1.1</span> Retrieving the association</a></h5><p>The <code>association</code> method returns the associated object, if any. If no associated
object is found, it returns <code>nil</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.account
">Copy</button>
</div>
<p>If the associated object has already been retrieved from the database for this
object, the cached version will be returned. To override this behavior (and
force a database read), call <code>#reload_association</code> on the parent object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.reload_account
">Copy</button>
</div>
<p>To unload the cached version of the associated object—forcing the next access,
if any, to query it from the database—call <code>#reset_association</code> on the parent
object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">reset_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.reset_account
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-assigning-the-association"><a class="anchorlink" href="#methods-added-by-has-one-assigning-the-association"><span>2.2.1.2</span> Assigning the Association</a></h5><p>The <code>association=</code> method assigns an associated object to this object. Behind
the scenes, this means extracting the primary key from this object and setting
the associated object's foreign key to the same value.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.account = @account
">Copy</button>
</div>
<p>The <code>build_association</code> method returns a new object of the associated type. This
object will be instantiated from the passed attributes, and the link through
this objects foreign key will be set, but the associated object will <em>not</em> yet
be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.build_account(terms: &quot;Net 30&quot;)
">Copy</button>
</div>
<p>The <code>create_association</code> method takes it a step further and also saves the
associated object once it passes all of the validations specified on the
associated model.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.create_account(terms: &quot;Net 30&quot;)
">Copy</button>
</div>
<p>Finally, <code>create_association!</code> does the same, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><p><code>create_association!</code> does the same as <code>create_association</code> above, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># This will raise ActiveRecord::RecordInvalid because the terms is blank</span>
<span class="k">begin</span>
  <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account!</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">""</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# This will raise ActiveRecord::RecordInvalid because the terms is blank
begin
  @supplier.create_account!(terms: &quot;&quot;)
rescue ActiveRecord::RecordInvalid => e
  puts e.message
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="ss">raise_validation_error: </span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Terms</span> <span class="n">can</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">blank</span> <span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="raise_validation_error: Validation failed: Terms can't be blank (ActiveRecord::RecordInvalid)
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-checking-for-existing-associations"><a class="anchorlink" href="#methods-added-by-has-one-checking-for-existing-associations"><span>2.2.1.3</span> Checking for Existing Associations</a></h5><p>You can see if any associated objects exist by using the <code>association.nil?</code>
method:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="if @supplier.account.nil?
  @msg = &quot;No account found for this supplier&quot;
end
">Copy</button>
</div>
<h5 id="methods-added-by-has-one-saving-behavior-of-associated-objects"><a class="anchorlink" href="#methods-added-by-has-one-saving-behavior-of-associated-objects"><span>2.2.1.4</span> Saving Behavior of Associated Objects</a></h5><p>When you assign an object to a <code>has_one</code> association, that object is
automatically saved to update its foreign key. Additionally, any object being
replaced is also automatically saved, as its foreign key will change too.</p><p>If either of these saves fails due to validation errors, the assignment
statement returns <code>false</code>, and the assignment itself is canceled.</p><p>If the parent object (the one declaring the <code>has_one</code> association) is unsaved
(that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved
immediately. They will be automatically saved when the parent object is saved.</p><p>If you want to assign an object to a <code>has_one</code> association without saving the
object, use the <code>build_association</code> method. This method creates a new, unsaved
instance of the associated object, allowing you to work with it before deciding
to save it.</p><p>Use <code>autosave: false</code> when you want to control the saving behavior of the
associated objects for the model. This setting prevents the associated object
from being saved automatically when the parent object is saved. In contrast, use
<code>build_association</code> when you need to work with an unsaved associated object and
delay its persistence until you're ready.</p><h3 id="has-many"><a class="anchorlink" href="#has-many"><span>2.3</span> <code>has_many</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> association is similar to <code>has_one</code>, but indicates a
one-to-many relationship with another model. You'll often find this association
on the "other side" of a <code>belongs_to</code> association. This association indicates
that each instance of the model has zero or more instances of another model. For
example, in an application containing authors and books, the author model could
be declared like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p><code>has_many</code> establishes a one-to-many relationship between models, allowing each
instance of the declaring model (<code>Author</code>) to have multiple instances of the
associated model (<code>Book</code>).</p><div class="interstitial note"><p>Unlike a <code>has_one</code> and <code>belongs_to</code> association, the name of the other
model is pluralized when declaring a <code>has_many</code> association.</p></div><p><img src="images/association_basics/has_many.png" alt="has_many Association Diagram"></p><p>The corresponding migration might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAuthors < ActiveRecord::Migration[8.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>The <code>has_many</code> association creates a one-to-many relationship with another
model. In database terms, this association says that the other class will have a
foreign key that refers to instances of this class.</p><p>In this migration, the <code>authors</code> table is created with a <code>name</code> column to store
the names of authors. The <code>books</code> table is also created, and it includes a
<code>belongs_to :author</code> association. This association establishes a foreign key
relationship between the <code>books</code> and <code>authors</code> tables. Specifically, the
<code>author_id</code> column in the <code>books</code> table acts as a foreign key, referencing the
<code>id</code> column in the <code>authors</code> table. By including this <code>belongs_to :author</code>
association in the <code>books</code> table, we ensure that each book is associated with a
single author, enabling a <code>has_many</code> association from the <code>Author</code> model. This
setup allows each author to have multiple associated books.</p><p>Depending on the use case, it's usually a good idea to create a non-unique index
and optionally a foreign key constraint on the author column for the books
table. Adding an index on the <code>author_id</code> column improves query performance when
retrieving books associated with a specific author.</p><p>If you wish to enforce <a href="https://en.wikipedia.org/wiki/Referential_integrity">referential
integrity</a> at the database
level, add the <a href="active_record_migrations.html#foreign-keys"><code>foreign_key: true</code></a>
option to the <code>reference</code> column declarations above. This will ensure that the
<code>author_id</code> in the books table must correspond to a valid <code>id</code> in the <code>authors</code>
table,</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, index: true, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>This relation can be <a href="#bi-directional-associations">bi-directional</a> when used in
combination with <code>belongs_to</code> on the other model.</p><h4 id="methods-added-by-has-many"><a class="anchorlink" href="#methods-added-by-has-many"><span>2.3.1</span> Methods Added by <code>has_many</code></a></h4><p>When you declare a <code>has_many</code> association, the declaring class gains numerous
methods related to the association. Some of these are:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>We'll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many">ActiveRecord Associations
API</a>.</p><p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the
first argument to <code>has_many</code>, and <code>collection_singular</code> is replaced with the
singularized version of that symbol. For example, given the declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>An instance of the <code>Author</code> model can have the following methods:</p><div class="interstitial code">
<pre><code class="highlight plaintext">books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
</code></pre>
<button class="clipboard-button" data-clipboard-text="books
books<<(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-managing-the-collection"><a class="anchorlink" href="#methods-added-by-has-many-managing-the-collection"><span>2.3.1.1</span> Managing the Collection</a></h5><p>The <code>collection</code> method returns a Relation of all of the associated objects. If
there are no associated objects, it returns an empty Relation.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> method removes one or more objects from the
collection by setting their foreign keys to <code>NULL</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.delete(@book1)
">Copy</button>
</div>
<div class="interstitial warning"><p>Additionally, objects will be destroyed if they're associated with
<code>dependent: :destroy</code>, and deleted if they're associated with <code>dependent:
:delete_all</code>.</p></div><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> method removes one or more objects from the
collection by running <code>destroy</code> on each object.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.destroy(@book1)
">Copy</button>
</div>
<div class="interstitial warning"><p>Objects will <em>always</em> be removed from the database, ignoring the
<code>:dependent</code> option.</p></div><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> method removes all objects from the collection
according to the strategy specified by the <code>dependent</code> option. If no option is
given, it follows the default strategy. The default strategy for <code>has_many
:through</code> associations is <code>delete_all</code>, and for <code>has_many</code> associations is to
set the foreign keys to <code>NULL</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.clear
">Copy</button>
</div>
<div class="interstitial warning"><p>Objects will be deleted if they're associated with <code>dependent:
:destroy</code> or <code>dependent: :destroy_async</code>, just like <code>dependent: :delete_all</code>.</p></div><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> method returns a Relation of all of the associated
objects, forcing a database read. If there are no associated objects, it returns
an empty Relation.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books.reload
">Copy</button>
</div>
<h5 id="methods-added-by-has-many-assigning-the-collection"><a class="anchorlink" href="#methods-added-by-has-many-assigning-the-collection"><span>2.3.1.2</span> Assigning the Collection</a></h5><p>The <code>collection=(objects)</code> method makes the collection contain only the supplied
objects, by adding and deleting as appropriate. The changes are persisted to the
database.</p><p>The <code>collection_singular_ids=(ids)</code> method makes the collection contain only the
objects identified by the supplied primary key values, by adding and deleting as
appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-many-querying-the-collection"><a class="anchorlink" href="#methods-added-by-has-many-querying-the-collection"><span>2.3.1.3</span> Querying the Collection</a></h5><p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects
in the collection.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_ids = @author.book_ids
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> method returns <code>true</code> if the collection does not
contain any associated objects.</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<% if @author.books.empty? %>
  No Books Found
<% end %>
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> method returns the number of objects in the
collection.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_count = @author.books.size
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> method finds objects within the collection's table.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_book = @author.books.find(1)
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> method finds objects within the collection based on
the conditions supplied but the objects are loaded lazily meaning that the
database is queried only when the object(s) are accessed.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_books = @author.books.where(available: true) # No query yet
@available_book = @available_books.first # Now the database will be queried
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> method checks whether an object meeting the
supplied conditions exists in the collection's table.</p><h5 id="methods-added-by-has-many-building-and-creating-associated-objects"><a class="anchorlink" href="#methods-added-by-has-many-building-and-creating-associated-objects"><span>2.3.1.4</span> Building and Creating Associated Objects</a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> method returns a single or array of new objects of
the associated type. The object(s) will be instantiated from the passed
attributes, and the link through their foreign key will be created, but the
associated objects will <em>not</em> yet be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.build(published_at: Time.now,
                            book_number: &quot;A12345&quot;)

@books = @author.books.build([
  { published_at: Time.now, book_number: &quot;A12346&quot; },
  { published_at: Time.now, book_number: &quot;A12347&quot; }
])
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> method returns a single or array of new objects of
the associated type. The object(s) will be instantiated from the passed
attributes, the link through its foreign key will be created, and, once it
passes all of the validations specified on the associated model, the associated
object <em>will</em> be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now,
                             book_number: &quot;A12345&quot;)

@books = @author.books.create([
  { published_at: Time.now, book_number: &quot;A12346&quot; },
  { published_at: Time.now, book_number: &quot;A12347&quot; }
])
">Copy</button>
</div>
<p><code>collection.create!</code> does the same as <code>collection.create</code>, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p><h5 id="methods-added-by-has-many-when-are-objects-saved-questionmark"><a class="anchorlink" href="#methods-added-by-has-many-when-are-objects-saved-questionmark"><span>2.3.1.5</span> When are Objects Saved?</a></h5><p>When you assign an object to a <code>has_many</code> association, that object is
automatically saved (in order to update its foreign key). If you assign multiple
objects in one statement, then they are all saved.</p><p>If any of these saves fails due to validation errors, then the assignment
statement returns <code>false</code> and the assignment itself is cancelled.</p><p>If the parent object (the one declaring the <code>has_many</code> association) is unsaved
(that is, <code>new_record?</code> returns <code>true</code>) then the child objects are not saved
when they are added. All unsaved members of the association will automatically
be saved when the parent is saved.</p><p>If you want to assign an object to a <code>has_many</code> association without saving the
object, use the <code>collection.build</code> method.</p><h3 id="has-many-through"><a class="anchorlink" href="#has-many-through"><span>2.4</span> <code>has_many :through</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a> association is often used to set up a
many-to-many relationship with another model. This association indicates that
the declaring model can be matched with zero or more instances of another model
by proceeding <em>through</em> a third model.</p><p>For example, consider a medical practice where patients make appointments to see
physicians. The relevant association declarations could look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Physician < ApplicationRecord
  has_many :appointments
  has_many :patients, through: :appointments
end

class Appointment < ApplicationRecord
  belongs_to :physician
  belongs_to :patient
end

class Patient < ApplicationRecord
  has_many :appointments
  has_many :physicians, through: :appointments
end
">Copy</button>
</div>
<p><code>has_many :through</code> establishes a many-to-many relationship between models,
allowing instances of one model (Physician) to be associated with multiple
instances of another model (Patient) through a third "join" model (Appointment).</p><p><img src="images/association_basics/has_many_through.png" alt="has_many :through Association
Diagram"></p><p>The corresponding migration might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments < ActiveRecord::Migration[8.0]
  def change
    create_table :physicians do |t|
      t.string :name
      t.timestamps
    end

    create_table :patients do |t|
      t.string :name
      t.timestamps
    end

    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>In this migration the <code>physicians</code> and <code>patients</code> tables are created with a
<code>name</code> column. The <code>appointments</code> table, which acts as the join table, is
created with <code>physician_id</code> and <code>patient_id</code> columns, establishing the
many-to-many relationship between <code>physicians</code> and <code>patients</code>.</p><p>You could also consider using a <a href="active_record_composite_primary_keys.html">composite primary
key</a> for the join table in the
<code>has_many :through</code> relationship like below:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="c1">#  ...</span>
    <span class="n">create_table</span> <span class="ss">:appointments</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="p">[</span><span class="ss">:physician_id</span><span class="p">,</span> <span class="ss">:patient_id</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments < ActiveRecord::Migration[8.0]
  def change
    #  ...
    create_table :appointments, primary_key: [:physician_id, :patient_id] do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>The collection of join models in a <code>has_many :through</code> association can be
managed using standard <a href="#methods-added-by-has-many"><code>has_many</code> association
methods</a>. For example, if you assign a list of
patients to a physician like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="physician.patients = patients
">Copy</button>
</div>
<p>Rails will automatically create new join models for any patients in the new list
that were not previously associated with the physician. Additionally, if any
patients that were previously associated with the physician are not included in
the new list, their join records will be automatically deleted. This simplifies
managing many-to-many relationships by handling the creation and deletion of the
join models for you.</p><div class="interstitial warning"><p>Automatic deletion of join models is direct, no destroy callbacks are
triggered. You can read more about callbacks in the <a href="active_record_callbacks.html">Active Record Callbacks
Guide</a>.</p></div><p>The <code>has_many :through</code> association is also useful for setting up "shortcuts"
through nested <code>has_many</code> associations. This is particularly beneficial when you
need to access a collection of related records through an intermediary
association.</p><p>For example, if a document has many sections, and each section has many
paragraphs, you may sometimes want to get a simple collection of all paragraphs
in the document without having to manually traverse through each section.</p><p>You can set this up with a <code>has_many :through</code> association as follows:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Document < ApplicationRecord
  has_many :sections
  has_many :paragraphs, through: :sections
end

class Section < ApplicationRecord
  belongs_to :document
  has_many :paragraphs
end

class Paragraph < ApplicationRecord
  belongs_to :section
end
">Copy</button>
</div>
<p>With <code>through: :sections</code> specified, Rails will now understand:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@document.paragraphs
">Copy</button>
</div>
<p>Whereas, if you had not set up a <code>has_many :through</code> association, you would have
needed to do something like this to get paragraphs in a document:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="vi">@document</span><span class="p">.</span><span class="nf">sections</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">section</span><span class="o">|</span>
  <span class="n">paragraphs</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="nf">paragraphs</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="paragraphs = []
@document.sections.each do |section|
  paragraphs.concat(section.paragraphs)
end
">Copy</button>
</div>
<h3 id="has-one-through"><a class="anchorlink" href="#has-one-through"><span>2.5</span> <code>has_one :through</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a> association sets up a one-to-one relationship
with another model through an intermediary model. This association indicates
that the declaring model can be matched with one instance of another model by
proceeding <em>through</em> a third model.</p><p>For example, if each supplier has one account, and each account is associated
with one account history, then the supplier model could look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
  has_one :account_history, through: :account
end

class Account < ApplicationRecord
  belongs_to :supplier
  has_one :account_history
end

class AccountHistory < ApplicationRecord
  belongs_to :account
end
">Copy</button>
</div>
<p>This setup allows a <code>supplier</code> to directly access its <code>account_history</code> through
its <code>account</code>.</p><p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association
Diagram"></p><p>The corresponding migration to set up these associations might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAccountHistories < ActiveRecord::Migration[8.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end

    create_table :account_histories do |t|
      t.belongs_to :account
      t.integer :credit_rating
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h3 id="has-and-belongs-to-many"><a class="anchorlink" href="#has-and-belongs-to-many"><span>2.6</span> <code>has_and_belongs_to_many</code></a></h3><p>A <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> association creates a direct many-to-many
relationship with another model, with no intervening model. This association
indicates that each instance of the declaring model refers to zero or more
instances of another model.</p><p>For example, consider an application with <code>Assembly</code> and <code>Part</code> models, where
each assembly can contain many parts, and each part can be used in many
assemblies. You can set up the models as follows:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association
Diagram"></p><p>Even though a <code>has_and_belongs_to_many</code> does not require an intervening model,
it does require a separate table to establish the many-to-many relationship
between the two models involved. This intervening table serves to store the
related data, mapping the associations between instances of the two models. The
table does not necessarily need a primary key since its purpose is solely to
manage the relationship between the associated records. The corresponding
migration might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="c1"># Create a join table to establish the many-to-many relationship between assemblies and parts.</span>
    <span class="c1"># `id: false` indicates that the table does not need a primary key of its own</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># creates foreign keys linking the join table to the `assemblies` and `parts` tables</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesAndParts < ActiveRecord::Migration[8.0]
  def change
    create_table :assemblies do |t|
      t.string :name
      t.timestamps
    end

    create_table :parts do |t|
      t.string :part_number
      t.timestamps
    end

    # Create a join table to establish the many-to-many relationship between assemblies and parts.
    # `id: false` indicates that the table does not need a primary key of its own
    create_table :assemblies_parts, id: false do |t|
      # creates foreign keys linking the join table to the `assemblies` and `parts` tables
      t.belongs_to :assembly
      t.belongs_to :part
    end
  end
end
">Copy</button>
</div>
<p>The <code>has_and_belongs_to_many</code> association creates a many-to-many relationship
with another model. In database terms, this associates two classes via an
intermediate join table that includes foreign keys referring to each of the
classes.</p><p>If the join table for a <code>has_and_belongs_to_many</code> association has additional
columns beyond the two foreign keys, these columns will be added as attributes
to records retrieved via that association. Records returned with additional
attributes will always be read-only, because Rails cannot save changes to those
attributes.</p><div class="interstitial warning"><p>The use of extra attributes on the join table in a
<code>has_and_belongs_to_many</code> association is deprecated. If you require this sort of
complex behavior on the table that joins two models in a many-to-many
relationship, you should use a <code>has_many :through</code> association instead of
<code>has_and_belongs_to_many</code>.</p></div><h4 id="methods-added-by-has-and-belongs-to-many"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many"><span>2.6.1</span> Methods Added by <code>has_and_belongs_to_many</code></a></h4><p>When you declare a <code>has_and_belongs_to_many</code> association, the declaring class
gains numerous methods related to the association. Some of these are:</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>We'll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many">ActiveRecord Associations
API</a>.</p><p>In all of these methods, <code>collection</code> is replaced with the symbol passed as the
first argument to <code>has_and_belongs_to_many</code>, and <code>collection_singular</code> is
replaced with the singularized version of that symbol. For example, given the
declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>An instance of the <code>Part</code> model can have the following methods:</p><div class="interstitial code">
<pre><code class="highlight plaintext">assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
</code></pre>
<button class="clipboard-button" data-clipboard-text="assemblies
assemblies<<(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-managing-the-collection"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-managing-the-collection"><span>2.6.1.1</span> Managing the Collection</a></h5><p>The <code>collection</code> method returns a Relation of all of the associated objects. If
there are no associated objects, it returns an empty Relation.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> method adds one or more objects to the collection by
creating records in the join table.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies << @assembly1
">Copy</button>
</div>
<div class="interstitial note"><p>This method is aliased as <code>collection.concat</code> and <code>collection.push</code>.</p></div><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> method removes one or more objects from the
collection by deleting records in the join table. This does not destroy the
objects.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.delete(@assembly1)
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> method removes one or more objects from the
collection by deleting records in the join table. This does not destroy the
objects.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.destroy(@assembly1)
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> method removes every object from the collection by
deleting the rows from the joining table. This does not destroy the associated
objects.</p><h5 id="methods-added-by-has-and-belongs-to-many-assigning-the-collection"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-assigning-the-collection"><span>2.6.1.2</span> Assigning the Collection</a></h5><p>The <code>collection=</code> method makes the collection contain only the supplied objects,
by adding and deleting as appropriate. The changes are persisted to the
database.</p><p>The <code>collection_singular_ids=</code> method makes the collection contain only the
objects identified by the supplied primary key values, by adding and deleting as
appropriate. The changes are persisted to the database.</p><h5 id="methods-added-by-has-and-belongs-to-many-querying-the-collection"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-querying-the-collection"><span>2.6.1.3</span> Querying the Collection</a></h5><p>The <code>collection_singular_ids</code> method returns an array of the ids of the objects
in the collection.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_ids = @part.assembly_ids
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> method returns <code>true</code> if the collection does not
contain any associated objects.</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  This part is not used in any assemblies
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<% if @part.assemblies.empty? %>
  This part is not used in any assemblies
<% end %>
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> method returns the number of objects in the
collection.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_count = @part.assemblies.size
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> method finds objects within the collection's table.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.find(1)
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> method finds objects within the collection based on
the conditions supplied but the objects are loaded lazily meaning that the
database is queried only when the object(s) are accessed.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@new_assemblies = @part.assemblies.where(&quot;created_at > ?&quot;, 2.days.ago)
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> method checks whether an object meeting the
supplied conditions exists in the collection's table.</p><h5 id="methods-added-by-has-and-belongs-to-many-building-and-creating-associated-objects"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-building-and-creating-associated-objects"><span>2.6.1.4</span> Building and Creating Associated Objects</a></h5><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> method returns a new object of the associated type.
This object will be instantiated from the passed attributes, and the link
through the join table will be created, but the associated object will <em>not</em> yet
be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.build({ assembly_name: &quot;Transmission housing&quot; })
">Copy</button>
</div>
<p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> method returns a new object of the associated type.
This object will be instantiated from the passed attributes, the link through
the join table will be created, and, once it passes all of the validations
specified on the associated model, the associated object <em>will</em> be saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.create({ assembly_name: &quot;Transmission housing&quot; })
">Copy</button>
</div>
<p>Does the same as <code>collection.create</code>, but raises <code>ActiveRecord::RecordInvalid</code>
if the record is invalid.</p><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> method returns a Relation of all of the associated
objects, forcing a database read. If there are no associated objects, it returns
an empty Relation.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies.reload
">Copy</button>
</div>
<h5 id="methods-added-by-has-and-belongs-to-many-when-are-objects-saved-questionmark"><a class="anchorlink" href="#methods-added-by-has-and-belongs-to-many-when-are-objects-saved-questionmark"><span>2.6.1.5</span> When are Objects Saved?</a></h5><p>When you assign an object to a <code>has_and_belongs_to_many</code> association, that
object is automatically saved (in order to update the join table). If you assign
multiple objects in one statement, then they are all saved.</p><p>If any of these saves fails due to validation errors, then the assignment
statement returns <code>false</code> and the assignment itself is cancelled.</p><p>If the parent object (the one declaring the <code>has_and_belongs_to_many</code>
association) is unsaved (that is, <code>new_record?</code> returns <code>true</code>) then the child
objects are not saved when they are added. All unsaved members of the
association will automatically be saved when the parent is saved.</p><p>If you want to assign an object to a <code>has_and_belongs_to_many</code> association
without saving the object, use the <code>collection.build</code> method.</p><h2 id="choosing-an-association"><a class="anchorlink" href="#choosing-an-association"><span>3</span> Choosing an Association</a></h2><h3 id="belongs-to-vs-has-one"><a class="anchorlink" href="#belongs-to-vs-has-one"><span>3.1</span> <code>belongs_to</code> vs <code>has_one</code></a></h3><p>If you want to set up a one-to-one relationship between two models, you can
choose between a <code>belongs_to</code> and a <code>has_one</code> association. How do you know which
one to choose?</p><p>The distinction lies in the placement of the foreign key, which goes on the
table of the class declaring the <code>belongs_to</code> association. However, it’s
essential to understand the semantics to determine the correct associations:</p>
<ul>
<li><code>belongs_to</code>: This association indicates that the current model contains the
foreign key and is a child in the relationship. It references another model,
implying that each instance of this model is linked to one instance of the
other model.</li>
<li><code>has_one</code>: This association indicates that the current model is the parent in
the relationship, and it owns one instance of the other model.</li>
</ul>
<p>For example, consider a scenario with suppliers and their accounts. It makes
more sense to say that a supplier has/owns an account (where the supplier is the
parent) rather than an account has/owns a supplier. Therefore, the correct
associations would be:</p>
<ul>
<li>A supplier has one account.</li>
<li>An account belongs to one supplier.</li>
</ul>
<p>Here is how you can define these associations in Rails:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end

class Account < ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>To implement these associations, you'll need to create the corresponding
database tables and set up the foreign key. Here's an example migration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers < ActiveRecord::Migration[8.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier_id
      t.string :account_number
      t.timestamps
    end

    add_index :accounts, :supplier_id
  end
end
">Copy</button>
</div>
<p>Remember that the foreign key goes on the table of the class declaring the
belongs_to association. In this case the <code>account</code> table.</p><h3 id="has-many-through-vs-has-and-belongs-to-many"><a class="anchorlink" href="#has-many-through-vs-has-and-belongs-to-many"><span>3.2</span> <code>has_many :through</code> vs <code>has_and_belongs_to_many</code></a></h3><p>Rails offers two different ways to declare a many-to-many relationship between
models: <code>has_many :through</code> and <code>has_and_belongs_to_many</code>. Understanding the
differences and use cases for each can help you choose the best approach for
your application's needs.</p><p>The <code>has_many :through</code> association sets up a many-to-many relationship through
an intermediary model (also known as a join model). This approach is more
flexible and allows you to add validations, callbacks, and extra attributes to
the join model. The join table needs a <code>primary_key</code> (or a <a href="active_record_composite_primary_keys.html">composite primary
key</a>).</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_many :manifests
  has_many :parts, through: :manifests
end

class Manifest < ApplicationRecord
  belongs_to :assembly
  belongs_to :part
end

class Part < ApplicationRecord
  has_many :manifests
  has_many :assemblies, through: :manifests
end
">Copy</button>
</div>
<p>You'd use <code>has_many :through</code> when:</p>
<ul>
<li>You need to add extra attributes or methods to the join table.</li>
<li>You require <a href="active_record_validations.html">validations</a> or
<a href="active_record_callbacks.html">callbacks</a> on the join model.</li>
<li>The join table should be treated as an independent entity with its own
behavior.</li>
</ul>
<p>The <code>has_and_belongs_to_many</code> association allows you to create a many-to-many
relationship directly between two models without needing an intermediary model.
This method is straightforward and is suitable for simple associations where no
additional attributes or behaviors are required on the join table. For
<code>has_and_belongs_to_many</code> associations, you'll need to create a join table
without a primary key.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>You'd use <code>has_and_belongs_to_many</code> when:</p>
<ul>
<li>The association is simple and does not require additional attributes or
behaviors on the join table.</li>
<li>You do not need validations, callbacks, or extra methods on the join table.</li>
</ul>
<h2 id="advanced-associations"><a class="anchorlink" href="#advanced-associations"><span>4</span> Advanced Associations</a></h2><h3 id="polymorphic-associations"><a class="anchorlink" href="#polymorphic-associations"><span>4.1</span> Polymorphic Associations</a></h3><p>A slightly more advanced twist on associations is the <em>polymorphic association</em>.
Polymorphic associations in Rails allow a model to belong to multiple other
models through a single association. This can be particularly useful when you
have a model that needs to be linked to different types of models.</p><p>For instance, imagine you have a <code>Picture</code> model that can belong to <strong>either</strong>
an <code>Employee</code> or a <code>Product</code>, because each of these can have a profile picture.
Here's how this could be declared:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Picture < ApplicationRecord
  belongs_to :imageable, polymorphic: true
end

class Employee < ApplicationRecord
  has_many :pictures, as: :imageable
end

class Product < ApplicationRecord
  has_many :pictures, as: :imageable
end
">Copy</button>
</div>
<p><img src="images/association_basics/polymorphic.png" alt="Polymorphic Association Diagram"></p><p>In the context above, <code>imageable</code> is a name chosen for the association. It's a
symbolic name that represents the polymorphic association between the <code>Picture</code>
model and other models such as <code>Employee</code> and <code>Product</code>. The important thing is
to use the same name (<code>imageable</code>) consistently across all associated models to
establish the polymorphic association correctly.</p><p>When you declare <code>belongs_to :imageable, polymorphic: true</code> in the <code>Picture</code>
model, you're saying that a <code>Picture</code> can belong to any model (like <code>Employee</code>
or <code>Product</code>) through this association.</p><p>You can think of a polymorphic <code>belongs_to</code> declaration as setting up an
interface that any other model can use. This allows you to retrieve a collection
of pictures from an instance of the <code>Employee</code> model using <code>@employee.pictures</code>.
Similarly, you can retrieve a collection of pictures from an instance of the
<code>Product</code> model using <code>@product.pictures</code>.</p><p>Additionally, if you have an instance of the <code>Picture</code> model, you can get its
parent via <code>@picture.imageable</code>, which could be an <code>Employee</code> or a <code>Product</code>.</p><p>To setup a polymorphic association manually you would need to declare both a
foreign key column (<code>imageable_id</code>) and a type column (<code>imageable_type</code>) in the
model:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures < ActiveRecord::Migration[8.0]
  def change
    create_table :pictures do |t|
      t.string  :name
      t.bigint  :imageable_id
      t.string  :imageable_type
      t.timestamps
    end

    add_index :pictures, [:imageable_type, :imageable_id]
  end
end
">Copy</button>
</div>
<p>In our example, <code>imageable_id</code> could be the ID of either an <code>Employee</code> or a
<code>Product</code>, and <code>imageable_type</code> is the name of the associated model's class, so
either <code>Employee</code> or <code>Product</code>.</p><p>While creating the polymorphic association manually is acceptable, it is instead
recommended to use <code>t.references</code> or its alias <code>t.belong_to</code> and specify
<code>polymorphic: true</code> so that Rails knows that the association is polymorphic, and
it automatically adds both the foreign key and type columns to the table.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures < ActiveRecord::Migration[8.0]
  def change
    create_table :pictures do |t|
      t.string :name
      t.belongs_to :imageable, polymorphic: true
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<div class="interstitial warning"><p>Since polymorphic associations rely on storing class names in the
database, that data must remain synchronized with the class name used by the
Ruby code. When renaming a class, make sure to update the data in the
polymorphic type column.</p></div><p>For example, if you change the class name from <code>Product</code> to <code>Item</code> then you'd
need to run a migration script to update the <code>imageable_type</code> column in the
<code>pictures</code> table (or whichever table is affected) with the new class name.
Additionally, you'll need to update any other references to the class name
throughout your application code to reflect the change.</p><h3 id="models-with-composite-primary-keys"><a class="anchorlink" href="#models-with-composite-primary-keys"><span>4.2</span> Models with Composite Primary Keys</a></h3><p>Rails can often infer primary key-foreign key relationships between associated
models, but when dealing with composite primary keys, Rails typically defaults
to using only part of the composite key, often the id column, unless explicitly
instructed otherwise.</p><p>If you're working with composite primary keys in your Rails models and need to
ensure the correct handling of associations, please refer to the <a href="active_record_composite_primary_keys#associations-between-models-with-composite-primary-keys">Associations
section of the Composite Primary Keys
guide</a>.
This section provides comprehensive guidance on setting up and using
associations with composite primary keys in Rails, including how to specify
composite foreign keys when necessary.</p><h3 id="self-joins"><a class="anchorlink" href="#self-joins"><span>4.3</span> Self Joins</a></h3><p>A self-join is a regular join, but the table is joined with itself. This is
useful in situations where there is a hierarchical relationship within a single
table. A common example is an employee management system where an employee can
have a manager, and that manager is also an employee.</p><p>Consider an organization where employees can be managers of other employees. We
want to track this relationship using a single <code>employees</code> table.</p><p>In your Rails model, you define the <code>Employee</code> class to reflect these
relationships:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># an employee can have many subordinates.</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="c1"># an employee can have one manager.</span>
  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Employee < ApplicationRecord
  # an employee can have many subordinates.
  has_many :subordinates, class_name: &quot;Employee&quot;, foreign_key: &quot;manager_id&quot;

  # an employee can have one manager.
  belongs_to :manager, class_name: &quot;Employee&quot;, optional: true
end
">Copy</button>
</div>
<p><code>has_many :subordinates</code> sets up a one-to-many relationship where an employee
can have many subordinates. Here, we specify that the related model is also
<code>Employee</code> (<code>class_name: "Employee"</code>) and the foreign key used to identify the
manager is <code>manager_id</code>.</p><p><code>belongs_to :manager</code> sets up a one-to-one relationship where an employee can
belong to one manager. Again, we specify the related model as <code>Employee</code>.</p><p>To support this relationship, we need to add a <code>manager_id</code> column to the
<code>employees</code> table. This column references the <code>id</code> of another employee (the
manager).</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># Add a belongs_to reference to the manager, which is an employee.</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateEmployees < ActiveRecord::Migration[8.0]
  def change
    create_table :employees do |t|
      # Add a belongs_to reference to the manager, which is an employee.
      t.belongs_to :manager, foreign_key: { to_table: :employees }
      t.timestamps
    end
  end
end
">Copy</button>
</div>

<ul>
<li><code>t.belongs_to :manager</code> adds a <code>manager_id</code> column to the <code>employees</code> table.</li>
<li><code>foreign_key: { to_table: :employees }</code> ensures that the <code>manager_id</code> column
references the <code>id</code> column of the <code>employees</code> table.</li>
</ul>
<div class="interstitial note"><p>The <code>to_table</code> option passed to <code>foreign_key</code> and more are explained in
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference"><code>SchemaStatements#add_reference</code></a>.</p></div><p>With this setup, you can easily access an employee's subordinates and manager in
your Rails application.</p><p>To get an employee's subordinates:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">employee</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">subordinates</span> <span class="o">=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">subordinates</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="employee = Employee.find(1)
subordinates = employee.subordinates
">Copy</button>
</div>
<p>To get an employee's manager:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">manager</span> <span class="o">=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">manager</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="manager = employee.manager
">Copy</button>
</div>
<h2 id="single-table-inheritance-sti"><a class="anchorlink" href="#single-table-inheritance-sti"><span>5</span> Single Table Inheritance (STI)</a></h2><p>Single Table Inheritance (STI) is a pattern in Rails that allows multiple models
to be stored in a single database table. This is useful when you have different
types of entities that share common attributes and behavior but also have
specific behaviors.</p><p>For example, suppose we have <code>Car</code>, <code>Motorcycle</code>, and <code>Bicycle</code> models. These
models will share fields like <code>color</code> and <code>price</code>, but each will have unique
behaviors. They will also each have their own controller.</p><h3 id="generating-the-base-vehicle-model"><a class="anchorlink" href="#generating-the-base-vehicle-model"><span>5.1</span> Generating the Base Vehicle Model</a></h3><p>First, we generate the base <code>Vehicle</code> model with shared fields:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model vehicle type:string color:string price:decimal{10.2}
">Copy</button>
</div>
<p>Here, the <code>type</code> field is crucial for STI as it stores the model name (<code>Car</code>,
<code>Motorcycle</code>, or <code>Bicycle</code>). STI requires this field to differentiate between
the different models stored in the same table.</p><h3 id="generating-child-models"><a class="anchorlink" href="#generating-child-models"><span>5.2</span> Generating Child Models</a></h3><p>Next, we generate the <code>Car</code>, <code>Motorcycle</code>, and <code>Bicycle</code> models that inherit
from Vehicle. These models won't have their own tables; instead, they will use
the <code>vehicles</code> table.</p><p>To generate the<code>Car</code> model:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model car --parent=Vehicle
">Copy</button>
</div>
<p>For this, we can use the <code>--parent=PARENT</code> option, which will generate a model
that inherits from the specified parent and without equivalent migration (since
the table already exists).</p><p>This generates a <code>Car</code> model that inherits from <code>Vehicle</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Car < Vehicle
end
">Copy</button>
</div>
<p>This means that all behavior added to Vehicle is available for Car too, as
associations, public methods, etc. Creating a car will save it in the <code>vehicles</code>
table with "Car" as the <code>type</code> field:</p><p>Repeat the same process for <code>Motorcycle</code> and <code>Bicycle</code>.</p><h3 id="creating-records"><a class="anchorlink" href="#creating-records"><span>5.3</span> Creating Records</a></h3><p>Creating a record for <code>Car</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.create(color: 'Red', price: 10000)
">Copy</button>
</div>
<p>This will generate the following SQL:</p><div class="interstitial code">
<pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES ('Car', 'Red', 10000)
">Copy</button>
</div>
<h3 id="querying-records"><a class="anchorlink" href="#querying-records"><span>5.4</span> Querying Records</a></h3><p>Querying car records will search only for vehicles that are cars:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.all
">Copy</button>
</div>
<p>will run a query like:</p><div class="interstitial code">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN ('Car')
">Copy</button>
</div>
<h3 id="adding-specific-behavior"><a class="anchorlink" href="#adding-specific-behavior"><span>5.5</span> Adding Specific Behavior</a></h3><p>You can add specific behavior or methods to the child models. For example,
adding a method to the <code>Car</code> model:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
  <span class="k">def</span> <span class="nf">honk</span>
    <span class="s1">'Beep Beep'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Car < Vehicle
  def honk
    'Beep Beep'
  end
end
">Copy</button>
</div>
<p>Now you can call the <code>honk</code> method on a <code>Car</code> instance:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="p">.</span><span class="nf">first</span>
<span class="n">car</span><span class="p">.</span><span class="nf">honk</span>
<span class="c1"># =&gt; 'Beep Beep'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="car = Car.first
car.honk
# => 'Beep Beep'
">Copy</button>
</div>
<h3 id="controllers"><a class="anchorlink" href="#controllers"><span>5.6</span> Controllers</a></h3><p>Each model can have its own controller. For example, the <code>CarsController</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/cars_controller.rb</span>

<span class="k">class</span> <span class="nc">CarsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@cars</span> <span class="o">=</span> <span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="
class CarsController < ApplicationController
  def index
    @cars = Car.all
  end
end
">Copy</button>
</div>
<h3 id="overriding-the-inheritance-column"><a class="anchorlink" href="#overriding-the-inheritance-column"><span>5.7</span> Overriding the inheritance column</a></h3><p>There may be cases (like when working with a legacy database) where you need to
override the name of the inheritance column. This can be achieved with the
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ModelSchema.html#method-c-inheritance_column">inheritance_column</a> method.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># Schema: vehicles[ id, kind, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Vehicle</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">inheritance_column</span> <span class="o">=</span> <span class="s2">"kind"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>

<span class="no">Car</span><span class="p">.</span><span class="nf">create</span>
<span class="c1"># =&gt; #&lt;Car kind: "Car", color: "Red", price: 10000&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Schema: vehicles[ id, kind, created_at, updated_at ]
class Vehicle < ApplicationRecord
  self.inheritance_column = &quot;kind&quot;
end

class Car < Vehicle
end

Car.create
# => #<Car kind: &quot;Car&quot;, color: &quot;Red&quot;, price: 10000>
">Copy</button>
</div>
<p>In this setup, Rails will use the <code>kind</code> column to store the model type,
allowing STI to function correctly with the custom column name.</p><h3 id="disabling-the-inheritance-column"><a class="anchorlink" href="#disabling-the-inheritance-column"><span>5.8</span> Disabling the inheritance column</a></h3><p>There may be cases (like when working with a legacy database) where you need to
disable Single Table Inheritance altogether. If you don't disable STI properly,
you might encounter an <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/SubclassNotFound.html"><code>ActiveRecord::SubclassNotFound</code></a> error.</p><p>To disable STI, you can set the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ModelSchema.html#method-c-inheritance_column">inheritance_column</a> to <code>nil</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># Schema: vehicles[ id, type, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Vehicle</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">inheritance_column</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>

<span class="no">Vehicle</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">type: </span><span class="s2">"Car"</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Vehicle type: "Car", color: "Red", price: 10000&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Schema: vehicles[ id, type, created_at, updated_at ]
class Vehicle < ApplicationRecord
  self.inheritance_column = nil
end

Vehicle.create!(type: &quot;Car&quot;)
# => #<Vehicle type: &quot;Car&quot;, color: &quot;Red&quot;, price: 10000>
">Copy</button>
</div>
<p>In this configuration, Rails will treat the type column as a normal attribute
and will not use it for STI purposes. This is useful if you need to work with a
legacy schema that does not follow the STI pattern.</p><p>These adjustments provide flexibility when integrating Rails with existing
databases or when specific customization is required for your models.</p><h3 id="considerations"><a class="anchorlink" href="#considerations"><span>5.9</span> Considerations</a></h3><p><a href="#single-table-inheritance-sti"><code>Single Table Inheritance (STI)</code></a> works best
when there is little difference between subclasses and their attributes, but it
includes all attributes of all subclasses in a single table.</p><p>A disadvantage of this approach is that it can result in table bloat, as the
table will include attributes specific to each subclass, even if they aren't
used by others. This can be solved by using <a href="#delegated-types"><code>Delegated
Types</code></a>.</p><p>Additionally, if you’re using <a href="#polymorphic-associations">polymorphic
associations</a>, where a model can belong to more than
one other model via a type and an ID, it could become complex to maintain
referential integrity because the association logic must handle different types
correctly.</p><p>Finally, if you have specific data integrity checks or validations that differ
between subclasses, you need to ensure these are correctly handled by Rails or
the database, especially when setting up foreign key constraints.</p><h2 id="delegated-types"><a class="anchorlink" href="#delegated-types"><span>6</span> Delegated Types</a></h2><p>Delegated types solves the <a href="#single-table-inheritance-sti"><code>Single Table Inheritance
(STI)</code></a> problem of table bloat via
<code>delegated_type</code>. This approach allows us to store shared attributes in a
superclass table and have separate tables for subclass-specific attributes.</p><h3 id="setting-up-delegated-types"><a class="anchorlink" href="#setting-up-delegated-types"><span>6.1</span> Setting up Delegated Types</a></h3><p>To use delegated types, we need to model our data as follows:</p>
<ul>
<li>There is a superclass that stores shared attributes among all subclasses in
its table.</li>
<li>Each subclass must inherit from the superclass, and will have a separate table
for any additional attributes specific to it.</li>
</ul>
<p>This eliminates the need to define attributes in a single table that are
unintentionally shared among all subclasses.</p><h3 id="generating-models"><a class="anchorlink" href="#generating-models"><span>6.2</span> Generating Models</a></h3><p>In order to apply this to our example above, we need to regenerate our models.</p><p>First, let's generate the base <code>Entry</code> model which will act as our superclass:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model entry entryable_type:string entryable_id:integer
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model entry entryable_type:string entryable_id:integer
">Copy</button>
</div>
<p>Then, we will generate new <code>Message</code> and <code>Comment</code> models for delegation:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model message subject:string body:string
<span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model comment content:string
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model message subject:string body:string
bin/rails generate model comment content:string
">Copy</button>
</div>
<p>After running the generators, our models should look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># Schema: entries[ id, entryable_type, entryable_id, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: messages[ id, subject, body, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: comments[ id, content, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Schema: entries[ id, entryable_type, entryable_id, created_at, updated_at ]
class Entry < ApplicationRecord
end

# Schema: messages[ id, subject, body, created_at, updated_at ]
class Message < ApplicationRecord
end

# Schema: comments[ id, content, created_at, updated_at ]
class Comment < ApplicationRecord
end
">Copy</button>
</div>
<h3 id="declaring-delegated-type"><a class="anchorlink" href="#declaring-delegated-type"><span>6.3</span> Declaring <code>delegated_type</code></a></h3><p>First, declare a <code>delegated_type</code> in the superclass <code>Entry</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Entry < ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ], dependent: :destroy
end
">Copy</button>
</div>
<p>The <code>entryable</code> parameter specifies the field to use for delegation, and include
the types <code>Message</code> and <code>Comment</code> as the delegate classes. The <code>entryable_type</code>
and <code>entryable_id</code> fields store the subclass name and the record ID of the
delegate subclass, respectively.</p><h3 id="defining-the-entryable-module"><a class="anchorlink" href="#defining-the-entryable-module"><span>6.4</span> Defining the <code>Entryable</code> Module</a></h3><p>Next, define a module to implement those delegated types by declaring the <code>as:
:entryable</code> parameter in the <code>has_one</code> association.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Entryable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_one</span> <span class="ss">:entry</span><span class="p">,</span> <span class="ss">as: :entryable</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Entryable
  extend ActiveSupport::Concern

  included do
    has_one :entry, as: :entryable, touch: true
  end
end
">Copy</button>
</div>
<p>Include the created module in your subclass:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message < ApplicationRecord
  include Entryable
end

class Comment < ApplicationRecord
  include Entryable
end
">Copy</button>
</div>
<p>With this definition complete, our <code>Entry</code> delegator now provides the following
methods:</p>
<table><thead>
<tr>
<th>Method</th>
<th>Return</th>
</tr>
</thead><tbody>
<tr>
<td><code>Entry.entryable_types</code></td>
<td>["Message", "Comment"]</td>
</tr>
<tr>
<td><code>Entry#entryable_class</code></td>
<td>Message or Comment</td>
</tr>
<tr>
<td><code>Entry#entryable_name</code></td>
<td>"message" or "comment"</td>
</tr>
<tr>
<td><code>Entry.messages</code></td>
<td><code>Entry.where(entryable_type: "Message")</code></td>
</tr>
<tr>
<td><code>Entry#message?</code></td>
<td>Returns true when <code>entryable_type == "Message"</code></td>
</tr>
<tr>
<td><code>Entry#message</code></td>
<td>Returns the message record, when <code>entryable_type == "Message"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry#message_id</code></td>
<td>Returns <code>entryable_id</code>, when <code>entryable_type == "Message"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry.comments</code></td>
<td><code>Entry.where(entryable_type: "Comment")</code></td>
</tr>
<tr>
<td><code>Entry#comment?</code></td>
<td>Returns true when <code>entryable_type == "Comment"</code></td>
</tr>
<tr>
<td><code>Entry#comment</code></td>
<td>Returns the comment record, when <code>entryable_type == "Comment"</code>, otherwise <code>nil</code></td>
</tr>
<tr>
<td><code>Entry#comment_id</code></td>
<td>Returns entryable_id, when <code>entryable_type == "Comment"</code>, otherwise <code>nil</code></td>
</tr>
</tbody></table>
<h3 id="object-creation"><a class="anchorlink" href="#object-creation"><span>6.5</span> Object creation</a></h3><p>When creating a new <code>Entry</code> object, we can specify the <code>entryable</code> subclass at
the same time.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">Entry</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">entryable: </span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">subject: </span><span class="s2">"hello!"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Entry.create! entryable: Message.new(subject: &quot;hello!&quot;)
">Copy</button>
</div>
<h3 id="adding-further-delegation"><a class="anchorlink" href="#adding-further-delegation"><span>6.6</span> Adding further delegation</a></h3><p>We can enhance our <code>Entry</code> delegator by defining <code>delegate</code> and using
polymorphism on the subclasses. For example, to delegate the <code>title</code> method from
<code>Entry</code> to it's subclasses:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span>
  <span class="n">delegate</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">to: :entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">subject</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">truncate</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Entry < ApplicationRecord
  delegated_type :entryable, types: %w[ Message Comment ]
  delegate :title, to: :entryable
end

class Message < ApplicationRecord
  include Entryable

  def title
    subject
  end
end

class Comment < ApplicationRecord
  include Entryable

  def title
    content.truncate(20)
  end
end
">Copy</button>
</div>
<p>This setup allows <code>Entry</code> to delegate the <code>title</code> method to its subclasses,
where <code>Message</code> uses <code>subject</code> and <code>Comment</code> uses a truncated version of
<code>content</code>.</p><h2 id="tips-tricks-and-warnings"><a class="anchorlink" href="#tips-tricks-and-warnings"><span>7</span> Tips, Tricks, and Warnings</a></h2><p>Here are a few things you should know to make efficient use of Active Record
associations in your Rails applications:</p>
<ul>
<li>Controlling caching</li>
<li>Avoiding name collisions</li>
<li>Updating the schema</li>
<li>Controlling association scope</li>
<li>Bi-directional associations</li>
</ul>
<h3 id="controlling-association-caching"><a class="anchorlink" href="#controlling-association-caching"><span>7.1</span> Controlling Association Caching</a></h3><p>All of the association methods are built around caching, which keeps the result
of loaded associations for further operations. The cache is even shared across
methods. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retrieves books from the database
author.books.load

# uses the cached copy of books
author.books.size

# uses the cached copy of books
author.books.empty?
">Copy</button>
</div>
<div class="interstitial note"><p>When we use <code>author.books</code>, the data is not immediately loaded from the
database. Instead, it sets up a query that will be executed when you actually
try to use the data, for example, by calling methods that require data like
each, size, empty?, etc. By calling <code>author.books.load</code>, before calling other
methods which use the data, you explicitly trigger the query to load the data
from the database immediately. This is useful if you know you will need the data
and want to avoid the potential performance overhead of multiple queries being
triggered as you work with the association.</p></div><p>But what if you want to reload the cache, because data might have been changed
by some other part of the application? Just call
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-reload"><code>reload</code></a>
on the association:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># discards the cached copy of books and goes back to the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# retrieves books from the database
author.books.load

# uses the cached copy of books
author.books.size

# discards the cached copy of books and goes back to the database
author.books.reload.empty?
">Copy</button>
</div>
<h3 id="avoiding-name-collisions"><a class="anchorlink" href="#avoiding-name-collisions"><span>7.2</span> Avoiding Name Collisions</a></h3><p>When creating associations in Ruby on Rails models, it's important to avoid
using names that are already used for instance methods of <code>ActiveRecord::Base</code>.
This is because creating an association with a name that clashes with an
existing method could lead to unintended consequences, such as overriding the
base method and causing issues with functionality. For example, using names like
<code>attributes</code> or <code>connection</code> for associations would be problematic.</p><h3 id="updating-the-schema"><a class="anchorlink" href="#updating-the-schema"><span>7.3</span> Updating the Schema</a></h3><p>Associations are extremely useful, they are responsible for defining the
relationships between models but they do not update your database schema. You
are responsible for maintaining your database schema to match your associations.
This usually involves two main tasks: creating foreign keys for <a href="#belongs-to"><code>belongs_to</code>
associations</a> and setting up the correct join table for <a href="#has-many-through"><code>has_many
:through</code></a> and
<a href="#has-and-belongs-to-many"><code>has_and_belongs_to_many</code></a> associations. You can read
more about when to use a <code>has_many :through vs has_and_belongs_to_many</code> <a href="#has-many-through-vs-has-and-belongs-to-many">in the
has many through vs has and belongs to many
section</a>.</p><h4 id="creating-foreign-keys-for-belongs-to-associations"><a class="anchorlink" href="#creating-foreign-keys-for-belongs-to-associations"><span>7.3.1</span> Creating Foreign Keys for <code>belongs_to</code> Associations</a></h4><p>When you declare a <a href="#belongs-to"><code>belongs_to</code> association</a>, you need to create
foreign keys as appropriate. For example, consider this model:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>This declaration needs to be backed up by a corresponding foreign key column in
the books table. For a brand new table, the migration might look something like
this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks < ActiveRecord::Migration[8.0]
  def change
    create_table :books do |t|
      t.datetime   :published_at
      t.string     :book_number
      t.belongs_to :author
    end
  end
end
">Copy</button>
</div>
<p>Whereas for an existing table, it might look like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddAuthorToBooks < ActiveRecord::Migration[8.0]
  def change
    add_reference :books, :author
  end
end
">Copy</button>
</div>
<h4 id="creating-join-tables-for-has-and-belongs-to-many-associations"><a class="anchorlink" href="#creating-join-tables-for-has-and-belongs-to-many-associations"><span>7.3.2</span> Creating Join Tables for <code>has_and_belongs_to_many</code> Associations</a></h4><p>If you create a <code>has_and_belongs_to_many</code> association, you need to explicitly
create the join table. Unless the name of the join table is explicitly specified
by using the <code>:join_table</code> option, Active Record creates the name by using the
lexical order of the class names. So a join between author and book models will
give the default join table name of "authors_books" because "a" outranks "b" in
lexical ordering.</p><p>Whatever the name, you must manually generate the join table with an appropriate
migration. For example, consider these associations:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly < ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part < ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>These need to be backed up by a migration to create the <code>assemblies_parts</code>
table.</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateAssembliesPartsJoinTable assemblies parts
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate migration CreateAssembliesPartsJoinTable assemblies parts
">Copy</button>
</div>
<p>You can then fill out the migration and ensure that the table is created without
a primary key.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable < ActiveRecord::Migration[8.0]
  def change
    create_table :assemblies_parts, id: false do |t|
      t.bigint :assembly_id
      t.bigint :part_id
    end

    add_index :assemblies_parts, :assembly_id
    add_index :assemblies_parts, :part_id
  end
end
">Copy</button>
</div>
<p>We pass <code>id: false</code> to <code>create_table</code> because the join table does not represent
a model. If you observe any strange behavior in a <code>has_and_belongs_to_many</code>
association like mangled model IDs, or exceptions about conflicting IDs, chances
are you forgot to set <code>id: false</code> when creating your migration.</p><p>For simplicity, you can also use the method <code>create_join_table</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable < ActiveRecord::Migration[8.0]
  def change
    create_join_table :assemblies, :parts do |t|
      t.index :assembly_id
      t.index :part_id
    end
  end
end
">Copy</button>
</div>
<p>You can read more about the <code>create_join_table</code> method in the <a href="active_record_migrations.html#creating-a-join-table">Active Record
Migration Guides</a></p><h4 id="creating-join-tables-for-has-many-through-associations"><a class="anchorlink" href="#creating-join-tables-for-has-many-through-associations"><span>7.3.3</span> Creating Join Tables for <code>has_many :through</code> Associations</a></h4><p>The main difference in schema implementation between creating a join table for
<code>has_many :through</code> vs <code>has_and_belongs_to_many</code> is that the join table for a
<code>has_many :through</code> requires an <code>id</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments < ActiveRecord::Migration[8.0]
  def change
    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h3 id="controlling-association-scope"><a class="anchorlink" href="#controlling-association-scope"><span>7.4</span> Controlling Association Scope</a></h3><p>By default, associations look for objects only within the current module's
scope. This feature is particularly useful when declaring Active Record models
inside a module, as it keeps the associations scoped properly. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end

    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>In this example, both the <code>Supplier</code> and <code>Account</code> classes are defined within
the same module (<code>MyApplication::Business</code>). This organization allows you to
structure your models into folders based on their scope without needing to
explicitly specify the scope in every association:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># app/models/my_application/business/supplier.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end
  end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># app/models/my_application/business/account.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>It is important to note that while model scoping helps organize your code, it
does not change the naming convention for your database tables. For instance, if
you have a <code>MyApplication::Business::Supplier</code> model, the corresponding database
table should still follow the naming convention and be named
<code>my_application_business_suppliers</code>.</p><p>However, if the <code>Supplier</code> and <code>Account</code> models are defined in different scopes,
the associations will not work by default:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account
    end
  end

  module Billing
    class Account < ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>To associate a model with a model in a different namespace, you must specify the
complete class name in your association declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier < ApplicationRecord
      has_one :account,
        class_name: &quot;MyApplication::Billing::Account&quot;
    end
  end

  module Billing
    class Account < ApplicationRecord
      belongs_to :supplier,
        class_name: &quot;MyApplication::Business::Supplier&quot;
    end
  end
end
">Copy</button>
</div>
<p>By explicitly declaring the <code>class_name</code> option, you can create associations
across different namespaces, ensuring the correct models are linked regardless
of their module scope.</p><h3 id="bi-directional-associations"><a class="anchorlink" href="#bi-directional-associations"><span>7.5</span> Bi-directional Associations</a></h3><p>In Rails, it's common for associations between models to be bi-directional,
meaning they need to be declared in both related models. Consider the following
example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Active Record will attempt to automatically identify that these two models share
a bi-directional association based on the association name. This information
allows Active Record to:</p>
<ul>
<li><p>Prevent needless queries for already-loaded data:</p><p>Active Record avoids additional database queries for already-loaded data.</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">all?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># No additional queries executed here</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
author.books.all? do |book|
  book.author.equal?(author) # No additional queries executed here
end
">Copy</button>
</div></li>
<li><p>Prevent inconsistent data</p><p>Since only one copy of the <code>Author</code> object is loaded, it helps to prevent
inconsistencies.</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
book = author.books.first
author.name == book.author.name
author.name = &quot;Changed Name&quot;
author.name == book.author.name
">Copy</button>
</div></li>
<li><p>Automatic saving of associations in more cases:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.save!
book.persisted?
author.persisted?
">Copy</button>
</div></li>
<li><p>Validate the <a href="active_record_validations.html#presence">presence</a> and
<a href="active_record_validations.html#absence">absence</a> of associations in more
cases:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="book = Book.new
book.valid?
book.errors.full_messages
author = Author.new
book = author.books.new
book.valid?
">Copy</button>
</div></li>
</ul>
<p>Sometimes, you might need to customize the association with options like
<code>:foreign_key</code> or <code>:class_name</code>. When you do this, Rails might not automatically
recognize the bi-directional association involving <code>:through</code> or <code>:foreign_key</code>
options.</p><p>Custom scopes on the opposite association also prevent automatic identification,
as do custom scopes on the association itself unless
<a href="configuring.html#config-active-record-automatic-scope-inversing"><code>config.active_record.automatic_scope_inversing</code></a> is set to true.</p><p>For example, consider the following model declarations with a custom foreign
key:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
end

class Book < ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>Due to the <code>:foreign_key</code> option, Active Record will not automatically recognize
the bi-directional association, which can lead to several issues:</p>
<ul>
<li><p>Execute needless queries for the same data (in this example causing N+1
queries):</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># This executes an author query for every book</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
author.books.any? do |book|
  book.writer.equal?(author) # This executes an author query for every book
end
">Copy</button>
</div></li>
<li><p>Reference multiple copies of a model with inconsistent data:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">name</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
book = author.books.first
author.name == book.writer.name
author.name = &quot;Changed Name&quot;
author.name == book.writer.name
">Copy</button>
</div></li>
<li><p>Fail to autosave associations:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.save!
book.persisted?
author.persisted?
">Copy</button>
</div></li>
<li><p>Fail to validate presence or absence:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Author must exist"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.new
book = author.books.new
book.valid?
book.errors.full_messages
">Copy</button>
</div></li>
</ul>
<p>To resolve these issues, you can explicitly declare bi-directional associations
using the <code>:inverse_of</code> option:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, inverse_of: 'writer'
end

class Book < ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>By including the <code>:inverse_of</code> option in the <code>has_many</code> association declaration,
Active Record will recognize the bi-directional association and behave as
described in the initial examples above.</p><h2 id="association-references"><a class="anchorlink" href="#association-references"><span>8</span> Association References</a></h2><h3 id="options"><a class="anchorlink" href="#options"><span>8.1</span> Options</a></h3><p>While Rails uses intelligent defaults that will work well in most situations,
there may be times when you want to customize the behavior of the association
references. Such customizations can be accomplished by passing options blocks
when you create the association. For example, this association uses two such
options:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: :books_updated_at,
    counter_cache: true
end
">Copy</button>
</div>
<p>Each association supports numerous options which you can read more about in
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html"><code>Options</code> section of each association in the ActiveRecord Associations
API</a>.
We'll discuss some of the common use cases below.</p><h4 id="class-name"><a class="anchorlink" href="#class-name"><span>8.1.1</span> <code>:class_name</code></a></h4><p>If the name of the other model cannot be derived from the association name, you
can use the <code>:class_name</code> option to supply the model name. For example, if a
book belongs to an author, but the actual name of the model containing authors
is <code>Patron</code>, you'd set things up this way:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, class_name: &quot;Patron&quot;
end
">Copy</button>
</div>
<h4 id="dependent"><a class="anchorlink" href="#dependent"><span>8.1.2</span> <code>:dependent</code></a></h4><p>Controls what happens to the associated object when its owner is destroyed:</p>
<ul>
<li><code>:destroy</code>, when the object is destroyed, <code>destroy</code> will be called on its
associated objects. This method not only removes the associated records from
the database but also ensures that any defined callbacks (like
<code>before_destroy</code> and <code>after_destroy</code>) are executed. This is useful for
performing custom logic during the deletion process, such as logging or
cleaning up related data.</li>
<li><code>:delete</code>, when the object is destroyed, all its associated objects will be
deleted directly from the database without calling their <code>destroy</code> method.
This method performs a direct deletion and bypasses any callbacks or
validations in the associated models, making it more efficient but potentially
leading to data integrity issues if important cleanup tasks are skipped. Use
<code>delete</code> when you need to remove records quickly and are confident that no
additional actions are required for the associated records.</li>
<li><code>:destroy_async</code>: when the object is destroyed, an
<code>ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call
destroy on its associated objects. Active Job must be set up for this to work.
Do not use this option if the association is backed by foreign key constraints
in your database. The foreign key constraint actions will occur inside the
same transaction that deletes its owner.

<ul>
<li><code>:nullify</code> causes the foreign key to be set to <code>NULL</code>. Polymorphic type
column is also nullified on polymorphic associations. Callbacks are not
executed.</li>
<li><code>:restrict_with_exception</code> causes an <code>ActiveRecord::DeleteRestrictionError</code>
exception to be raised if there is an associated record</li>
<li><code>:restrict_with_error</code> causes an error to be added to the owner if there is
an associated object</li>
</ul></li>
</ul>
<div class="interstitial warning"><p>You should not specify this option on a <code>belongs_to</code> association that
is connected with a <code>has_many</code> association on the other class. Doing so can lead
to orphaned records in your database because destroying the parent object may
attempt to destroy its children, which in turn may attempt to destroy the parent
again, causing inconsistencies.</p></div><p>Do not leave the <code>:nullify</code> option for associations with <code>NOT NULL</code> database
constraints. Setting <code>dependent</code> to <code>:destroy</code> is essential; otherwise, the
foreign key of the associated object may be set to <code>NULL</code>, preventing changes to
it.</p><div class="interstitial note"><p>The <code>:dependent</code> option is ignored with the <code>:through</code> option. When using
<code>:through</code>, the join model must have a <code>belongs_to</code> association, and the
deletion affects only the join records, not the associated records.</p></div><p>When using <code>dependent: :destroy</code> on a scoped association, only the scoped
objects are destroyed. For example, in a <code>Post</code> model defined as <code>has_many
:comments, -&gt; { where published: true }, dependent: :destroy</code>, calling destroy
on a post will only delete published comments, leaving unpublished comments
intact with a foreign key pointing to the deleted post.</p><p>You cannot use the <code>:dependent</code> option directly on a <code>has_and_belongs_to_many</code>
association. To manage deletions of join table records, handle them manually or
switch to a <code>has_many :through</code> association, which provides more flexibility and
supports the <code>:dependent</code> option.</p><h4 id="foreign-key"><a class="anchorlink" href="#foreign-key"><span>8.1.3</span> <code>:foreign_key</code></a></h4><p>By convention, Rails assumes that the column used to hold the foreign key on
this model is the name of the association with the suffix <code>_id</code> added. The
<code>:foreign_key</code> option lets you set the name of the foreign key directly:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, foreign_key: &quot;supp_id&quot;
end
">Copy</button>
</div>
<div class="interstitial note"><p>Rails does not create foreign key columns for you. You need to explicitly
define them in your migrations.</p></div><h4 id="primary-key"><a class="anchorlink" href="#primary-key"><span>8.1.4</span> <code>:primary_key</code></a></h4><p>By default, Rails uses the <code>id</code> column as the primary key for its tables. The
<code>:primary_key</code> option allows you to specify a different column as the primary
key.</p><p>For example, if the <code>users</code> table uses <code>guid</code> as the primary key instead of
<code>id</code>, and you want the <code>todos</code> table to reference <code>guid</code> as a foreign key
(<code>user_id</code>), you can configure it like this:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># Sets the primary key to guid instead of id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span> <span class="c1"># References the guid column in users table</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  self.primary_key = 'guid' # Sets the primary key to guid instead of id
end

class Todo < ApplicationRecord
  belongs_to :user, primary_key: 'guid' # References the guid column in users table
end
">Copy</button>
</div>
<p>When you execute <code>@user.todos.create</code>, the <code>@todo</code> record will have its
<code>user_id</code> value set to the <code>guid</code> value of <code>@user</code>.</p><p><code>has_and_belongs_to_many</code> does not support the <code>:primary_key</code> option. For this
type of association, you can achieve similar functionality by using a join table
with has_many <code>:through</code> association, which gives more flexibility and supports
the <code>:primary_key</code> option. You can read more about this in the
<a href="#has-many-through"><code>has_many :through</code> section</a>.</p><h4 id="touch"><a class="anchorlink" href="#touch"><span>8.1.5</span> <code>:touch</code></a></h4><p>If you set the <code>:touch</code> option to <code>true</code>, then the <code>updated_at</code> or <code>updated_on</code>
timestamp on the associated object will be set to the current time whenever this
object is saved or destroyed:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: true
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>In this case, saving or destroying a book will update the timestamp on the
associated author. You can also specify a particular timestamp attribute to
update:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, touch: :books_updated_at
end
">Copy</button>
</div>
<p><code>has_and_belongs_to_many</code> does not support the <code>:touch</code> option. For this type of
association, you can achieve similar functionality by using a join table with
<code>has_many :through</code> association. You can read more about this in the
<a href="#has-many-through"><code>has_many :through</code> section</a>.</p><h4 id="validate"><a class="anchorlink" href="#validate"><span>8.1.6</span> <code>:validate</code></a></h4><p>If you set the <code>:validate</code> option to <code>true</code>, then new associated objects will be
validated whenever you save this object. By default, this is <code>false</code>: new
associated objects will not be validated when this object is saved.</p><p><code>has_and_belongs_to_many</code> does not support the <code>:validate</code> option. For this type
of association, you can achieve similar functionality by using a join table with
has_many <code>:through</code> association. You can read more about this in the
<a href="#has-many-through"><code>has_many :through</code> section</a>.</p><h4 id="inverse-of"><a class="anchorlink" href="#inverse-of"><span>8.1.7</span> <code>:inverse_of</code></a></h4><p>The <code>:inverse_of</code> option specifies the name of the <code>belongs_to</code> association that
is the inverse of this association. See the <a href="#bi-directional-associations">bi-directional
association</a> section for more details.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account < ApplicationRecord
  belongs_to :supplier, inverse_of: :account
end
">Copy</button>
</div>
<h4 id="source-type"><a class="anchorlink" href="#source-type"><span>8.1.8</span> <code>:source_type</code></a></h4><p>The <code>:source_type</code> option specifies the source association type for a <code>has_many
:through</code> association that proceeds through a <a href="#polymorphic-associations">polymorphic
association</a>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books
  has_many :paperbacks, through: :books, source: :format, source_type: &quot;Paperback&quot;
end

class Book < ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Hardback < ApplicationRecord; end
class Paperback < ApplicationRecord; end
">Copy</button>
</div>
<h4 id="strict-loading"><a class="anchorlink" href="#strict-loading"><span>8.1.9</span> <code>:strict_loading</code></a></h4><p>Enforces strict loading every time an associated record is loaded through this
association.</p><h4 id="association-foreign-key"><a class="anchorlink" href="#association-foreign-key"><span>8.1.10</span> <code>:association_foreign_key</code></a></h4><p>The <code>:association_foreign_key</code> can be found on a <code>has_and_belongs_to_many</code>
relationship. By convention, Rails assumes that the column in the join table
used to hold the foreign key pointing to the other model is the name of that
model with the suffix <code>_id</code> added. The <code>:association_foreign_key</code> option lets
you set the name of the foreign key directly For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: &quot;User&quot;,
      foreign_key: &quot;this_user_id&quot;,
      association_foreign_key: &quot;other_user_id&quot;
end
">Copy</button>
</div>
<div class="interstitial info"><p>The <code>:foreign_key</code> and <code>:association_foreign_key</code> options are useful when
setting up a many-to-many self-join.</p></div><h4 id="join-table"><a class="anchorlink" href="#join-table"><span>8.1.11</span> <code>:join_table</code></a></h4><p>The <code>:join_table</code> can be found on a <code>has_and_belongs_to_many</code> relationship. If
the default name of the join table, based on lexical ordering, is not what you
want, you can use the <code>:join_table</code> option to override the default.</p><h3 id="scopes"><a class="anchorlink" href="#scopes"><span>8.2</span> Scopes</a></h3><p>Scopes allow you to specify common queries that can be referenced as method
calls on the association objects. This is useful for defining custom queries
that are reused in multiple places in your application. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, -> { where active: true }
end
">Copy</button>
</div>
<h4 id="general-scopes"><a class="anchorlink" href="#general-scopes"><span>8.2.1</span> General Scopes</a></h4><p>You can use any of the standard <a href="active_record_querying.html">querying methods</a>
inside the scope block. The following ones are discussed below:</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h5 id="where"><a class="anchorlink" href="#where"><span>8.2.1.1</span> <code>where</code></a></h5><p>The <code>where</code> method lets you specify the conditions that the associated object
must meet.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { where &quot;factory = 'Seattle'&quot; }
end
">Copy</button>
</div>
<p>You can also set conditions via a hash:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { where factory: 'Seattle' }
end
">Copy</button>
</div>
<p>If you use a hash-style <code>where</code>, then record creation via this association will
be automatically scoped using the hash. In this case, using
<code>@parts.assemblies.create</code> or <code>@parts.assemblies.build</code> will create assemblies
where the <code>factory</code> column has the value "Seattle".</p><h5 id="includes"><a class="anchorlink" href="#includes"><span>8.2.1.2</span> <code>includes</code></a></h5><p>You can use the <code>includes</code> method to specify second-order associations that
should be eager-loaded when this association is used. For example, consider
these models:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account
end

class Account < ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative < ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<p>If you frequently retrieve representatives directly from suppliers
(<code>@supplier.account.representative</code>), then you can make your code somewhat more
efficient by including representatives in the association from suppliers to
accounts:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, -> { includes :representative }
end

class Account < ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative < ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<div class="interstitial note"><p>There's no need to use <code>includes</code> for immediate associations - that is, if
you have <code>Book belongs_to :author</code>, then the author is eager-loaded
automatically when it's needed.</p></div><h5 id="readonly"><a class="anchorlink" href="#readonly"><span>8.2.1.3</span> <code>readonly</code></a></h5><p>If you use <code>readonly</code>, then the associated object will be read-only when
retrieved via the association.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, -> { readonly }
end
">Copy</button>
</div>
<p>This is useful when you want to prevent the associated object from being
modified through the association. For example, if you have a <code>Book</code> model that
<code>belongs_to :author</code>, you can use <code>readonly</code> to prevent the author from being
modified through the book:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">save!</span> <span class="c1"># This will raise an ActiveRecord::ReadOnlyRecord error</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author = Author.first
@book.author.save! # This will raise an ActiveRecord::ReadOnlyRecord error
">Copy</button>
</div>
<h5 id="general-scopes-select"><a class="anchorlink" href="#general-scopes-select"><span>8.2.1.4</span> <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause used to retrieve
data about the associated object. By default, Rails retrieves all columns.</p><p>For example, if you have an <code>Author</code> model with many <code>Book</code>s, but you only want
to retrieve the <code>title</code> of each book:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># Only select id and title columns</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, -> { select(:id, :title) } # Only select id and title columns
end

class Book < ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Now, when you access an author's books, only the <code>id</code> and <code>title</code> columns will
be retrieved from the <code>books</code> table.</p><div class="interstitial info"><p>If you use the <code>select</code> method on a <code>belongs_to</code> association, you should
also set the <code>:foreign_key</code> option to guarantee correct results. For example:</p></div><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span> <span class="c1"># Only select id and name columns</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, -> { select(:id, :name) }, foreign_key: 'author_id' # Only select id and name columns
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>In this case, when you access a book's author, only the <code>id</code> and <code>name</code> columns
will be retrieved from the <code>authors</code> table.</p><h4 id="collection-scopes"><a class="anchorlink" href="#collection-scopes"><span>8.2.2</span> Collection Scopes</a></h4><p><code>has_many</code> and <code>has_and_belongs_to_many</code> are associations that deal with
collections of records, so you can use additional methods like <code>group</code>, <code>limit</code>,
<code>order</code>, <code>select</code>, and <code>distinct</code> to customize the query used by the
association.</p><h5 id="group"><a class="anchorlink" href="#group"><span>8.2.2.1</span> <code>group</code></a></h5><p>The <code>group</code> method supplies an attribute name to group the result set by, using
a <code>GROUP BY</code> clause in the finder SQL.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies, -> { group &quot;factory&quot; }
end
">Copy</button>
</div>
<h5 id="limit"><a class="anchorlink" href="#limit"><span>8.2.2.2</span> <code>limit</code></a></h5><p>The <code>limit</code> method lets you restrict the total number of objects that will be
fetched through an association.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts < ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -> { order(&quot;created_at DESC&quot;).limit(50) }
end
">Copy</button>
</div>
<h5 id="order"><a class="anchorlink" href="#order"><span>8.2.2.3</span> <code>order</code></a></h5><p>The <code>order</code> method dictates the order in which associated objects will be
received (in the syntax used by an SQL <code>ORDER BY</code> clause).</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, -> { order &quot;date_confirmed DESC&quot; }
end
">Copy</button>
</div>
<h5 id="collection-scopes-select"><a class="anchorlink" href="#collection-scopes-select"><span>8.2.2.4</span> <code>select</code></a></h5><p>The <code>select</code> method lets you override the SQL <code>SELECT</code> clause that is used to
retrieve data about the associated objects. By default, Rails retrieves all
columns.</p><div class="interstitial warning"><p>If you specify your own <code>select</code>, be sure to include the primary key
and foreign key columns of the associated model. If you do not, Rails will throw
an error.</p></div><h5 id="distinct"><a class="anchorlink" href="#distinct"><span>8.2.2.5</span> <code>distinct</code></a></h5><p>Use the <code>distinct</code> method to keep the collection free of duplicates. This is
mostly useful together with the <code>:through</code> option.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person < ApplicationRecord
  has_many :readings
  has_many :articles, through: :readings
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 5, name: "a1"&gt;</span><span class="p">,</span> <span class="c1">#&lt;Article id: 5, name: "a1"&gt;]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'John')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>In the above case there are two readings and <code>person.articles</code> brings out both
of them even though these records are pointing to the same article.</p><p>Now let's set <code>distinct</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person
  has_many :readings
  has_many :articles, -> { distinct }, through: :readings
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 7, name: "a1"&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>In the above case there are still two readings. However <code>person.articles</code> shows
only one article because the collection loads only unique records.</p><p>If you want to make sure that, upon insertion, all of the records in the
persisted association are distinct (so that you can be sure that when you
inspect the association that you will never find duplicate records), you should
add a unique index on the table itself. For example, if you have a table named
<code>readings</code> and you want to make sure the articles can only be added to a person
once, you could add the following in a migration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_index :readings, [:person_id, :article_id], unique: true
">Copy</button>
</div>
<p>Once you have this unique index, attempting to add the article to a person twice
will raise an <code>ActiveRecord::RecordNotUnique</code> error:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles << article
person.articles << article
">Copy</button>
</div>
<p>Note that checking for uniqueness using something like <code>include?</code> is subject to
race conditions. Do not attempt to use <code>include?</code> to enforce distinctness in an
association. For instance, using the article example from above, the following
code would be racy because multiple users could be attempting this at the same
time:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person.articles << article unless person.articles.include?(article)
">Copy</button>
</div>
<h4 id="using-the-association-owner"><a class="anchorlink" href="#using-the-association-owner"><span>8.2.3</span> Using the Association Owner</a></h4><p>You can pass the owner of the association as a single argument to the scope
block for even more control over the association scope. However, be aware that
doing this will make preloading the association impossible.</p><p>For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">supplier</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="n">supplier</span><span class="p">.</span><span class="nf">active?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier < ApplicationRecord
  has_one :account, ->(supplier) { where active: supplier.active? }
end
">Copy</button>
</div>
<p>In this example, the <code>account</code> association of the <code>Supplier</code> model is scoped
based on the <code>active</code> status of the supplier.</p><p>By utilizing association extensions and scoping with the association owner, you
can create more dynamic and context-aware associations in your Rails
applications.</p><h3 id="counter-cache"><a class="anchorlink" href="#counter-cache"><span>8.3</span> Counter Cache</a></h3><p>The <code>:counter_cache</code> option in Rails helps improve the efficiency of finding the
number of associated objects. Consider the following models:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>By default, querying <code>@auth books.size</code> results in a database call to perform a
<code>COUNT(*)</code> query. To optimize this, you can add a counter cache to the
<em>belonging</em> model (in this case, <code>Book</code>). This way, Rails can return the count
directly from the cache without querying the database.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, counter_cache: true
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>With this declaration, Rails will keep the cache value up to date, and then
return that value in response to the <code>size</code> method, avoiding the database call.</p><p>Although the <code>:counter_cache</code> option is specified on the model with the
<code>belongs_to</code> declaration, the actual column must be added to the <em>associated</em>
(in this case <code>has_many</code>) model. In this example, you need to add a
<code>books_count</code> column to the <code>Author</code> model:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddBooksCountToAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">:books_count</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddBooksCountToAuthors < ActiveRecord::Migration[8.0]
  def change
    add_column :authors, :books_count, :integer, default: 0, null: false
  end
end
">Copy</button>
</div>
<p>You can specify a custom column name in the <code>counter_cache</code> declaration instead
of using the default <code>books_count</code>. For example, to use <code>count_of_books</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :author, counter_cache: :count_of_books
end

class Author < ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="interstitial note"><p>You only need to specify the <code>:counter_cache</code> option on the <code>belongs_to</code>
side of the association.</p></div><p>Using counter caches on existing large tables can be troublesome. To avoid
locking the table for too long, the column values must be backfilled separately
from the column addition. This backfill must also happen before using
<code>:counter_cache</code>; otherwise, methods like <code>size</code>, <code>any?</code>, etc., which rely on
counter caches, may return incorrect results.</p><p>To backfill values safely while keeping counter cache columns updated with child
record creation/removal and ensuring methods always get results from the
database (avoiding potentially incorrect counter cache values), use
<code>counter_cache: { active: false }</code>. This setting ensures that methods always
fetch results from the database, avoiding incorrect values from an uninitialized
counter cache. If you need to specify a custom column name, use <code>counter_cache:
{ active: false, column: :my_custom_counter }</code>.</p><p>If for some reason you change the value of an owner model's primary key, and do
not also update the foreign keys of the counted models, then the counter cache
may have stale data. In other words, any orphaned models will still count
towards the counter. To fix a stale counter cache, use
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-reset_counters"><code>reset_counters</code></a>.</p><h3 id="callbacks"><a class="anchorlink" href="#callbacks"><span>8.4</span> Callbacks</a></h3><p><a href="active_record_callbacks.html">Normal callbacks</a> hook into the life cycle of
Active Record objects, allowing you to work with those objects at various
points. For example, you can use a <code>:before_save</code> callback to cause something to
happen just before an object is saved.</p><p>Association callbacks are similar to normal callbacks, but they are triggered by
events in the life cycle of a collection associated with an Active Record
object. There are four available association callbacks:</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>You define association callbacks by adding options to the association
declaration. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit_reached?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, before_add: :check_credit_limit

  def check_credit_limit(book)
    throw(:abort) if limit_reached?
  end
end
">Copy</button>
</div>
<p>In this example, the <code>Author</code> model has a <code>has_many</code> association with <code>books</code>.
The <code>before_add</code> callback <code>check_credit_limit</code> is triggered before a book is
added to the collection. If the <code>limit_reached?</code> method returns <code>true</code>, the book
is not added to the collection.</p><p>By using these association callbacks, you can customize the behavior of your
associations, ensuring that specific actions are taken at key points in the life
cycle of your collections.</p><p>Read more about association callbacks in the <a href="active_record_callbacks.html#association-callbacks">Active Record Callbacks
Guide</a></p><h3 id="extensions"><a class="anchorlink" href="#extensions"><span>8.5</span> Extensions</a></h3><p>Rails provides the ability to extend the functionality of association proxy
objects, which manage associations, by adding new finders, creators, or other
methods through anonymous modules. This feature allows you to customize
associations to meet the specific needs of your application.</p><p>You can extend a <code>has_many</code> association with custom methods directly within the
model definition. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books do
    def find_by_book_prefix(book_number)
      find_by(category_id: book_number[0..2])
    end
  end
end
">Copy</button>
</div>
<p>In this example, the <code>find_by_book_prefix</code> method is added to the <code>books</code>
association of the <code>Author</code> model. This custom method allows you to find <code>books</code>
based on a specific prefix of the <code>book_number</code>.</p><p>If you have an extension that should be shared by multiple associations, you can
use a named extension module. For example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module FindRecentExtension
  def find_recent
    where(&quot;created_at > ?&quot;, 5.days.ago)
  end
end

class Author < ApplicationRecord
  has_many :books, -> { extending FindRecentExtension }
end

class Supplier < ApplicationRecord
  has_many :deliveries, -> { extending FindRecentExtension }
end
">Copy</button>
</div>
<p>In this case, the <code>FindRecentExtension</code> module is used to add a <code>find_recent</code>
method to both the <code>books</code> association in the <code>Author</code> model and the
<code>deliveries</code> association in the <code>Supplier</code> model. This method retrieves records
created within the last five days.</p><p>Extensions can interact with the internals of the association proxy using the
<code>proxy_association</code> accessor. The <code>proxy_association</code> provides three important
attributes:</p>
<ul>
<li><code>proxy_association.owner</code> returns the object that the association is a part
of.</li>
<li><code>proxy_association.reflection</code> returns the reflection object that describes
the association.</li>
<li><code>proxy_association.target</code> returns the associated object for <code>belongs_to</code> or
<code>has_one</code>, or the collection of associated objects for <code>has_many</code> or
<code>has_and_belongs_to_many</code>.</li>
</ul>
<p>These attributes allow extensions to access and manipulate the association
proxy's internal state and behavior.</p><p>Here's an advanced example demonstrating how to use these attributes in an
extension:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">AdvancedExtension</span>
  <span class="k">def</span> <span class="nf">find_and_log</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">proxy_association</span><span class="p">.</span><span class="nf">owner</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Querying </span><span class="si">#{</span><span class="n">proxy_association</span><span class="p">.</span><span class="nf">reflection</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> with </span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">results</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">AdvancedExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module AdvancedExtension
  def find_and_log(query)
    results = where(query)
    proxy_association.owner.logger.info(&quot;Querying #{proxy_association.reflection.name} with #{query}&quot;)
    results
  end
end

class Author < ApplicationRecord
  has_many :books, -> { extending AdvancedExtension }
end
">Copy</button>
</div>
<p>In this example, the <code>find_and_log</code> method performs a query on the association
and logs the query details using the owner's logger. The method accesses the
owner's logger via <code>proxy_association.owner</code> and the association's name via
<code>proxy_association.reflection</code>.name.</p>
        <hr>
        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>.
        </p>
      </div>
    </div>
  </main>

  <hr class="hide" />
  <footer id="page_footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </footer>
</body>
</html>
