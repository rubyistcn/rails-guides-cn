<!doctype html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Callbacks — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style-9e7329e5b4c46ecb619db14d43a6724d.css" data-turbo-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print-a4d2686c548e59657450d04dc27f7787.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight-a0d2133dd0073968b2d33b1f1360a2a3.css" data-turbo-track="reload">

  <link rel="icon" href="images/favicon.ico" sizes="any">

  <link rel="apple-touch-icon" href="images/icon.png">

  <script src="javascripts/@hotwired--turbo-764f59c7edbeb902a9068c0340dd274e.js" data-turbo-track="reload"></script>
  <script src="javascripts/clipboard-8b7aed6f069f0cf58eeae353cd2f898b.js" data-turbo-track="reload"></script>
  <script src="javascripts/guides-be644dbd164a32c619aa8f714fc0b4bf.js" data-turbo-track="reload"></script>

  <meta property="og:title" content="Active Record Callbacks — Ruby on Rails Guides" />
  <meta name="description" content="Active Record CallbacksThis guide teaches you how to hook into the life cycle of your Active Record objects.After reading this guide, you will know: When certain events occur during the life of an Active Record object. How to register, run, and skip callbacks that respond to these events. How to create relational, association, conditional, and transactional callbacks. How to create objects that encapsulate common behavior for your callbacks to be reused." />
  <meta property="og:description" content="Active Record CallbacksThis guide teaches you how to hook into the life cycle of your Active Record objects.After reading this guide, you will know: When certain events occur during the life of an Active Record object. How to register, run, and skip callbacks that respond to these events. How to create relational, association, conditional, and transactional callbacks. How to create objects that encapsulate common behavior for your callbacks to be reused." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100..900&family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#C81418">
</head>

<body class="guide">
  <nav id="topNav" aria-label="Secondary">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </nav>
  <header id="page_header">
    <div class="wrapper clearfix">
      <nav id="feature_nav">
        <div class="header-logo">
          <a href="index.html" title="Return to the Guides Home for Edge Guides">Guides</a>
          <span id="version_switcher">
            Version:
            <select class="guides-version">
              <option value="https://edgeguides.rubyonrails.org/" selected>Edge</option>
                <option value="https://guides.rubyonrails.org/v7.2/">7.2</option>
                <option value="https://guides.rubyonrails.org/v7.1/">7.1</option>
                <option value="https://guides.rubyonrails.org/v7.0/">7.0</option>
                <option value="https://guides.rubyonrails.org/v6.1/">6.1</option>
                <option value="https://guides.rubyonrails.org/v6.0/">6.0</option>
                <option value="https://guides.rubyonrails.org/v5.2/">5.2</option>
                <option value="https://guides.rubyonrails.org/v5.1/">5.1</option>
                <option value="https://guides.rubyonrails.org/v5.0/">5.0</option>
                <option value="https://guides.rubyonrails.org/v4.2/">4.2</option>
                <option value="https://guides.rubyonrails.org/v4.1/">4.1</option>
                <option value="https://guides.rubyonrails.org/v4.0/">4.0</option>
                <option value="https://guides.rubyonrails.org/v3.2/">3.2</option>
                <option value="https://guides.rubyonrails.org/v3.1/">3.1</option>
                <option value="https://guides.rubyonrails.org/v3.0/">3.0</option>
                <option value="https://guides.rubyonrails.org/v2.3/">2.3</option>
            </select>
          </span>
        </div>
        <ul class="nav">
          <li><a class="nav-item" id="home_nav" href="https://rubyonrails.org/">Home</a></li>
          <li class="guides-index guides-index-large">
            <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
            <div id="guides" class="clearfix" style="display: none;">
              <hr />
              <dl class="guides-section-container">
                  <div class="guides-section">
                    <dt>Start Here</dt>
                    <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Models</dt>
                    <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                    <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                    <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                    <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                    <dd><a href="association_basics.html">Active Record Associations</a></dd>
                    <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                    <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Views</dt>
                    <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                    <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                    <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                    <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Controllers</dt>
                    <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                    <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Other Components</dt>
                    <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                    <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                    <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                    <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                    <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                    <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                    <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Digging Deeper</dt>
                    <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                    <dd><a href="testing.html">Testing Rails Applications</a></dd>
                    <dd><a href="security.html">Securing Rails Applications</a></dd>
                    <dd><a href="error_reporting.html">Error Reporting in Rails Applications</a></dd>
                    <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                    <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                    <dd><a href="command_line.html">The Rails Command Line</a></dd>
                    <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                    <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                    <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading</a></dd>
                    <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                    <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                    <dd><a href="tuning_performance_for_deployment.html">Tuning Performance for Deployment</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Advanced Active Record</dt>
                    <dd><a href="active_record_multiple_databases.html">Multiple Databases</a></dd>
                    <dd><a href="active_record_composite_primary_keys.html">Composite Primary Keys</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Extending Rails</dt>
                    <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                    <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Contributing</dt>
                    <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                    <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                    <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                    <dd><a href="development_dependencies_install.html">Installing Rails Core Development Dependencies</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Policies</dt>
                    <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Release Notes</dt>
                    <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                    <dd><a href="7_2_release_notes.html">Version 7.2 - August 2024</a></dd>
                    <dd><a href="7_1_release_notes.html">Version 7.1 - October 2023</a></dd>
                    <dd><a href="7_0_release_notes.html">Version 7.0 - December 2021</a></dd>
                    <dd><a href="6_1_release_notes.html">Version 6.1 - December 2020</a></dd>
                    <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                    <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                    <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                    <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                    <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                    <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                    <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                    <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                    <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                    <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                    <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                    <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                  </div>
              </dl>
            </div>
          </li>
          <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
          <li class="guides-index guides-index-small">
            <select class="guides-index-item nav-item">
              <option value="index.html">Guides Index</option>
                <optgroup label="Start Here">
                    <option value="getting_started.html">Getting Started with Rails</option>
                </optgroup>
                <optgroup label="Models">
                    <option value="active_record_basics.html">Active Record Basics</option>
                    <option value="active_record_migrations.html">Active Record Migrations</option>
                    <option value="active_record_validations.html">Active Record Validations</option>
                    <option value="active_record_callbacks.html">Active Record Callbacks</option>
                    <option value="association_basics.html">Active Record Associations</option>
                    <option value="active_record_querying.html">Active Record Query Interface</option>
                    <option value="active_model_basics.html">Active Model Basics</option>
                </optgroup>
                <optgroup label="Views">
                    <option value="action_view_overview.html">Action View Overview</option>
                    <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                    <option value="action_view_helpers.html">Action View Helpers</option>
                    <option value="form_helpers.html">Action View Form Helpers</option>
                </optgroup>
                <optgroup label="Controllers">
                    <option value="action_controller_overview.html">Action Controller Overview</option>
                    <option value="routing.html">Rails Routing from the Outside In</option>
                </optgroup>
                <optgroup label="Other Components">
                    <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                    <option value="action_mailer_basics.html">Action Mailer Basics</option>
                    <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                    <option value="action_text_overview.html">Action Text Overview</option>
                    <option value="active_job_basics.html">Active Job Basics</option>
                    <option value="active_storage_overview.html">Active Storage Overview</option>
                    <option value="action_cable_overview.html">Action Cable Overview</option>
                </optgroup>
                <optgroup label="Digging Deeper">
                    <option value="i18n.html">Rails Internationalization (I18n) API</option>
                    <option value="testing.html">Testing Rails Applications</option>
                    <option value="security.html">Securing Rails Applications</option>
                    <option value="error_reporting.html">Error Reporting in Rails Applications</option>
                    <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                    <option value="configuring.html">Configuring Rails Applications</option>
                    <option value="command_line.html">The Rails Command Line</option>
                    <option value="asset_pipeline.html">The Asset Pipeline</option>
                    <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                    <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading</option>
                    <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                    <option value="api_app.html">Using Rails for API-only Applications</option>
                    <option value="tuning_performance_for_deployment.html">Tuning Performance for Deployment</option>
                </optgroup>
                <optgroup label="Advanced Active Record">
                    <option value="active_record_multiple_databases.html">Multiple Databases</option>
                    <option value="active_record_composite_primary_keys.html">Composite Primary Keys</option>
                </optgroup>
                <optgroup label="Extending Rails">
                    <option value="rails_on_rack.html">Rails on Rack</option>
                    <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                </optgroup>
                <optgroup label="Contributing">
                    <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                    <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                    <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
                    <option value="development_dependencies_install.html">Installing Rails Core Development Dependencies</option>
                </optgroup>
                <optgroup label="Policies">
                    <option value="maintenance_policy.html">Maintenance Policy</option>
                </optgroup>
                <optgroup label="Release Notes">
                    <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                    <option value="7_2_release_notes.html">Version 7.2 - August 2024</option>
                    <option value="7_1_release_notes.html">Version 7.1 - October 2023</option>
                    <option value="7_0_release_notes.html">Version 7.0 - December 2021</option>
                    <option value="6_1_release_notes.html">Version 6.1 - December 2020</option>
                    <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                    <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                    <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                    <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                    <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                    <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                    <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                    <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                    <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                    <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                    <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                    <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
                </optgroup>
            </select>
          </li>
      </ul>
      </nav>
    </div>
  </header>
  <hr class="hide" />

  <section id="feature">
    <div class="wrapper">
      <h1>Active Record Callbacks</h1><p>This guide teaches you how to hook into the life cycle of your Active Record
objects.</p><p>After reading this guide, you will know:</p>
<ul>
<li>When certain events occur during the life of an Active Record object.</li>
<li>How to register, run, and skip callbacks that respond to these events.</li>
<li>How to create relational, association, conditional, and transactional
callbacks.</li>
<li>How to create objects that encapsulate common behavior for your callbacks to
be reused.</li>
</ul>


                <nav id="subCol">
            <h3 class="chapter">
              <picture>
                <!-- Using the `source`  HTML tag to set the dark theme image -->
                <source
                  srcset="images/icon_book-close-bookmark-1-wht.svg"
                  media="(prefers-color-scheme: dark)"
                />
                <img src="images/icon_book-close-bookmark-1.svg" alt="Chapter Icon" />
              </picture>
              Chapters
            </h3>
            <ol class="chapters">
<li><a href="#the-object-life-cycle">The Object Life Cycle</a></li>
<li><a href="#callback-registration">Callback Registration</a>

<ul>
<li><a href="#registering-callbacks-to-fire-on-life-cycle-events">Registering Callbacks to Fire on Life Cycle Events</a></li>
</ul></li>
<li><a href="#available-callbacks">Available Callbacks</a>

<ul>
<li><a href="#creating-an-object">Creating an Object</a></li>
<li><a href="#updating-an-object">Updating an Object</a></li>
<li><a href="#destroying-an-object">Destroying an Object</a></li>
<li><a href="#after-initialize-and-after-find"><code>after_initialize</code> and <code>after_find</code></a></li>
<li><a href="#after-touch"><code>after_touch</code></a></li>
</ul></li>
<li><a href="#running-callbacks">Running Callbacks</a></li>
<li><a href="#conditional-callbacks">Conditional Callbacks</a>

<ul>
<li><a href="#using-if-and-unless-with-a-symbol">Using <code>:if</code> and <code>:unless</code> with a <code>Symbol</code></a></li>
<li><a href="#using-if-and-unless-with-a-proc">Using <code>:if</code> and <code>:unless</code> with a <code>Proc</code></a></li>
<li><a href="#multiple-callback-conditions">Multiple Callback Conditions</a></li>
<li><a href="#using-both-if-and-unless">Using Both <code>:if</code> and <code>:unless</code></a></li>
</ul></li>
<li><a href="#skipping-callbacks">Skipping Callbacks</a></li>
<li><a href="#suppressing-callbacks">Suppressing Callbacks</a></li>
<li><a href="#halting-execution">Halting Execution</a></li>
<li><a href="#association-callbacks">Association Callbacks</a></li>
<li><a href="#cascading-association-callbacks">Cascading Association Callbacks</a></li>
<li><a href="#transaction-callbacks">Transaction Callbacks</a>

<ul>
<li><a href="#after-commit-and-after-rollback"><code>after_commit</code> and <code>after_rollback</code></a></li>
<li><a href="#aliases-for-after-commit">Aliases for <code>after_commit</code></a></li>
<li><a href="#transactional-callback-ordering">Transactional Callback Ordering</a></li>
</ul></li>
<li><a href="#callback-objects">Callback Objects</a></li>
</ol>

          </nav>


      <hr>
    </div>
  </section>

  <main id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h2 id="the-object-life-cycle"><a class="anchorlink" href="#the-object-life-cycle"><span>1</span> The Object Life Cycle</a></h2><p>During the normal operation of a Rails application, objects may be <a href="active_record_basics.html#crud-reading-and-writing-data">created,
updated, and
destroyed</a>. Active
Record provides hooks into this object life cycle so that you can control your
application and its data.</p><p>Callbacks allow you to trigger logic before or after a change to an object's
state. They are methods that get called at certain moments of an object's life
cycle. With callbacks it is possible to write code that will run whenever an
Active Record object is initialized, created, saved, updated, deleted,
validated, or loaded from the database.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">BirthdayCake</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Congratulations, the callback has run!"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class BirthdayCake < ApplicationRecord
  after_create -> { Rails.logger.info(&quot;Congratulations, the callback has run!&quot;) }
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">BirthdayCake</span><span class="p">.</span><span class="nf">create</span>
<span class="go">Congratulations, the callback has run!
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="BirthdayCake.create
">Copy</button>
</div>
<p>As you will see, there are many life cycle events and multiple options to hook
into these — either before, after, or even around them.</p><h2 id="callback-registration"><a class="anchorlink" href="#callback-registration"><span>2</span> Callback Registration</a></h2><p>To use the available callbacks, you need to implement and register them.
Implementation can be done in a multitude of ways like using ordinary methods,
blocks and procs, or defining custom callback objects using classes or modules.
Let's go through each of these implementation techniques.</p><p>You can register the callbacks with a <strong>macro-style class method that calls an
ordinary method</strong> for implementation.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="ss">:ensure_username_has_value</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">ensure_username_has_value</span>
      <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :username, :email, presence: true

  before_validation :ensure_username_has_value

  private
    def ensure_username_has_value
      if username.blank?
        self.username = email
      end
    end
end
">Copy</button>
</div>
<p>The <strong>macro-style class methods can also receive a block</strong>. Consider using this
style if the code inside your block is so short that it fits in a single line:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span> <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :username, :email, presence: true

  before_validation do
    self.username = email if username.blank?
  end
end
">Copy</button>
</div>
<p>Alternatively, you can <strong>pass a proc to the callback</strong> to be triggered.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">email</span> <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">username</span><span class="p">.</span><span class="nf">blank?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :username, :email, presence: true

  before_validation ->(user) { user.username = user.email if user.username.blank? }
end
">Copy</button>
</div>
<p>Lastly, you can define <a href="#callback-objects"><strong>a custom callback object</strong></a>, as
shown below. We will cover these later in more detail.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="no">AddUsername</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AddUsername</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">before_validation</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">username</span><span class="p">.</span><span class="nf">blank?</span>
      <span class="n">record</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :username, :email, presence: true

  before_validation AddUsername
end

class AddUsername
  def self.before_validation(record)
    if record.username.blank?
      record.username = record.email
    end
  end
end
">Copy</button>
</div>
<h3 id="registering-callbacks-to-fire-on-life-cycle-events"><a class="anchorlink" href="#registering-callbacks-to-fire-on-life-cycle-events"><span>2.1</span> Registering Callbacks to Fire on Life Cycle Events</a></h3><p>Callbacks can also be registered to only fire on certain life cycle events, this
can be done using the <code>:on</code> option and allows complete control over when and in
what context your callbacks are triggered.</p><div class="interstitial note"><p>A context is like a category or a scenario in which you want certain
validations to apply. When you validate an ActiveRecord model, you can specify a
context to group validations. This allows you to have different sets of
validations that apply in different situations. In Rails, there are certain
default contexts for validations like :create, :update, and :save.</p></div><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="ss">:ensure_username_has_value</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="c1"># :on takes an array as well</span>
  <span class="n">after_validation</span> <span class="ss">:set_location</span><span class="p">,</span> <span class="ss">on: </span><span class="p">[</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span> <span class="p">]</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">ensure_username_has_value</span>
      <span class="k">if</span> <span class="n">username</span><span class="p">.</span><span class="nf">blank?</span>
        <span class="nb">self</span><span class="p">.</span><span class="nf">username</span> <span class="o">=</span> <span class="n">email</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">set_location</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">location</span> <span class="o">=</span> <span class="no">LocationService</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :username, :email, presence: true

  before_validation :ensure_username_has_value, on: :create

  # :on takes an array as well
  after_validation :set_location, on: [ :create, :update ]

  private
    def ensure_username_has_value
      if username.blank?
        self.username = email
      end
    end

    def set_location
      self.location = LocationService.query(self)
    end
end
">Copy</button>
</div>
<div class="interstitial note"><p>It is considered good practice to declare callback methods as private. If
left public, they can be called from outside of the model and violate the
principle of object encapsulation.</p></div><div class="interstitial warning"><p>Refrain from using methods like <code>update</code>, <code>save</code>, or any other methods
that cause side effects on the object within your callback methods. <br><br>
For instance, avoid calling <code>update(attribute: "value")</code> inside a callback. This
practice can modify the model's state and potentially lead to unforeseen side
effects during commit. <br><br> Instead, you can assign values directly (e.g.,
<code>self.attribute = "value"</code>) in <code>before_create</code>, <code>before_update</code>, or earlier
callbacks for a safer approach.</p></div><h2 id="available-callbacks"><a class="anchorlink" href="#available-callbacks"><span>3</span> Available Callbacks</a></h2><p>Here is a list with all the available Active Record callbacks, listed <strong>in the
order in which they will get called</strong> during the respective operations:</p><h3 id="creating-an-object"><a class="anchorlink" href="#creating-an-object"><span>3.1</span> Creating an Object</a></h3>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_create"><code>before_create</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_create"><code>around_create</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_create"><code>after_create</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>
<p>See the <a href="active_record_callbacks.html#after-commit-and-after-rollback"><code>after_commit</code> / <code>after_rollback</code>
section</a> for
examples using these two callbacks.</p><p>There are examples below that show how to use these callbacks. We've grouped
them by the operation they are associated with, and lastly show how they can be
used in combination.</p><h4 id="validation-callbacks"><a class="anchorlink" href="#validation-callbacks"><span>3.1.1</span> Validation Callbacks</a></h4><p>Validation callbacks are triggered whenever the record is validated directly via
the
<a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-valid-3F"><code>valid?</code></a>
( or its alias
<a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-validate"><code>validate</code></a>)
or
<a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-invalid-3F"><code>invalid?</code></a>
method, or indirectly via <code>create</code>, <code>update</code>, or <code>save</code>. They are called before
and after the validation phase.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">before_validation</span> <span class="ss">:titleize_name</span>
  <span class="n">after_validation</span> <span class="ss">:log_errors</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">titleize_name</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">.</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">titleize</span> <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">present?</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Name titleized to </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_errors</span>
      <span class="k">if</span> <span class="n">errors</span><span class="p">.</span><span class="nf">any?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">"Validation failed: </span><span class="si">#{</span><span class="n">errors</span><span class="p">.</span><span class="nf">full_messages</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  validates :name, presence: true
  before_validation :titleize_name
  after_validation :log_errors

  private
    def titleize_name
      self.name = name.downcase.titleize if name.present?
      Rails.logger.info(&quot;Name titleized to #{name}&quot;)
    end

    def log_errors
      if errors.any?
        Rails.logger.error(&quot;Validation failed: #{errors.full_messages.join(', ')}&quot;)
      end
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">""</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"abc123456"</span><span class="p">)</span>
<span class="gp">=&gt; #&lt;User id: nil, email: "john.doe@example.com", created_at: nil, updated_at: nil, name: ""&gt;</span><span class="w">
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">Name titleized to
Validation failed: Name can't be blank
</span><span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.new(name: &quot;&quot;, email: &quot;john.doe@example.com&quot;, password: &quot;abc123456&quot;)
user.valid?
">Copy</button>
</div>
<h4 id="save-callbacks"><a class="anchorlink" href="#save-callbacks"><span>3.1.2</span> Save Callbacks</a></h4><p>Save callbacks are triggered whenever the record is persisted (i.e. "saved") to
the underlying database, via the <code>create</code>, <code>update</code>, or <code>save</code> methods. They are
called before, after, and around the object is saved.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:hash_password</span>
  <span class="n">around_save</span> <span class="ss">:log_saving</span>
  <span class="n">after_save</span> <span class="ss">:update_cache</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">hash_password</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">password_digest</span> <span class="o">=</span> <span class="no">BCrypt</span><span class="o">::</span><span class="no">Password</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Password hashed for user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_saving</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Saving user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User saved with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update_cache</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">write</span><span class="p">([</span><span class="s2">"user_data"</span><span class="p">,</span> <span class="nb">self</span><span class="p">],</span> <span class="n">attributes</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Update Cache"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  before_save :hash_password
  around_save :log_saving
  after_save :update_cache

  private
    def hash_password
      self.password_digest = BCrypt::Password.create(password)
      Rails.logger.info(&quot;Password hashed for user with email: #{email}&quot;)
    end

    def log_saving
      Rails.logger.info(&quot;Saving user with email: #{email}&quot;)
      yield
      Rails.logger.info(&quot;User saved with email: #{email}&quot;)
    end

    def update_cache
      Rails.cache.write([&quot;user_data&quot;, self], attributes)
      Rails.logger.info(&quot;Update Cache&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Jane Doe"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"password"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"jane.doe@example.com"</span><span class="p">)</span>
<span class="err">
</span><span class="go">Password hashed for user with email: jane.doe@example.com
Saving user with email: jane.doe@example.com
User saved with email: jane.doe@example.com
Update Cache
</span><span class="gp">=&gt; #&lt;User id: 1, email: "jane.doe@example.com", created_at: "2024-03-20 16:02:43.685500000 +0000", updated_at: "2024-03-20 16:02:43.685500000 +0000", name: "Jane Doe"&gt;</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create(name: &quot;Jane Doe&quot;, password: &quot;password&quot;, email: &quot;jane.doe@example.com&quot;)
">Copy</button>
</div>
<h4 id="create-callbacks"><a class="anchorlink" href="#create-callbacks"><span>3.1.3</span> Create Callbacks</a></h4><p>Create callbacks are triggered whenever the record is persisted (i.e. "saved")
to the underlying database <strong>for the first time</strong> — in other words, when we're
saving a new record, via the <code>create</code> or <code>save</code> methods. They are called before,
after and around the object is created.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_create</span> <span class="ss">:set_default_role</span>
  <span class="n">around_create</span> <span class="ss">:log_creation</span>
  <span class="n">after_create</span> <span class="ss">:send_welcome_email</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">set_default_role</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">role</span> <span class="o">=</span> <span class="s2">"user"</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User role set to default: user"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_creation</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Creating user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User created with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">send_welcome_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User welcome email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  before_create :set_default_role
  around_create :log_creation
  after_create :send_welcome_email

  private
    def set_default_role
      self.role = &quot;user&quot;
      Rails.logger.info(&quot;User role set to default: user&quot;)
    end

    def log_creation
      Rails.logger.info(&quot;Creating user with email: #{email}&quot;)
      yield
      Rails.logger.info(&quot;User created with email: #{email}&quot;)
    end

    def send_welcome_email
      UserMailer.welcome_email(self).deliver_later
      Rails.logger.info(&quot;User welcome email sent to: #{email}&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">)</span>
<span class="err">
</span><span class="go">User role set to default: user
Creating user with email: john.doe@example.com
User created with email: john.doe@example.com
User welcome email sent to: john.doe@example.com
</span><span class="gp">=&gt; #&lt;User id: 10, email: "john.doe@example.com", created_at: "2024-03-20 16:19:52.405195000 +0000", updated_at: "2024-03-20 16:19:52.405195000 +0000", name: "John Doe"&gt;</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create(name: &quot;John Doe&quot;, email: &quot;john.doe@example.com&quot;)
">Copy</button>
</div>
<h3 id="updating-an-object"><a class="anchorlink" href="#updating-an-object"><span>3.2</span> Updating an Object</a></h3><p>Update callbacks are triggered whenever an <strong>existing</strong> record is persisted
(i.e. "saved") to the underlying database. They are called before, after and
around the object is updated.</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-before_validation"><code>before_validation</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveModel/Validations/Callbacks/ClassMethods.html#method-i-after_validation"><code>after_validation</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_save"><code>before_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_save"><code>around_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_update"><code>before_update</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_update"><code>around_update</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_update"><code>after_update</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_save"><code>after_save</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>
<div class="interstitial warning"><p>The <code>after_save</code> callback is triggered on both create and update
operations. However, it consistently executes after the more specific callbacks
<code>after_create</code> and <code>after_update</code>, regardless of the sequence in which the macro
calls were made. Similarly, before and around save callbacks follow the same
rule: <code>before_save</code> runs before create/update, and <code>around_save</code> runs around
create/update operations. It's important to note that save callbacks will always
run before/around/after the more specific create/update callbacks.</p></div><p>We've already covered <a href="#validation-callbacks">validation</a> and
<a href="#save-callbacks">save</a> callbacks. See the <a href="#after-commit-and-after-rollback"><code>after_commit</code> /
<code>after_rollback</code> section</a> for examples using
these two callbacks.</p><h4 id="update-callbacks"><a class="anchorlink" href="#update-callbacks"><span>3.2.1</span> Update Callbacks</a></h4><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_update</span> <span class="ss">:check_role_change</span>
  <span class="n">around_update</span> <span class="ss">:log_updating</span>
  <span class="n">after_update</span> <span class="ss">:send_update_email</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_role_change</span>
      <span class="k">if</span> <span class="n">role_changed?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User role changed to </span><span class="si">#{</span><span class="n">role</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_updating</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Updating user with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User updated with email: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">send_update_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">update_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Update email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  before_update :check_role_change
  around_update :log_updating
  after_update :send_update_email

  private
    def check_role_change
      if role_changed?
        Rails.logger.info(&quot;User role changed to #{role}&quot;)
      end
    end

    def log_updating
      Rails.logger.info(&quot;Updating user with email: #{email}&quot;)
      yield
      Rails.logger.info(&quot;User updated with email: #{email}&quot;)
    end

    def send_update_email
      UserMailer.update_email(self).deliver_later
      Rails.logger.info(&quot;Update email sent to: #{email}&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2024-03-20 16:19:52.405195000 +0000"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">role: </span><span class="s2">"user"</span> <span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">role: </span><span class="s2">"admin"</span><span class="p">)</span>
<span class="go">User role changed to admin
Updating user with email: john.doe@example.com
User updated with email: john.doe@example.com
Update email sent to: john.doe@example.com
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.find(1)
user.update(role: &quot;admin&quot;)
">Copy</button>
</div>
<h4 id="using-a-combination-of-callbacks"><a class="anchorlink" href="#using-a-combination-of-callbacks"><span>3.2.2</span> Using a Combination of Callbacks</a></h4><p>Often, you will need to use a combination of callbacks to achieve the desired
behavior. For example, you may want to send a confirmation email after a user is
created, but only if the user is new and not being updated. When a user is
updated, you may want to notify an admin if critical information is changed. In
this case, you can use <code>after_create</code> and <code>after_update</code> callbacks together.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="ss">:send_confirmation_email</span>
  <span class="n">after_update</span> <span class="ss">:notify_admin_if_critical_info_updated</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">send_confirmation_email</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">confirmation_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Confirmation email sent to: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">notify_admin_if_critical_info_updated</span>
      <span class="k">if</span> <span class="n">saved_change_to_email?</span> <span class="o">||</span> <span class="n">saved_change_to_phone_number?</span>
        <span class="no">AdminMailer</span><span class="p">.</span><span class="nf">user_critical_info_updated</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Notification sent to admin about critical info update for: </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_create :send_confirmation_email
  after_update :notify_admin_if_critical_info_updated

  private
    def send_confirmation_email
      UserMailer.confirmation_email(self).deliver_later
      Rails.logger.info(&quot;Confirmation email sent to: #{email}&quot;)
    end

    def notify_admin_if_critical_info_updated
      if saved_change_to_email? || saved_change_to_phone_number?
        AdminMailer.user_critical_info_updated(self).deliver_later
        Rails.logger.info(&quot;Notification sent to admin about critical info update for: #{email}&quot;)
      end
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">)</span>
<span class="go">Confirmation email sent to: john.doe@example.com
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"john.doe@example.com"</span><span class="p">,</span> <span class="o">...</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">email: </span><span class="s2">"john.doe.new@example.com"</span><span class="p">)</span>
<span class="go">Notification sent to admin about critical info update for: john.doe.new@example.com
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create(name: &quot;John Doe&quot;, email: &quot;john.doe@example.com&quot;)
user.update(email: &quot;john.doe.new@example.com&quot;)
">Copy</button>
</div>
<h3 id="destroying-an-object"><a class="anchorlink" href="#destroying-an-object"><span>3.3</span> Destroying an Object</a></h3><p>Destroy callbacks are triggered whenever a record is destroyed, but ignored when
a record is deleted. They are called before, after and around the object is
destroyed.</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-before_destroy"><code>before_destroy</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-around_destroy"><code>around_destroy</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_destroy"><code>after_destroy</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> / <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a></li>
</ul>
<p>Find <a href="#after-commit-and-after-rollback">examples for using <code>after_commit</code> /
<code>after_rollback</code></a>.</p><h4 id="destroy-callbacks"><a class="anchorlink" href="#destroy-callbacks"><span>3.3.1</span> Destroy Callbacks</a></h4><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_destroy</span> <span class="ss">:check_admin_count</span>
  <span class="n">around_destroy</span> <span class="ss">:log_destroy_operation</span>
  <span class="n">after_destroy</span> <span class="ss">:notify_users</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_admin_count</span>
      <span class="k">if</span> <span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">role: </span><span class="s2">"admin"</span><span class="p">).</span><span class="nf">count</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="kp">throw</span> <span class="ss">:abort</span>
      <span class="k">end</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Checked the admin count"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">log_destroy_operation</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"About to destroy user with ID </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">yield</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User with ID </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> destroyed successfully"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">notify_users</span>
      <span class="no">UserMailer</span><span class="p">.</span><span class="nf">deletion_email</span><span class="p">(</span><span class="nb">self</span><span class="p">).</span><span class="nf">deliver_later</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Notification sent to other users about user deletion"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  before_destroy :check_admin_count
  around_destroy :log_destroy_operation
  after_destroy :notify_users

  private
    def check_admin_count
      if admin? &amp;&amp; User.where(role: &quot;admin&quot;).count == 1
        throw :abort
      end
      Rails.logger.info(&quot;Checked the admin count&quot;)
    end

    def log_destroy_operation
      Rails.logger.info(&quot;About to destroy user with ID #{id}&quot;)
      yield
      Rails.logger.info(&quot;User with ID #{id} destroyed successfully&quot;)
    end

    def notify_users
      UserMailer.deletion_email(self).deliver_later
      Rails.logger.info(&quot;Notification sent to other users about user deletion&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">=&gt; #&lt;User id: 1, email: "john.doe@example.com", created_at: "2024-03-20 16:19:52.405195000 +0000", updated_at: "2024-03-20 16:19:52.405195000 +0000", name: "John Doe", role: "admin"&gt;</span><span class="w">
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="go">Checked the admin count
About to destroy user with ID 1
User with ID 1 destroyed successfully
Notification sent to other users about user deletion
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.find(1)
user.destroy
">Copy</button>
</div>
<h3 id="after-initialize-and-after-find"><a class="anchorlink" href="#after-initialize-and-after-find"><span>3.4</span> <code>after_initialize</code> and <code>after_find</code></a></h3><p>Whenever an Active Record object is instantiated, either by directly using <code>new</code>
or when a record is loaded from the database, the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_initialize"><code>after_initialize</code></a>
callback will be called. It can be useful to avoid the need to directly override
your Active Record <code>initialize</code> method.</p><p>When loading a record from the database the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_find"><code>after_find</code></a> callback will be
called. <code>after_find</code> is called before <code>after_initialize</code> if both are defined.</p><div class="interstitial note"><p>The <code>after_initialize</code> and <code>after_find</code> callbacks have no <code>before_*</code>
counterparts.</p></div><p>They can be registered just like the other Active Record callbacks.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_initialize</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have initialized an object!"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">after_find</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have found an object!"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_initialize do |user|
    Rails.logger.info(&quot;You have initialized an object!&quot;)
  end

  after_find do |user|
    Rails.logger.info(&quot;You have found an object!&quot;)
  end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="go">You have initialized an object!
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="kp">nil</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="go">You have found an object!
You have initialized an object!
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="User.new
User.first
">Copy</button>
</div>
<h3 id="after-touch"><a class="anchorlink" href="#after-touch"><span>3.5</span> <code>after_touch</code></a></h3><p>The <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Callbacks/ClassMethods.html#method-i-after_touch"><code>after_touch</code></a> callback will be called whenever an Active Record object
is touched. You can <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-touch">read more about <code>touch</code> in the API
docs</a>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_touch</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"You have touched an object"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_touch do |user|
    Rails.logger.info(&quot;You have touched an object&quot;)
  end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Kuldeep"</span><span class="p">)</span>
<span class="gp">=&gt; #&lt;User id: 1, name: "Kuldeep", created_at: "2013-11-25 12:17:49", updated_at: "2013-11-25 12:17:49"&gt;</span><span class="w">
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">touch</span>
<span class="go">You have touched an object
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create(name: &quot;Kuldeep&quot;)
user.touch
">Copy</button>
</div>
<p>It can be used along with <code>belongs_to</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:library</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
  <span class="n">after_touch</span> <span class="k">do</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"A Book was touched"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Library</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">after_touch</span> <span class="ss">:log_when_books_or_library_touched</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_when_books_or_library_touched</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book/Library was touched"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book < ApplicationRecord
  belongs_to :library, touch: true
  after_touch do
    Rails.logger.info(&quot;A Book was touched&quot;)
  end
end

class Library < ApplicationRecord
  has_many :books
  after_touch :log_when_books_or_library_touched

  private
    def log_when_books_or_library_touched
      Rails.logger.info(&quot;Book/Library was touched&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">last</span>
<span class="gp">=&gt; #&lt;Book id: 1, library_id: 1, created_at: "2013-11-25 17:04:22", updated_at: "2013-11-25 17:05:05"&gt;</span><span class="w">
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">touch</span> <span class="c1"># triggers book.library.touch</span>
<span class="go">A Book was touched
Book/Library was touched
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="book = Book.last
book.touch # triggers book.library.touch
">Copy</button>
</div>
<h2 id="running-callbacks"><a class="anchorlink" href="#running-callbacks"><span>4</span> Running Callbacks</a></h2><p>The following methods trigger callbacks:</p>
<ul>
<li><code>create</code></li>
<li><code>create!</code></li>
<li><code>destroy</code></li>
<li><code>destroy!</code></li>
<li><code>destroy_all</code></li>
<li><code>destroy_by</code></li>
<li><code>save</code></li>
<li><code>save!</code></li>
<li><code>save(validate: false)</code></li>
<li><code>save!(validate: false)</code></li>
<li><code>toggle!</code></li>
<li><code>touch</code></li>
<li><code>update_attribute</code></li>
<li><code>update_attribute!</code></li>
<li><code>update</code></li>
<li><code>update!</code></li>
<li><code>valid?</code></li>
<li><code>validate</code></li>
</ul>
<p>Additionally, the <code>after_find</code> callback is triggered by the following finder
methods:</p>
<ul>
<li><code>all</code></li>
<li><code>first</code></li>
<li><code>find</code></li>
<li><code>find_by</code></li>
<li><code>find_by!</code></li>
<li><code>find_by_*</code></li>
<li><code>find_by_*!</code></li>
<li><code>find_by_sql</code></li>
<li><code>last</code></li>
<li><code>sole</code></li>
<li><code>take</code></li>
</ul>
<p>The <code>after_initialize</code> callback is triggered every time a new object of the
class is initialized.</p><div class="interstitial note"><p>The <code>find_by_*</code> and <code>find_by_*!</code> methods are dynamic finders generated
automatically for every attribute. Learn more about them in the <a href="active_record_querying.html#dynamic-finders">Dynamic finders
section</a>.</p></div><h2 id="conditional-callbacks"><a class="anchorlink" href="#conditional-callbacks"><span>5</span> Conditional Callbacks</a></h2><p>As with <a href="active_record_validations.html">validations</a>, we can also make the
calling of a callback method conditional on the satisfaction of a given
predicate. We can do this using the <code>:if</code> and <code>:unless</code> options, which can take
a symbol, a <code>Proc</code> or an <code>Array</code>.</p><p>You may use the <code>:if</code> option when you want to specify under which conditions the
callback <strong>should</strong> be called. If you want to specify the conditions under which
the callback <strong>should not</strong> be called, then you may use the <code>:unless</code> option.</p><h3 id="using-if-and-unless-with-a-symbol"><a class="anchorlink" href="#using-if-and-unless-with-a-symbol"><span>5.1</span> Using <code>:if</code> and <code>:unless</code> with a <code>Symbol</code></a></h3><p>You can associate the <code>:if</code> and <code>:unless</code> options with a symbol corresponding to
the name of a predicate method that will get called right before the callback.</p><p>When using the <code>:if</code> option, the callback <strong>won't</strong> be executed if the predicate
method returns <strong>false</strong>; when using the <code>:unless</code> option, the callback
<strong>won't</strong> be executed if the predicate method returns <strong>true</strong>. This is the most
common option.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span> <span class="ss">if: :paid_with_card?</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order < ApplicationRecord
  before_save :normalize_card_number, if: :paid_with_card?
end
">Copy</button>
</div>
<p>Using this form of registration it is also possible to register several
different predicates that should be called to check if the callback should be
executed. We will cover this in the <a href="#multiple-callback-conditions">Multiple Callback Conditions
section</a>.</p><h3 id="using-if-and-unless-with-a-proc"><a class="anchorlink" href="#using-if-and-unless-with-a-proc"><span>5.2</span> Using <code>:if</code> and <code>:unless</code> with a <code>Proc</code></a></h3><p>It is possible to associate <code>:if</code> and <code>:unless</code> with a <code>Proc</code> object. This
option is best suited when writing short validation methods, usually one-liners:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span>
    <span class="ss">if: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="p">{</span> <span class="n">order</span><span class="p">.</span><span class="nf">paid_with_card?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order < ApplicationRecord
  before_save :normalize_card_number,
    if: ->(order) { order.paid_with_card? }
end
">Copy</button>
</div>
<p>Since the proc is evaluated in the context of the object, it is also possible to
write this as:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:normalize_card_number</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">paid_with_card?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order < ApplicationRecord
  before_save :normalize_card_number, if: -> { paid_with_card? }
end
">Copy</button>
</div>
<h3 id="multiple-callback-conditions"><a class="anchorlink" href="#multiple-callback-conditions"><span>5.3</span> Multiple Callback Conditions</a></h3><p>The <code>:if</code> and <code>:unless</code> options also accept an array of procs or method names as
symbols:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="p">[</span><span class="ss">:subject_to_parental_control?</span><span class="p">,</span> <span class="ss">:untrusted_author?</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Comment < ApplicationRecord
  before_save :filter_content,
    if: [:subject_to_parental_control?, :untrusted_author?]
end
">Copy</button>
</div>
<p>You can easily include a proc in the list of conditions:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="p">[</span><span class="ss">:subject_to_parental_control?</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">untrusted_author?</span> <span class="p">}]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Comment < ApplicationRecord
  before_save :filter_content,
    if: [:subject_to_parental_control?, -> { untrusted_author? }]
end
">Copy</button>
</div>
<h3 id="using-both-if-and-unless"><a class="anchorlink" href="#using-both-if-and-unless"><span>5.4</span> Using Both <code>:if</code> and <code>:unless</code></a></h3><p>Callbacks can mix both <code>:if</code> and <code>:unless</code> in the same declaration:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:filter_content</span><span class="p">,</span>
    <span class="ss">if: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">forum</span><span class="p">.</span><span class="nf">parental_control?</span> <span class="p">},</span>
    <span class="ss">unless: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="n">author</span><span class="p">.</span><span class="nf">trusted?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Comment < ApplicationRecord
  before_save :filter_content,
    if: -> { forum.parental_control? },
    unless: -> { author.trusted? }
end
">Copy</button>
</div>
<p>The callback only runs when all the <code>:if</code> conditions and none of the <code>:unless</code>
conditions are evaluated to <code>true</code>.</p><h2 id="skipping-callbacks"><a class="anchorlink" href="#skipping-callbacks"><span>6</span> Skipping Callbacks</a></h2><p>Just as with <a href="active_record_validations.html">validations</a>, it is also possible
to skip callbacks by using the following methods:</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-decrement-21"><code>decrement!</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-decrement_counter"><code>decrement_counter</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-delete"><code>delete</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_all"><code>delete_all</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-delete_by"><code>delete_by</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-increment-21"><code>increment!</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-increment_counter"><code>increment_counter</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert"><code>insert</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert-21"><code>insert!</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert_all"><code>insert_all</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-insert_all-21"><code>insert_all!</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-touch_all"><code>touch_all</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_column"><code>update_column</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-update_columns"><code>update_columns</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_all"><code>update_all</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_counters"><code>update_counters</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-upsert"><code>upsert</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence/ClassMethods.html#method-i-upsert_all"><code>upsert_all</code></a></li>
</ul>
<p>Let's consider a <code>User</code> model where the <code>before_save</code> callback logs any changes
to the user's email address:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="ss">:log_email_change</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_email_change</span>
      <span class="k">if</span> <span class="n">email_changed?</span>
        <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Email changed from </span><span class="si">#{</span><span class="n">email_was</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  before_save :log_email_change

  private
    def log_email_change
      if email_changed?
        Rails.logger.info(&quot;Email changed from #{email_was} to #{email}&quot;)
      end
    end
end
">Copy</button>
</div>
<p>Now, suppose there's a scenario where you want to update the user's email
address without triggering the <code>before_save</code> callback to log the email change.
You can use the <code>update_columns</code> method for this purpose:</p><div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">update_columns</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'new_email@example.com'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.find(1)
user.update_columns(email: 'new_email@example.com')
">Copy</button>
</div>
<p>The above will update the user's email address without triggering the
<code>before_save</code> callback.</p><div class="interstitial warning"><p>These methods should be used with caution because there may be
important business rules and application logic in callbacks that you do not want
to bypass. Bypassing them without understanding the potential implications may
lead to invalid data.</p></div><h2 id="suppressing-callbacks"><a class="anchorlink" href="#suppressing-callbacks"><span>7</span> Suppressing Callbacks</a></h2><p>In certain scenarios, you may need to temporarily prevent certain callbacks from
being executed within your Rails application. This can be useful when you want
to skip specific actions during certain operations without permanently disabling
the callbacks.</p><p>Rails provides a mechanism for suppressing callbacks using the
<a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Suppressor.html"><code>ActiveRecord::Suppressor</code>
module</a>. By
using this module, you can wrap a block of code where you want to suppress
callbacks, ensuring that they are not executed during that specific operation.</p><p>Let's consider a scenario where we have a <code>User</code> model with a callback that
sends a welcome email to new users after they sign up. However, there might be
cases where we want to create a user without sending the welcome email, such as
during seeding the database with test data.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create</span> <span class="ss">:send_welcome_email</span>

  <span class="k">def</span> <span class="nf">send_welcome_email</span>
    <span class="nb">puts</span> <span class="s2">"Welcome email sent to </span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_create :send_welcome_email

  def send_welcome_email
    puts &quot;Welcome email sent to #{self.email}&quot;
  end
end
">Copy</button>
</div>
<p>In this example, the <code>after_create</code> callback triggers the <code>send_welcome_email</code>
method every time a new user is created.</p><p>To create a user without sending the welcome email, we can use the
<code>ActiveRecord::Suppressor</code> module as follows:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">suppress</span> <span class="k">do</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Jane"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"jane@example.com"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="User.suppress do
  User.create(name: &quot;Jane&quot;, email: &quot;jane@example.com&quot;)
end
">Copy</button>
</div>
<p>In the above code, the <code>User.suppress</code> block ensures that the
<code>send_welcome_email</code> callback is not executed during the creation of the "Jane"
user, allowing us to create the user without sending the welcome email.</p><div class="interstitial warning"><p>Using the Active Record Suppressor, while potentially beneficial for
selectively controlling callback execution, can introduce complexity and
unexpected behavior. Suppressing callbacks can obscure the intended flow of your
application, leading to difficulties in understanding and maintaining the
codebase over time. Carefully consider the implications of suppressing
callbacks, ensuring thorough documentation and thoughtful testing to mitigate
risks of unintended side effects, performance issues, and test failures.</p></div><h2 id="halting-execution"><a class="anchorlink" href="#halting-execution"><span>8</span> Halting Execution</a></h2><p>As you start registering new callbacks for your models, they will be queued for
execution. This queue will include all of your model's validations, the
registered callbacks, and the database operation to be executed.</p><p>The whole callback chain is wrapped in a transaction. If any callback raises an
exception, the execution chain gets halted and a <strong>rollback</strong> is issued, and the
error will be re-raised.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="k">raise</span> <span class="s2">"Price can't be negative"</span> <span class="k">if</span> <span class="n">total_price</span> <span class="o">&lt;</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># raises "Price can't be negative"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Product < ActiveRecord::Base
  before_validation do
    raise &quot;Price can't be negative&quot; if total_price < 0
  end
end

Product.create # raises &quot;Price can't be negative&quot;
">Copy</button>
</div>
<p>This unexpectedly breaks code that does not expect methods like <code>create</code> and
<code>save</code> to raise exceptions.</p><div class="interstitial note"><p>If an exception occurs during the callback chain, Rails will re-raise it
unless it is an <code>ActiveRecord::Rollback</code> or <code>ActiveRecord::RecordInvalid</code>
exception. Instead, you should use <code>throw :abort</code> to intentionally halt the
chain. If any callback throws <code>:abort</code>, the process will be aborted and <code>create</code>
will return false.</p></div><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_validation</span> <span class="k">do</span>
    <span class="kp">throw</span> <span class="ss">:abort</span> <span class="k">if</span> <span class="n">total_price</span> <span class="o">&lt;</span> <span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Product</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># =&gt; false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Product < ActiveRecord::Base
  before_validation do
    throw :abort if total_price < 0
  end
end

Product.create # => false
">Copy</button>
</div>
<p>However, it will raise an <code>ActiveRecord::RecordNotSaved</code> when calling <code>create!</code>.
This exception indicates that the record was not saved due to the callback's
interruption.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="c1"># =&gt; raises an ActiveRecord::RecordNotSaved</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="User.create! # => raises an ActiveRecord::RecordNotSaved
">Copy</button>
</div>
<p>When <code>throw :abort</code> is called in any destroy callback, <code>destroy</code> will return
false:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_destroy</span> <span class="k">do</span>
    <span class="kp">throw</span> <span class="ss">:abort</span> <span class="k">if</span> <span class="n">still_active?</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">destroy</span> <span class="c1"># =&gt; false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ActiveRecord::Base
  before_destroy do
    throw :abort if still_active?
  end
end

User.first.destroy # => false
">Copy</button>
</div>
<p>However, it will raise an <code>ActiveRecord::RecordNotDestroyed</code> when calling
<code>destroy!</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">destroy!</span> <span class="c1"># =&gt; raises an ActiveRecord::RecordNotDestroyed</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="User.first.destroy! # => raises an ActiveRecord::RecordNotDestroyed
">Copy</button>
</div>
<h2 id="association-callbacks"><a class="anchorlink" href="#association-callbacks"><span>9</span> Association Callbacks</a></h2><p>Association callbacks are similar to normal callbacks, but they are triggered by
events in the life cycle of the associated collection. There are four available
association callbacks:</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>You can define association callbacks by adding options to the association.</p><p>Suppose you have an example where an author can have many books. However, before
adding a book to the authors collection, you want to ensure that the author has
not reached their book limit. You can do this by adding a <code>before_add</code> callback
to check the limit.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_limit</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">check_limit</span><span class="p">(</span><span class="n">_book</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">books</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="mi">5</span>
        <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">"Cannot add more than 5 books for this author"</span><span class="p">)</span>
        <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, before_add: :check_limit

  private
    def check_limit(_book)
      if books.count >= 5
        errors.add(:base, &quot;Cannot add more than 5 books for this author&quot;)
        throw(:abort)
      end
    end
end
">Copy</button>
</div>
<p>If a <code>before_add</code> callback throws <code>:abort</code>, the object does not get added to the
collection.</p><p>At times you may want to perform multiple actions on the associated object. In
this case, you can stack callbacks on a single event by passing them as an
array. Additionally, Rails passes the object being added or removed to the
callback for you to use.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_limit</span><span class="p">(</span><span class="n">_book</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">books</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="mi">5</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="s2">"Cannot add more than 5 books for this author"</span><span class="p">)</span>
      <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="n">weight_in_pounds</span> <span class="o">=</span> <span class="n">book</span><span class="p">.</span><span class="nf">weight_in_pounds</span> <span class="o">||</span> <span class="mi">1</span>
    <span class="n">shipping_charges</span> <span class="o">=</span> <span class="n">weight_in_pounds</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">shipping_charges</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author < ApplicationRecord
  has_many :books, before_add: [:check_limit, :calculate_shipping_charges]

  def check_limit(_book)
    if books.count >= 5
      errors.add(:base, &quot;Cannot add more than 5 books for this author&quot;)
      throw(:abort)
    end
  end

  def calculate_shipping_charges(book)
    weight_in_pounds = book.weight_in_pounds || 1
    shipping_charges = weight_in_pounds * 2

    shipping_charges
  end
end
">Copy</button>
</div>
<p>Similarly, if a <code>before_remove</code> callback throws <code>:abort</code>, the object does not
get removed from the collection.</p><div class="interstitial note"><p>These callbacks are called only when the associated objects are added or
removed through the association collection.</p></div><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># Triggers `before_add` callback</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># Does not trigger the `before_add` callback</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Triggers `before_add` callback
author.books << book
author.books = [book, book2]

# Does not trigger the `before_add` callback
book.update(author_id: 1)
">Copy</button>
</div>
<h2 id="cascading-association-callbacks"><a class="anchorlink" href="#cascading-association-callbacks"><span>10</span> Cascading Association Callbacks</a></h2><p>Callbacks can be performed when associated objects are changed. They work
through the model associations whereby life cycle events can cascade on
associations and fire callbacks.</p><p>Suppose an example where a user has many articles. A user's articles should be
destroyed if the user is destroyed. Let's add an <code>after_destroy</code> callback to the
<code>User</code> model by way of its association to the <code>Article</code> model:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy</span> <span class="ss">:log_destroy_action</span>

  <span class="k">def</span> <span class="nf">log_destroy_action</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Article destroyed"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  has_many :articles, dependent: :destroy
end

class Article < ApplicationRecord
  after_destroy :log_destroy_action

  def log_destroy_action
    Rails.logger.info(&quot;Article destroyed&quot;)
  end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">create!</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">user_id: </span><span class="mi">1</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="go">Article destroyed
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">User</span> <span class="ss">id: </span><span class="mi">1</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.first
user.articles.create!
user.destroy
">Copy</button>
</div>
<div class="interstitial warning"><p>When using a <code>before_destroy</code> callback, it should be placed before
<code>dependent: :destroy</code> associations (or use the <code>prepend: true</code> option), to
ensure they execute before the records are deleted by <code>dependent: :destroy</code>.</p></div><h2 id="transaction-callbacks"><a class="anchorlink" href="#transaction-callbacks"><span>11</span> Transaction Callbacks</a></h2><h3 id="after-commit-and-after-rollback"><a class="anchorlink" href="#after-commit-and-after-rollback"><span>11.1</span> <code>after_commit</code> and <code>after_rollback</code></a></h3><p>Two additional callbacks are triggered by the completion of a database
transaction: <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_commit"><code>after_commit</code></a> and <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_rollback"><code>after_rollback</code></a>. These callbacks are
very similar to the <code>after_save</code> callback except that they don't execute until
after database changes have either been committed or rolled back. They are most
useful when your Active Record models need to interact with external systems
that are not part of the database transaction.</p><p>Consider a <code>PictureFile</code> model that needs to delete a file after the
corresponding record is destroyed.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy</span> <span class="ss">:delete_picture_file_from_disk</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_destroy :delete_picture_file_from_disk

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
">Copy</button>
</div>
<p>If anything raises an exception after the <code>after_destroy</code> callback is called and
the transaction rolls back, then the file will have been deleted and the model
will be left in an inconsistent state. For example, suppose that
<code>picture_file_2</code> in the code below is not valid and the <code>save!</code> method raises an
error.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">PictureFile</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">picture_file_1</span><span class="p">.</span><span class="nf">destroy</span>
  <span class="n">picture_file_2</span><span class="p">.</span><span class="nf">save!</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="PictureFile.transaction do
  picture_file_1.destroy
  picture_file_2.save!
end
">Copy</button>
</div>
<p>By using the <code>after_commit</code> callback we can account for this case.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:delete_picture_file_from_disk</span><span class="p">,</span> <span class="ss">on: :destroy</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_commit :delete_picture_file_from_disk, on: :destroy

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
">Copy</button>
</div>
<div class="interstitial note"><p>The <code>:on</code> option specifies when a callback will be fired. If you don't
supply the <code>:on</code> option the callback will fire for every life cycle event. <a href="#registering-callbacks-to-fire-on-life-cycle-events">Read
more about <code>:on</code></a>.</p></div><p>When a transaction completes, the <code>after_commit</code> or <code>after_rollback</code> callbacks
are called for all models created, updated, or destroyed within that
transaction. However, if an exception is raised within one of these callbacks,
the exception will bubble up and any remaining <code>after_commit</code> or
<code>after_rollback</code> methods will <em>not</em> be executed.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="k">raise</span> <span class="s2">"Intentional Error"</span> <span class="p">}</span>
  <span class="n">after_commit</span> <span class="p">{</span>
    <span class="c1"># This won't get called because the previous after_commit raises an exception</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"This will not be logged"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ActiveRecord::Base
  after_commit { raise &quot;Intentional Error&quot; }
  after_commit {
    # This won't get called because the previous after_commit raises an exception
    Rails.logger.info(&quot;This will not be logged&quot;)
  }
end
">Copy</button>
</div>
<div class="interstitial warning"><p>If your callback code raises an exception, you'll need to rescue it and
handle it within the callback in order to allow other callbacks to run.</p></div><p><code>after_commit</code> makes very different guarantees than <code>after_save</code>,
<code>after_update</code>, and <code>after_destroy</code>. For example, if an exception occurs in an
<code>after_save</code> the transaction will be rolled back and the data will not be
persisted.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_save</span> <span class="k">do</span>
    <span class="c1"># If this fails the user won't be saved.</span>
    <span class="no">EventLog</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">event: </span><span class="s2">"user_saved"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ActiveRecord::Base
  after_save do
    # If this fails the user won't be saved.
    EventLog.create!(event: &quot;user_saved&quot;)
  end
end
">Copy</button>
</div>
<p>However, during <code>after_commit</code> the data was already persisted to the database,
and thus any exception won't roll anything back anymore.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="k">do</span>
    <span class="c1"># If this fails the user was already saved.</span>
    <span class="no">EventLog</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">event: </span><span class="s2">"user_saved"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ActiveRecord::Base
  after_commit do
    # If this fails the user was already saved.
    EventLog.create!(event: &quot;user_saved&quot;)
  end
end
">Copy</button>
</div>
<p>The code executed within <code>after_commit</code> or <code>after_rollback</code> callbacks is itself
not enclosed within a transaction.</p><p>In the context of a single transaction, if you represent the same record in the
database, there's a crucial behavior in the <code>after_commit</code> and <code>after_rollback</code>
callbacks to note. These callbacks are triggered only for the first object of
the specific record that changes within the transaction. Other loaded objects,
despite representing the same database record, will not have their respective
<code>after_commit</code> or <code>after_rollback</code> callbacks triggered.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:log_user_saved_to_db</span><span class="p">,</span> <span class="ss">on: :update</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_commit :log_user_saved_to_db, on: :update

  private
    def log_user_saved_to_db
      Rails.logger.info(&quot;User was saved to database&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">transaction</span> <span class="p">{</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span><span class="p">;</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="p">}</span>
<span class="c"># User was saved to database
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create
User.transaction { user.save; user.save }
">Copy</button>
</div>
<div class="interstitial warning"><p>This nuanced behavior is particularly impactful in scenarios where you
expect independent callback execution for each object associated with the same
database record. It can influence the flow and predictability of callback
sequences, leading to potential inconsistencies in application logic following
the transaction.</p></div><h3 id="aliases-for-after-commit"><a class="anchorlink" href="#aliases-for-after-commit"><span>11.2</span> Aliases for <code>after_commit</code></a></h3><p>Using the <code>after_commit</code> callback only on create, update, or delete is common.
Sometimes you may also want to use a single callback for both <code>create</code> and
<code>update</code>. Here are some common aliases for these operations:</p>
<ul>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_destroy_commit"><code>after_destroy_commit</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_create_commit"><code>after_create_commit</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_update_commit"><code>after_update_commit</code></a></li>
<li><a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-after_save_commit"><code>after_save_commit</code></a></li>
</ul>
<p>Let's go through some examples:</p><p>Instead of using <code>after_commit</code> with the <code>on</code> option for a destroy like below:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="ss">:delete_picture_file_from_disk</span><span class="p">,</span> <span class="ss">on: :destroy</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_commit :delete_picture_file_from_disk, on: :destroy

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
">Copy</button>
</div>
<p>You can instead use the <code>after_destroy_commit</code>.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_destroy_commit</span> <span class="ss">:delete_picture_file_from_disk</span>

  <span class="k">def</span> <span class="nf">delete_picture_file_from_disk</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_destroy_commit :delete_picture_file_from_disk

  def delete_picture_file_from_disk
    if File.exist?(filepath)
      File.delete(filepath)
    end
  end
end
">Copy</button>
</div>
<p>The same applies for <code>after_create_commit</code> and <code>after_update_commit</code>.</p><p>However, if you use the <code>after_create_commit</code> and the <code>after_update_commit</code>
callback with the same method name, it will only allow the last callback defined
to take effect, as they both internally alias to <code>after_commit</code> which overrides
previously defined callbacks with the same method name.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_create_commit</span> <span class="ss">:log_user_saved_to_db</span>
  <span class="n">after_update_commit</span> <span class="ss">:log_user_saved_to_db</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="c1"># This only gets called once</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_create_commit :log_user_saved_to_db
  after_update_commit :log_user_saved_to_db

  private
    def log_user_saved_to_db
      # This only gets called once
      Rails.logger.info(&quot;User was saved to database&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># prints nothing</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># updating @user</span>
<span class="go">User was saved to database
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create # prints nothing
user.save # updating @user
">Copy</button>
</div>
<p>In this case, it's better to use <code>after_save_commit</code> instead which is an alias
for using the <code>after_commit</code> callback for both create and update:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_save_commit</span> <span class="ss">:log_user_saved_to_db</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">log_user_saved_to_db</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"User was saved to database"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ApplicationRecord
  after_save_commit :log_user_saved_to_db

  private
    def log_user_saved_to_db
      Rails.logger.info(&quot;User was saved to database&quot;)
    end
end
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="c1"># creating a User</span>
<span class="go">User was saved to database
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># updating user</span>
<span class="go">User was saved to database
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="user = User.create # creating a User
user.save # updating user
">Copy</button>
</div>
<h3 id="transactional-callback-ordering"><a class="anchorlink" href="#transactional-callback-ordering"><span>11.3</span> Transactional Callback Ordering</a></h3><p>By default (from Rails 7.1), transaction callbacks will run in the order they
are defined.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"this gets called first"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">after_commit</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"this gets called second"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User < ActiveRecord::Base
  after_commit { Rails.logger.info(&quot;this gets called first&quot;) }
  after_commit { Rails.logger.info(&quot;this gets called second&quot;) }
end
">Copy</button>
</div>
<p>However, in prior versions of Rails, when defining multiple transactional
<code>after_</code> callbacks (<code>after_commit</code>, <code>after_rollback</code>, etc), the order in which
the callbacks were run was reversed.</p><p>If for some reason you'd still like them to run in reverse, you can set the
following configuration to <code>false</code>. The callbacks will then run in the reverse
order. See the <a href="configuring.html#config-active-record-run-after-transaction-callbacks-in-order-defined">Active Record configuration
options</a>
for more details.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">run_after_transaction_callbacks_in_order_defined</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.run_after_transaction_callbacks_in_order_defined = false
">Copy</button>
</div>
<div class="interstitial note"><p>This applies to all <code>after_*_commit</code> variations too, such as
<code>after_destroy_commit</code>.</p></div><h2 id="callback-objects"><a class="anchorlink" href="#callback-objects"><span>12</span> Callback Objects</a></h2><p>Sometimes the callback methods that you'll write will be useful enough to be
reused by other models. Active Record makes it possible to create classes that
encapsulate the callback methods, so they can be reused.</p><p>Here's an example of an <code>after_commit</code> callback  class to deal with the cleanup
of discarded files on the filesystem. This behavior may not be unique to our
<code>PictureFile</code> model and we may want to share it, so it's a good idea to
encapsulate this into a separate class. This will make testing that behavior and
changing it much easier.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FileDestroyerCallback</span>
  <span class="k">def</span> <span class="nf">after_commit</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class FileDestroyerCallback
  def after_commit(file)
    if File.exist?(file.filepath)
      File.delete(file.filepath)
    end
  end
end
">Copy</button>
</div>
<p>When declared inside a class, as above, the callback methods will receive the
model object as a parameter. This will work on any model that uses the class
like so:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="no">FileDestroyerCallback</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_commit FileDestroyerCallback.new
end
">Copy</button>
</div>
<p>Note that we needed to instantiate a new <code>FileDestroyerCallback</code> object, since
we declared our callback as an instance method. This is particularly useful if
the callbacks make use of the state of the instantiated object. Often, however,
it will make more sense to declare the callbacks as class methods:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FileDestroyerCallback</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">after_commit</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="nf">filepath</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class FileDestroyerCallback
  def self.after_commit(file)
    if File.exist?(file.filepath)
      File.delete(file.filepath)
    end
  end
end
">Copy</button>
</div>
<p>When the callback method is declared this way, it won't be necessary to
instantiate a new <code>FileDestroyerCallback</code> object in our model.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PictureFile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">after_commit</span> <span class="no">FileDestroyerCallback</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PictureFile < ApplicationRecord
  after_commit FileDestroyerCallback
end
">Copy</button>
</div>
<p>You can declare as many callbacks as you want inside your callback objects.</p>
        <hr>
        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>.
        </p>
      </div>
    </div>
  </main>

  <hr class="hide" />
  <footer id="page_footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </footer>
</body>
</html>
