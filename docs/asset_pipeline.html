<!doctype html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Asset Pipeline — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style-9e7329e5b4c46ecb619db14d43a6724d.css" data-turbo-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print-a4d2686c548e59657450d04dc27f7787.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight-a0d2133dd0073968b2d33b1f1360a2a3.css" data-turbo-track="reload">

  <link rel="icon" href="images/favicon.ico" sizes="any">

  <link rel="apple-touch-icon" href="images/icon.png">

  <script src="javascripts/@hotwired--turbo-764f59c7edbeb902a9068c0340dd274e.js" data-turbo-track="reload"></script>
  <script src="javascripts/clipboard-8b7aed6f069f0cf58eeae353cd2f898b.js" data-turbo-track="reload"></script>
  <script src="javascripts/guides-be644dbd164a32c619aa8f714fc0b4bf.js" data-turbo-track="reload"></script>

  <meta property="og:title" content="The Asset Pipeline — Ruby on Rails Guides" />
  <meta name="description" content="The Asset PipelineThis guide covers the asset pipeline.After reading this guide, you will know: What the asset pipeline is and what it does. How to properly organize your application assets. The benefits of the asset pipeline. How to add a pre-processor to the pipeline. How to package assets with a gem." />
  <meta property="og:description" content="The Asset PipelineThis guide covers the asset pipeline.After reading this guide, you will know: What the asset pipeline is and what it does. How to properly organize your application assets. The benefits of the asset pipeline. How to add a pre-processor to the pipeline. How to package assets with a gem." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@100..900&family=Noto+Sans+Arabic:wght@100..900&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#C81418">
</head>

<body class="guide">
  <nav id="topNav" aria-label="Secondary">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </nav>
  <header id="page_header">
    <div class="wrapper clearfix">
      <nav id="feature_nav">
        <div class="header-logo">
          <a href="index.html" title="Return to the Guides Home for Edge Guides">Guides</a>
          <span id="version_switcher">
            Version:
            <select class="guides-version">
              <option value="https://edgeguides.rubyonrails.org/" selected>Edge</option>
                <option value="https://guides.rubyonrails.org/v7.2/">7.2</option>
                <option value="https://guides.rubyonrails.org/v7.1/">7.1</option>
                <option value="https://guides.rubyonrails.org/v7.0/">7.0</option>
                <option value="https://guides.rubyonrails.org/v6.1/">6.1</option>
                <option value="https://guides.rubyonrails.org/v6.0/">6.0</option>
                <option value="https://guides.rubyonrails.org/v5.2/">5.2</option>
                <option value="https://guides.rubyonrails.org/v5.1/">5.1</option>
                <option value="https://guides.rubyonrails.org/v5.0/">5.0</option>
                <option value="https://guides.rubyonrails.org/v4.2/">4.2</option>
                <option value="https://guides.rubyonrails.org/v4.1/">4.1</option>
                <option value="https://guides.rubyonrails.org/v4.0/">4.0</option>
                <option value="https://guides.rubyonrails.org/v3.2/">3.2</option>
                <option value="https://guides.rubyonrails.org/v3.1/">3.1</option>
                <option value="https://guides.rubyonrails.org/v3.0/">3.0</option>
                <option value="https://guides.rubyonrails.org/v2.3/">2.3</option>
            </select>
          </span>
        </div>
        <ul class="nav">
          <li><a class="nav-item" id="home_nav" href="https://rubyonrails.org/">Home</a></li>
          <li class="guides-index guides-index-large">
            <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
            <div id="guides" class="clearfix" style="display: none;">
              <hr />
              <dl class="guides-section-container">
                  <div class="guides-section">
                    <dt>Start Here</dt>
                    <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Models</dt>
                    <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                    <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                    <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                    <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                    <dd><a href="association_basics.html">Active Record Associations</a></dd>
                    <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                    <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Views</dt>
                    <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                    <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                    <dd><a href="action_view_helpers.html">Action View Helpers</a></dd>
                    <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Controllers</dt>
                    <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                    <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Other Components</dt>
                    <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                    <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                    <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                    <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                    <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                    <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                    <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Digging Deeper</dt>
                    <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                    <dd><a href="testing.html">Testing Rails Applications</a></dd>
                    <dd><a href="security.html">Securing Rails Applications</a></dd>
                    <dd><a href="error_reporting.html">Error Reporting in Rails Applications</a></dd>
                    <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                    <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                    <dd><a href="command_line.html">The Rails Command Line</a></dd>
                    <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                    <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                    <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading</a></dd>
                    <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                    <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                    <dd><a href="tuning_performance_for_deployment.html">Tuning Performance for Deployment</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Advanced Active Record</dt>
                    <dd><a href="active_record_multiple_databases.html">Multiple Databases</a></dd>
                    <dd><a href="active_record_composite_primary_keys.html">Composite Primary Keys</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Extending Rails</dt>
                    <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                    <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Contributing</dt>
                    <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                    <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                    <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                    <dd><a href="development_dependencies_install.html">Installing Rails Core Development Dependencies</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Policies</dt>
                    <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                  </div>
                  <div class="guides-section">
                    <dt>Release Notes</dt>
                    <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                    <dd><a href="7_2_release_notes.html">Version 7.2 - August 2024</a></dd>
                    <dd><a href="7_1_release_notes.html">Version 7.1 - October 2023</a></dd>
                    <dd><a href="7_0_release_notes.html">Version 7.0 - December 2021</a></dd>
                    <dd><a href="6_1_release_notes.html">Version 6.1 - December 2020</a></dd>
                    <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                    <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                    <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                    <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                    <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                    <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                    <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                    <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                    <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                    <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                    <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                    <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                  </div>
              </dl>
            </div>
          </li>
          <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
          <li class="guides-index guides-index-small">
            <select class="guides-index-item nav-item">
              <option value="index.html">Guides Index</option>
                <optgroup label="Start Here">
                    <option value="getting_started.html">Getting Started with Rails</option>
                </optgroup>
                <optgroup label="Models">
                    <option value="active_record_basics.html">Active Record Basics</option>
                    <option value="active_record_migrations.html">Active Record Migrations</option>
                    <option value="active_record_validations.html">Active Record Validations</option>
                    <option value="active_record_callbacks.html">Active Record Callbacks</option>
                    <option value="association_basics.html">Active Record Associations</option>
                    <option value="active_record_querying.html">Active Record Query Interface</option>
                    <option value="active_model_basics.html">Active Model Basics</option>
                </optgroup>
                <optgroup label="Views">
                    <option value="action_view_overview.html">Action View Overview</option>
                    <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                    <option value="action_view_helpers.html">Action View Helpers</option>
                    <option value="form_helpers.html">Action View Form Helpers</option>
                </optgroup>
                <optgroup label="Controllers">
                    <option value="action_controller_overview.html">Action Controller Overview</option>
                    <option value="routing.html">Rails Routing from the Outside In</option>
                </optgroup>
                <optgroup label="Other Components">
                    <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                    <option value="action_mailer_basics.html">Action Mailer Basics</option>
                    <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                    <option value="action_text_overview.html">Action Text Overview</option>
                    <option value="active_job_basics.html">Active Job Basics</option>
                    <option value="active_storage_overview.html">Active Storage Overview</option>
                    <option value="action_cable_overview.html">Action Cable Overview</option>
                </optgroup>
                <optgroup label="Digging Deeper">
                    <option value="i18n.html">Rails Internationalization (I18n) API</option>
                    <option value="testing.html">Testing Rails Applications</option>
                    <option value="security.html">Securing Rails Applications</option>
                    <option value="error_reporting.html">Error Reporting in Rails Applications</option>
                    <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                    <option value="configuring.html">Configuring Rails Applications</option>
                    <option value="command_line.html">The Rails Command Line</option>
                    <option value="asset_pipeline.html">The Asset Pipeline</option>
                    <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                    <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading</option>
                    <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                    <option value="api_app.html">Using Rails for API-only Applications</option>
                    <option value="tuning_performance_for_deployment.html">Tuning Performance for Deployment</option>
                </optgroup>
                <optgroup label="Advanced Active Record">
                    <option value="active_record_multiple_databases.html">Multiple Databases</option>
                    <option value="active_record_composite_primary_keys.html">Composite Primary Keys</option>
                </optgroup>
                <optgroup label="Extending Rails">
                    <option value="rails_on_rack.html">Rails on Rack</option>
                    <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                </optgroup>
                <optgroup label="Contributing">
                    <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                    <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                    <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
                    <option value="development_dependencies_install.html">Installing Rails Core Development Dependencies</option>
                </optgroup>
                <optgroup label="Policies">
                    <option value="maintenance_policy.html">Maintenance Policy</option>
                </optgroup>
                <optgroup label="Release Notes">
                    <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                    <option value="7_2_release_notes.html">Version 7.2 - August 2024</option>
                    <option value="7_1_release_notes.html">Version 7.1 - October 2023</option>
                    <option value="7_0_release_notes.html">Version 7.0 - December 2021</option>
                    <option value="6_1_release_notes.html">Version 6.1 - December 2020</option>
                    <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                    <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                    <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                    <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                    <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                    <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                    <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                    <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                    <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                    <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                    <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                    <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
                </optgroup>
            </select>
          </li>
      </ul>
      </nav>
    </div>
  </header>
  <hr class="hide" />

  <section id="feature">
    <div class="wrapper">
      <h1>The Asset Pipeline</h1><p>This guide covers the asset pipeline.</p><p>After reading this guide, you will know:</p>
<ul>
<li>What the asset pipeline is and what it does.</li>
<li>How to properly organize your application assets.</li>
<li>The benefits of the asset pipeline.</li>
<li>How to add a pre-processor to the pipeline.</li>
<li>How to package assets with a gem.</li>
</ul>


                <nav id="subCol">
            <h3 class="chapter">
              <picture>
                <!-- Using the `source`  HTML tag to set the dark theme image -->
                <source
                  srcset="images/icon_book-close-bookmark-1-wht.svg"
                  media="(prefers-color-scheme: dark)"
                />
                <img src="images/icon_book-close-bookmark-1.svg" alt="Chapter Icon" />
              </picture>
              Chapters
            </h3>
            <ol class="chapters">
<li><a href="#what-is-the-asset-pipeline-questionmark">What is the Asset Pipeline?</a></li>
<li><a href="#main-features">Main Features</a>

<ul>
<li><a href="#what-is-fingerprinting-and-why-should-i-care-questionmark">What is Fingerprinting and Why Should I Care?</a></li>
<li><a href="#what-are-import-maps-and-why-should-i-care-questionmark">What are Import Maps and Why Should I Care?</a></li>
</ul></li>
<li><a href="#how-to-use-import-maps-as-javascript-asset-pipeline">How to use Import Maps as JavaScript Asset Pipeline</a>

<ul>
<li><a href="#how-it-works">How it works</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#using-npm-packages-via-javascript-cdns">Using npm packages via JavaScript CDNs</a></li>
<li><a href="#preloading-pinned-modules">Preloading pinned modules</a></li>
</ul></li>
<li><a href="#how-to-use-sprockets">How to Use Sprockets</a>

<ul>
<li><a href="#manifest-files-and-directives">Manifest Files and Directives</a></li>
<li><a href="#controller-specific-assets">Controller Specific Assets</a></li>
<li><a href="#asset-organization">Asset Organization</a></li>
<li><a href="#coding-links-to-assets">Coding Links to Assets</a></li>
<li><a href="#raise-an-error-when-an-asset-is-not-found">Raise an Error When an Asset is Not Found</a></li>
<li><a href="#turning-digests-off">Turning Digests Off</a></li>
<li><a href="#turning-source-maps-on">Turning Source Maps On</a></li>
</ul></li>
<li><a href="#in-production">In Production</a>

<ul>
<li><a href="#precompiling-assets">Precompiling Assets</a></li>
<li><a href="#local-precompilation">Local Precompilation</a></li>
<li><a href="#live-compilation">Live Compilation</a></li>
<li><a href="#cdns">CDNs</a></li>
</ul></li>
<li><a href="#customizing-the-pipeline">Customizing the Pipeline</a>

<ul>
<li><a href="#css-compression">CSS Compression</a></li>
<li><a href="#javascript-compression">JavaScript Compression</a></li>
<li><a href="#gzipping-your-assets">GZipping your assets</a></li>
<li><a href="#using-your-own-compressor">Using Your Own Compressor</a></li>
<li><a href="#changing-the-assets-path">Changing the <em>assets</em> Path</a></li>
<li><a href="#x-sendfile-headers">X-Sendfile Headers</a></li>
</ul></li>
<li><a href="#assets-cache-store">Assets Cache Store</a></li>
<li><a href="#adding-assets-to-your-gems">Adding Assets to Your Gems</a></li>
<li><a href="#making-your-library-or-gem-a-pre-processor">Making Your Library or Gem a Pre-Processor</a></li>
<li><a href="#alternative-libraries">Alternative Libraries</a>

<ul>
<li><a href="#jsbundling-rails">jsbundling-rails</a></li>
<li><a href="#webpacker-shakapacker">Webpacker/Shakapacker</a></li>
<li><a href="#cssbundling-rails">cssbundling-rails</a></li>
<li><a href="#dartsass-rails">dartsass-rails</a></li>
<li><a href="#tailwindcss-rails">tailwindcss-rails</a></li>
</ul></li>
</ol>

          </nav>


      <hr>
    </div>
  </section>

  <main id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h2 id="what-is-the-asset-pipeline-questionmark"><a class="anchorlink" href="#what-is-the-asset-pipeline-questionmark"><span>1</span> What is the Asset Pipeline?</a></h2><p>The asset pipeline provides a framework to handle the delivery of JavaScript and
CSS assets. This is done by leveraging technologies like HTTP/2 and techniques like
concatenation and minification. Finally, it allows your
application to be automatically combined with assets from other gems.</p><p>The asset pipeline is implemented by the <a href="https://github.com/rails/importmap-rails">importmap-rails</a>, <a href="https://github.com/rails/sprockets">sprockets</a> and <a href="https://github.com/rails/sprockets-rails">sprockets-rails</a> gems, and is enabled by default. You can disable it while creating a new application by
passing the <code>--skip-asset-pipeline</code> option.</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">rails </span>new appname <span class="nt">--skip-asset-pipeline</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="rails new appname --skip-asset-pipeline
">Copy</button>
</div>
<div class="interstitial note"><p>This guide focuses on the default asset pipeline using only <code>sprockets</code> for CSS and <code>importmap-rails</code> for JavaScript processing. The main limitation of those two is that there is no support for transpiling so you can't use things like Babel, TypeScript, Sass, React JSX format, or Tailwind CSS. We encourage you to read the <a href="#alternative-libraries">Alternative Libraries section</a> if you need transpiling for your JavaScript/CSS.</p></div><h2 id="main-features"><a class="anchorlink" href="#main-features"><span>2</span> Main Features</a></h2><p>The asset pipeline's first feature is inserting a SHA256 fingerprinting
into each filename so that the file is cached by the web browser and CDN. This
fingerprint is automatically updated when you change the file contents, which
invalidates the cache.</p><p>The second feature of the asset pipeline is to use <a href="https://github.com/WICG/import-maps">import maps</a>
when serving JavaScript files. This lets you build modern applications using
JavaScript libraries made for ES modules (ESM) without the need for transpiling
and bundling. In turn, <strong>this eliminates the need for Webpack, yarn, node or any
other part of the JavaScript toolchain</strong>.</p><p>The third feature of the asset pipeline is to concatenate all CSS files into
one main <code>.css</code> file, which is then minified or compressed.
As you'll learn later in this guide, you can customize this strategy to group
files any way you like. In production, Rails inserts a SHA256 fingerprint into
each filename so that the file is cached by the web browser. You can invalidate
the cache by altering this fingerprint, which happens automatically whenever you
change the file contents.</p><p>The fourth feature of the asset pipeline is it allows coding assets via a
higher-level language for CSS.</p><h3 id="what-is-fingerprinting-and-why-should-i-care-questionmark"><a class="anchorlink" href="#what-is-fingerprinting-and-why-should-i-care-questionmark"><span>2.1</span> What is Fingerprinting and Why Should I Care?</a></h3><p>Fingerprinting is a technique that makes the name of a file dependent on the
contents of the file. When the file contents change, the filename is also
changed. For static or infrequently changed content, this provides an
easy way to tell whether two versions of a file are identical, even across
different servers or deployment dates.</p><p>When a filename is unique and based on its content, HTTP headers can be set to
encourage caches everywhere (whether at CDNs, at ISPs, in networking equipment,
or in web browsers) to keep their own copy of the content. When the content is
updated, the fingerprint will change. This will cause the remote clients to
request a new copy of the content. This is generally known as <em>cache busting</em>.</p><p>The technique Sprockets uses for fingerprinting is to insert a hash of the
content into the name, usually at the end. For example a CSS file <code>global.css</code></p><div class="interstitial code">
<pre><code class="highlight plaintext">global-908e25f4bf641868d8683022a5b62f54.css
</code></pre>
<button class="clipboard-button" data-clipboard-text="global-908e25f4bf641868d8683022a5b62f54.css
">Copy</button>
</div>
<p>This is the strategy adopted by the Rails asset pipeline.</p><p>Fingerprinting is enabled by default for both the development and production
environments. You can enable or disable it in your configuration through the
<a href="configuring.html#config-assets-digest"><code>config.assets.digest</code></a> option.</p><h3 id="what-are-import-maps-and-why-should-i-care-questionmark"><a class="anchorlink" href="#what-are-import-maps-and-why-should-i-care-questionmark"><span>2.2</span> What are Import Maps and Why Should I Care?</a></h3><p>Import maps let you import JavaScript modules using logical names that map to versioned/digested files – directly from the browser. So you can build modern JavaScript applications using JavaScript libraries made for ES modules (ESM) without the need for transpiling or bundling.</p><p>With this approach, you'll ship many small JavaScript files instead of one big JavaScript file. Thanks to HTTP/2 that no longer carries a material performance penalty during the initial transport, and in fact offers substantial benefits over the long run due to better caching dynamics.</p><h2 id="how-to-use-import-maps-as-javascript-asset-pipeline"><a class="anchorlink" href="#how-to-use-import-maps-as-javascript-asset-pipeline"><span>3</span> How to use Import Maps as JavaScript Asset Pipeline</a></h2><p>Import Maps are the default JavaScript processor, the logic of generating import maps is handled by the <a href="https://github.com/rails/importmap-rails"><code>importmap-rails</code></a> gem.</p><div class="interstitial warning"><p>Import maps are used only for JavaScript files and can not be used for CSS delivery. Check the <a href="#how-to-use-sprockets">Sprockets section</a> to learn about CSS.</p></div><p>You can find detailed usage instructions on the Gem homepage, but it's important to understand the basics of <code>importmap-rails</code>.</p><h3 id="how-it-works"><a class="anchorlink" href="#how-it-works"><span>3.1</span> How it works</a></h3><p>Import maps are essentially a string substitution for what is referred to as "bare module specifiers". They allow you to standardize the names of JavaScript module imports.</p><p>Take for example such an import definition, it won't work without an import map:</p><div class="interstitial code">
<pre><code class="highlight javascript"><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="import React from &quot;react&quot;
">Copy</button>
</div>
<p>You would have to define it like this to make it work:</p><div class="interstitial code">
<pre><code class="highlight javascript"><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">https://ga.jspm.io/npm:react@17.0.2/index.js</span><span class="dl">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="import React from &quot;https://ga.jspm.io/npm:react@17.0.2/index.js&quot;
">Copy</button>
</div>
<p>Here comes the import map, we define the <code>react</code> name to be pinned to the <code>https://ga.jspm.io/npm:react@17.0.2/index.js</code> address. With such information our browser accepts the simplified <code>import React from "react"</code> definition. Think of import map as about an alias for the library source address.</p><h3 id="usage"><a class="anchorlink" href="#usage"><span>3.2</span> Usage</a></h3><p>With <code>importmap-rails</code> you create the importmap configuration file pinning the library path to a name:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># config/importmap.rb</span>
<span class="n">pin</span> <span class="s2">"application"</span>
<span class="n">pin</span> <span class="s2">"react"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"https://ga.jspm.io/npm:react@17.0.2/index.js"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="pin &quot;application&quot;
pin &quot;react&quot;, to: &quot;https://ga.jspm.io/npm:react@17.0.2/index.js&quot;
">Copy</button>
</div>
<p>All of the configured import maps should be attached in <code>&lt;head&gt;</code> element of your application by adding  <code>&lt;%= javascript_importmap_tags %&gt;</code> . The <code>javascript_importmap_tags</code> renders a bunch of scripts in the <code>head</code> element:</p>
<ul>
<li>JSON with all configured import maps:</li>
</ul>
<div class="interstitial code">
<pre><code class="highlight html"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"importmap"</span><span class="nt">&gt;</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">imports</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">application</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/assets/application-39f16dc3f3....js</span><span class="dl">"</span>
    <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://ga.jspm.io/npm:react@17.0.2/index.js</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<script type=&quot;importmap&quot;>
{
  &quot;imports&quot;: {
    &quot;application&quot;: &quot;/assets/application-39f16dc3f3....js&quot;
    &quot;react&quot;: &quot;https://ga.jspm.io/npm:react@17.0.2/index.js&quot;
  }
}
</script>
">Copy</button>
</div>

<ul>
<li>Entrypoint for loading JavaScript from <code>app/javascript/application.js</code>:</li>
</ul>
<div class="interstitial code">
<pre><code class="highlight html"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span><span class="k">import</span> <span class="dl">"</span><span class="s2">application</span><span class="dl">"</span><span class="nt">&lt;/script&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<script type=&quot;module&quot;>import &quot;application&quot;</script>
">Copy</button>
</div>
<div class="interstitial note"><p>Before v2.0.0, <code>importmap-rails</code> put <a href="https://github.com/guybedford/es-module-shims"><code>Es-module-shims</code></a> in the output of <code>javascript_importmap_tags</code> as a polyfill to ensure support for import maps on older browsers. However, with the native support for import maps in all major browsers, v2.0.0 has dropped the bundled shim. If you want to support legacy browsers that lack support for import maps, manually insert <code>Es-module-shims</code> before <code>javascript_importmap_tags</code>. For more information, refer to <a href="https://github.com/rails/importmap-rails?tab=readme-ov-file#supporting-legacy-browsers-such-as-safari-on-ios-15">README for importmap-rails</a>.</p></div><h3 id="using-npm-packages-via-javascript-cdns"><a class="anchorlink" href="#using-npm-packages-via-javascript-cdns"><span>3.3</span> Using npm packages via JavaScript CDNs</a></h3><p>You can use the <code>bin/importmap</code> command that's added as part of the <code>importmap-rails</code> install to pin, unpin, or update npm packages in your import map. The binstub uses <a href="https://jspm.org/"><code>JSPM.org</code></a>.</p><p>It works like so:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/importmap pin react react-dom
<span class="go">Pinning "react" to https://ga.jspm.io/npm:react@17.0.2/index.js
Pinning "react-dom" to https://ga.jspm.io/npm:react-dom@17.0.2/index.js
Pinning "object-assign" to https://ga.jspm.io/npm:object-assign@4.1.1/index.js
Pinning "scheduler" to https://ga.jspm.io/npm:scheduler@0.20.2/index.js

bin/importmap json

{
  "imports": {
    "application": "/assets/application-37f365cbecf1fa2810a8303f4b6571676fa1f9c56c248528bc14ddb857531b95.js",
    "react": "https://ga.jspm.io/npm:react@17.0.2/index.js",
    "react-dom": "https://ga.jspm.io/npm:react-dom@17.0.2/index.js",
    "object-assign": "https://ga.jspm.io/npm:object-assign@4.1.1/index.js",
    "scheduler": "https://ga.jspm.io/npm:scheduler@0.20.2/index.js"
  }
}
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/importmap pin react react-dom
">Copy</button>
</div>
<p>As you can see, the two packages react and react-dom resolve to a total of four dependencies, when resolved via the jspm default.</p><p>Now you can use these in your <code>application.js</code> entrypoint like you would any other module:</p><div class="interstitial code">
<pre><code class="highlight javascript"><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-dom</span><span class="dl">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="import React from &quot;react&quot;
import ReactDOM from &quot;react-dom&quot;
">Copy</button>
</div>
<p>You can also designate a specific version to pin:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/importmap pin react@17.0.1
<span class="go">Pinning "react" to https://ga.jspm.io/npm:react@17.0.1/index.js
Pinning "object-assign" to https://ga.jspm.io/npm:object-assign@4.1.1/index.js
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/importmap pin react@17.0.1
">Copy</button>
</div>
<p>Or even remove pins:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/importmap unpin react
<span class="go">Unpinning "react"
Unpinning "object-assign"
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/importmap unpin react
">Copy</button>
</div>
<p>You can control the environment of the package for packages with separate "production" (the default) and "development" builds:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/importmap pin react <span class="nt">--env</span> development
<span class="go">Pinning "react" to https://ga.jspm.io/npm:react@17.0.2/dev.index.js
Pinning "object-assign" to https://ga.jspm.io/npm:object-assign@4.1.1/index.js
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/importmap pin react --env development
">Copy</button>
</div>
<p>You can also pick an alternative, supported CDN provider when pinning, like <a href="https://unpkg.com/"><code>unpkg</code></a> or <a href="https://www.jsdelivr.com/"><code>jsdelivr</code></a> (<a href="https://jspm.org/"><code>jspm</code></a> is the default):</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/importmap pin react <span class="nt">--from</span> jsdelivr
<span class="go">Pinning "react" to https://cdn.jsdelivr.net/npm/react@17.0.2/index.js
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/importmap pin react --from jsdelivr
">Copy</button>
</div>
<p>Remember, though, that if you switch a pin from one provider to another, you may have to clean up dependencies added by the first provider that isn't used by the second provider.</p><p>Run <code>bin/importmap</code> to see all options.</p><p>Note that this command is merely a convenience wrapper to resolving logical package names to CDN URLs. You can also just lookup the CDN URLs yourself, and then pin those. For example, if you wanted to use Skypack for React, you could just add the following to <code>config/importmap.rb</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">pin</span> <span class="s2">"react"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"https://cdn.skypack.dev/react"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="pin &quot;react&quot;, to: &quot;https://cdn.skypack.dev/react&quot;
">Copy</button>
</div>
<h3 id="preloading-pinned-modules"><a class="anchorlink" href="#preloading-pinned-modules"><span>3.4</span> Preloading pinned modules</a></h3><p>To avoid the waterfall effect where the browser has to load one file after another before it can get to the deepest nested import, importmap-rails supports <a href="https://developers.google.com/web/updates/2017/12/modulepreload">modulepreload links</a>. Pinned modules can be preloaded by appending <code>preload: true</code> to the pin.</p><p>It's a good idea to preload libraries or frameworks that are used throughout your app, as this will tell the browser to download them sooner.</p><p>Example:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># config/importmap.rb</span>
<span class="n">pin</span> <span class="s2">"@github/hotkey"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"https://ga.jspm.io/npm:@github/hotkey@1.4.4/dist/index.js"</span><span class="p">,</span> <span class="ss">preload: </span><span class="kp">true</span>
<span class="n">pin</span> <span class="s2">"md5"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"https://cdn.jsdelivr.net/npm/md5@2.3.0/md5.js"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="pin &quot;@github/hotkey&quot;, to: &quot;https://ga.jspm.io/npm:@github/hotkey@1.4.4/dist/index.js&quot;, preload: true
pin &quot;md5&quot;, to: &quot;https://cdn.jsdelivr.net/npm/md5@2.3.0/md5.js&quot;
">Copy</button>
</div>
<div class="interstitial code">
<pre><code class="highlight erb"><span class="c">&lt;%# app/views/layouts/application.html.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_importmap_tags</span> <span class="cp">%&gt;</span>

<span class="c">&lt;%# will include the following link before the importmap is setup: %&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"modulepreload"</span> <span class="na">href=</span><span class="s">"https://ga.jspm.io/npm:@github/hotkey@1.4.4/dist/index.js"</span><span class="nt">&gt;</span>
...
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= javascript_importmap_tags %>

<%# will include the following link before the importmap is setup: %>
<link rel=&quot;modulepreload&quot; href=&quot;https://ga.jspm.io/npm:@github/hotkey@1.4.4/dist/index.js&quot;>
...
">Copy</button>
</div>
<div class="interstitial note"><p>Refer to <a href="https://github.com/rails/importmap-rails"><code>importmap-rails</code></a> repository for the most up-to-date documentation.</p></div><h2 id="how-to-use-sprockets"><a class="anchorlink" href="#how-to-use-sprockets"><span>4</span> How to Use Sprockets</a></h2><p>The naive approach to expose your application assets to the web would be to store them in
subdirectories of <code>public</code> folder such as <code>images</code> and <code>stylesheets</code>. Doing so manually would be difficult as most of the modern web applications require the assets to be processed in specific way for eg. compressing and adding fingerprints to the assets.</p><p>Sprockets is designed to automatically preprocess your assets stored in the configured directories and after processing expose them in the <code>public/assets</code> folder with fingerprinting, compression, source maps generation and other configurable features.</p><p>Assets can still be placed in the <code>public</code> hierarchy. Any assets under <code>public</code>
will be served as static files by the application or web server when
<a href="configuring.html#config-public-file-server-enabled"><code>config.public_file_server.enabled</code></a> is set to true. You must define <code>manifest.js</code> directives
for files that must undergo some pre-processing before they are served.</p><p>In production, Rails precompiles these files to <code>public/assets</code> by default. The
precompiled copies are then served as static assets by the web server. The files
in the <code>app/assets</code> are never served directly in production.</p><h3 id="manifest-files-and-directives"><a class="anchorlink" href="#manifest-files-and-directives"><span>4.1</span> Manifest Files and Directives</a></h3><p>When compiling assets with Sprockets, Sprockets needs to decide which top-level targets to compile, usually <code>application.css</code> and images. The top-level targets are defined in the Sprockets <code>manifest.js</code> file, by default it looks like this:</p><div class="interstitial code">
<pre><code class="highlight js"><span class="c1">//= link_tree ../images</span>
<span class="c1">//= link_directory ../stylesheets .css</span>
<span class="c1">//= link_tree ../../javascript .js</span>
<span class="c1">//= link_tree ../../../vendor/javascript .js</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="//= link_tree ../images
//= link_directory ../stylesheets .css
//= link_tree ../../javascript .js
//= link_tree ../../../vendor/javascript .js
">Copy</button>
</div>
<p>It contains <em>directives</em> - instructions that tell Sprockets
which files to require in order to build a single CSS or JavaScript file.</p><p>This is meant to include the contents of all files found in the <code>./app/assets/images</code> directory or any subdirectories as well as any file recognized as JS directly at <code>./app/javascript</code> or <code>./vendor/javascript</code>.</p><p>It will load any CSS from the <code>./app/assets/stylesheets</code> directory (not including subdirectories). Assuming that you have <code>application.css</code> and <code>marketing.css</code> files in the <code>./app/assets/stylesheets</code> folder it will allow you to load those stylesheets with <code>&lt;%= stylesheet_link_tag "application" %&gt;</code> or <code>&lt;%= stylesheet_link_tag "marketing" %&gt;</code> from your views.</p><p>You might notice that our JavaScript files aren't loaded from the <code>assets</code> directory by default, it's because <code>./app/javascript</code> is the default entry point for <code>importmap-rails</code> gem and the <code>vendor</code> folder is the place where downloaded JS packages would be stored.</p><p>In the <code>manifest.js</code> you could also specify the <code>link</code> directive to load a specific file instead of the whole directory. <code>link</code> directive requires providing explicit file extension.</p><p>Sprockets loads the files specified, processes them if
necessary, concatenates them into one single file, and then compresses them
(based on the value of <code>config.assets.css_compressor</code> or <code>config.assets.js_compressor</code>).
Compression reduces file size, enabling the browser to download the files faster.</p><h3 id="controller-specific-assets"><a class="anchorlink" href="#controller-specific-assets"><span>4.2</span> Controller Specific Assets</a></h3><p>When you generate a scaffold or a controller, Rails also generates a
Cascading Style Sheet file for that controller. Additionally, when generating a scaffold, Rails generates the file <code>scaffolds.css</code>.</p><p>For example, if you generate a <code>ProjectsController</code>, Rails will also add a new
file at <code>app/assets/stylesheets/projects.css</code>. By default, these files will be
ready to use by your application immediately using the <code>link_directory</code> directive in the <code>manifest.js</code> file.</p><p>You can also opt to include controller-specific stylesheets files
only in their respective controllers using the following:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="n">params</span><span class="p">[</span><span class="ss">:controller</span><span class="p">]</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= stylesheet_link_tag params[:controller] %>
">Copy</button>
</div>
<p>When doing this, ensure you are not using the <code>require_tree</code> directive in your <code>application.css</code>, as that could result in your controller-specific assets being included more than once.</p><h3 id="asset-organization"><a class="anchorlink" href="#asset-organization"><span>4.3</span> Asset Organization</a></h3><p>Pipeline assets can be placed inside an application in one of three locations:
<code>app/assets</code>, <code>lib/assets</code> or <code>vendor/assets</code>.</p>
<ul>
<li><p><code>app/assets</code> is for assets that are owned by the application, such as custom images or stylesheets.</p></li>
<li><p><code>app/javascript</code> is for your JavaScript code</p></li>
<li><p><code>vendor/[assets|javascript]</code> is for assets that are owned by outside entities, such as CSS frameworks or JavaScript libraries. Keep in mind that third-party code with references to other files also processed by the asset Pipeline (images, stylesheets, etc.), will need to be rewritten to use helpers like <code>asset_path</code>.</p></li>
</ul>
<p>Other locations could be configured in the <code>manifest.js</code> file, refer to the <a href="#manifest-files-and-directives">Manifest Files and Directives</a>.</p><h4 id="search-paths"><a class="anchorlink" href="#search-paths"><span>4.3.1</span> Search Paths</a></h4><p>When a file is referenced from a manifest or a helper, Sprockets searches all of the locations specified in <code>manifest.js</code> for it. You can view the search path by inspecting
<a href="configuring.html#config-assets-paths"><code>Rails.application.config.assets.paths</code></a> in the Rails console.</p><h4 id="using-index-files-as-proxies-for-folders"><a class="anchorlink" href="#using-index-files-as-proxies-for-folders"><span>4.3.2</span> Using Index Files as proxies for folders</a></h4><p>Sprockets uses files named <code>index</code> (with the relevant extensions) for a special
purpose.</p><p>For example, if you have a CSS library with many modules, which is stored in
<code>lib/assets/stylesheets/library_name</code>, the file <code>lib/assets/stylesheets/library_name/index.css</code> serves as
the manifest for all files in this library. This file could include a list of
all the required files in order, or a simple <code>require_tree</code> directive.</p><p>It is also somewhat similar to the way that a file in <code>public/library_name/index.html</code> can be reached by a request to <code>/library_name</code>. This means that you cannot directly use an index file.</p><p>The library as a whole can be accessed in the <code>.css</code> files like so:</p><div class="interstitial code">
<pre><code class="highlight css"><span class="c">/* ...
*= require library_name
*/</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="/* ...
*= require library_name
*/
">Copy</button>
</div>
<p>This simplifies maintenance and keeps things clean by allowing related code to
be grouped before inclusion elsewhere.</p><h3 id="coding-links-to-assets"><a class="anchorlink" href="#coding-links-to-assets"><span>4.4</span> Coding Links to Assets</a></h3><p>Sprockets does not add any new methods to access your assets - you still use the
familiar <code>stylesheet_link_tag</code>:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="ss">media: </span><span class="s2">"all"</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= stylesheet_link_tag &quot;application&quot;, media: &quot;all&quot; %>
">Copy</button>
</div>
<p>If using the <a href="https://github.com/hotwired/turbo-rails"><code>turbo-rails</code></a> gem, which is included by default in Rails, then
include the <code>data-turbo-track</code> option which causes Turbo to check if
an asset has been updated and if so loads it into the page:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span><span class="p">,</span> <span class="s2">"data-turbo-track"</span><span class="p">:</span> <span class="s2">"reload"</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= stylesheet_link_tag &quot;application&quot;, &quot;data-turbo-track&quot;: &quot;reload&quot; %>
">Copy</button>
</div>
<p>In regular views you can access images in the <code>app/assets/images</code> directory
like this:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"rails.png"</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= image_tag &quot;rails.png&quot; %>
">Copy</button>
</div>
<p>Provided that the pipeline is enabled within your application (and not disabled
in the current environment context), this file is served by Sprockets. If a file
exists at <code>public/assets/rails.png</code> it is served by the web server.</p><p>Alternatively, a request for a file with an SHA256 hash such as
<code>public/assets/rails-f90d8a84c707a8dc923fca1ca1895ae8ed0a09237f6992015fef1e11be77c023.png</code>
is treated the same way. How these hashes are generated is covered in the <a href="#in-production">In
Production</a> section later on in this guide.</p><p>Images can also be organized into subdirectories if required, and then can be
accessed by specifying the directory's name in the tag:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"icons/rails.png"</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= image_tag &quot;icons/rails.png&quot; %>
">Copy</button>
</div>
<div class="interstitial warning"><p>If you're precompiling your assets (see <a href="#in-production">In Production</a>
below), linking to an asset that does not exist will raise an exception in the
calling page. This includes linking to a blank string. As such, be careful using
<code>image_tag</code> and the other helpers with user-supplied data.</p></div><h4 id="css-and-erb"><a class="anchorlink" href="#css-and-erb"><span>4.4.1</span> CSS and ERB</a></h4><p>The asset pipeline automatically evaluates ERB. This means if you add an
<code>erb</code> extension to a CSS asset (for example, <code>application.css.erb</code>), then
helpers like <code>asset_path</code> are available in your CSS rules:</p><div class="interstitial code">
<pre><code class="highlight css"><span class="nc">.class</span> <span class="p">{</span> <span class="nl">background-image</span><span class="p">:</span> <span class="sx">url(&lt;%= asset_path 'image.png' %&gt;)</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text=".class { background-image: url(<%= asset_path 'image.png' %>) }
">Copy</button>
</div>
<p>This writes the path to the particular asset being referenced. In this example,
it would make sense to have an image in one of the asset load paths, such as
<code>app/assets/images/image.png</code>, which would be referenced here. If this image is
already available in <code>public/assets</code> as a fingerprinted file, then that path is
referenced.</p><p>If you want to use a <a href="https://en.wikipedia.org/wiki/Data_URI_scheme">data URI</a> -
a method of embedding the image data directly into the CSS file - you can use
the <code>asset_data_uri</code> helper.</p><div class="interstitial code">
<pre><code class="highlight css"><span class="nf">#logo</span> <span class="p">{</span> <span class="nl">background</span><span class="p">:</span> <span class="sx">url(&lt;%= asset_data_uri 'logo.png' %&gt;)</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="#logo { background: url(<%= asset_data_uri 'logo.png' %>) }
">Copy</button>
</div>
<p>This inserts a correctly-formatted data URI into the CSS source.</p><p>Note that the closing tag cannot be of the style <code>-%&gt;</code>.</p><h3 id="raise-an-error-when-an-asset-is-not-found"><a class="anchorlink" href="#raise-an-error-when-an-asset-is-not-found"><span>4.5</span> Raise an Error When an Asset is Not Found</a></h3><p>If you are using sprockets-rails &gt;= 3.2.0 you can configure what happens
when an asset lookup is performed and nothing is found. If you turn off "asset fallback"
then an error will be raised when an asset cannot be found.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">unknown_asset_fallback</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.unknown_asset_fallback = false
">Copy</button>
</div>
<p>If "asset fallback" is enabled then when an asset cannot be found the path will be
output instead and no error raised. The asset fallback behavior is disabled by default.</p><h3 id="turning-digests-off"><a class="anchorlink" href="#turning-digests-off"><span>4.6</span> Turning Digests Off</a></h3><p>You can turn off digests by updating <code>config/environments/development.rb</code> to
include:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.digest = false
">Copy</button>
</div>
<p>When this option is true, digests will be generated for asset URLs.</p><h3 id="turning-source-maps-on"><a class="anchorlink" href="#turning-source-maps-on"><span>4.7</span> Turning Source Maps On</a></h3><p>You can turn on source maps by updating <code>config/environments/development.rb</code> to
include:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.debug = true
">Copy</button>
</div>
<p>When debug mode is on, Sprockets will generate a Source Map for each asset. This
allows you to debug each file individually in your browser's developer tools.</p><p>Assets are compiled and cached on the first request after the server is started.
Sprockets sets a <code>must-revalidate</code> Cache-Control HTTP header to reduce request
overhead on subsequent requests - on these the browser gets a 304 (Not Modified)
response.</p><p>If any of the files in the manifest change between requests, the server
responds with a new compiled file.</p><h2 id="in-production"><a class="anchorlink" href="#in-production"><span>5</span> In Production</a></h2><p>In the production environment Sprockets uses the fingerprinting scheme outlined
above. By default Rails assumes assets have been precompiled and will be
served as static assets by your web server.</p><p>During the precompilation phase a SHA256 is generated from the contents of the
compiled files, and inserted into the filenames as they are written to disk.
These fingerprinted names are used by the Rails helpers in place of the manifest
name.</p><p>For example this:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">"application"</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= stylesheet_link_tag &quot;application&quot; %>
">Copy</button>
</div>
<p>generates something like this:</p><div class="interstitial code">
<pre><code class="highlight html"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/assets/application-4dd5b109ee3439da54f5bdfd78a80473.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="nt">/&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<link href=&quot;/assets/application-4dd5b109ee3439da54f5bdfd78a80473.css&quot; rel=&quot;stylesheet&quot; />
">Copy</button>
</div>
<p>The fingerprinting behavior is controlled by the <a href="configuring.html#config-assets-digest"><code>config.assets.digest</code></a>
initialization option (which defaults to <code>true</code>).</p><div class="interstitial note"><p>Under normal circumstances the default <code>config.assets.digest</code> option
should not be changed. If there are no digests in the filenames, and far-future
headers are set, remote clients will never know to refetch the files when their
content changes.</p></div><h3 id="precompiling-assets"><a class="anchorlink" href="#precompiling-assets"><span>5.1</span> Precompiling Assets</a></h3><p>Rails comes bundled with a command to compile the asset manifests and other
files in the pipeline.</p><p>Compiled assets are written to the location specified in <a href="configuring.html#config-assets-prefix"><code>config.assets.prefix</code></a>.
By default, this is the <code>/assets</code> directory.</p><p>You can call this command on the server during deployment to create compiled
versions of your assets directly on the server. See the next section for
information on compiling locally.</p><p>The command is:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">RAILS_ENV</span><span class="o">=</span>production <span class="nb">rails </span>assets:precompile
</code></pre>
<button class="clipboard-button" data-clipboard-text="RAILS_ENV=production rails assets:precompile
">Copy</button>
</div>
<p>This links the folder specified in <code>config.assets.prefix</code> to <code>shared/assets</code>.
If you already use this shared folder you'll need to write your own deployment
command.</p><p>It is important that this folder is shared between deployments so that remotely
cached pages referencing the old compiled assets still work for the life of
the cached page.</p><div class="interstitial note"><p>Always specify an expected compiled filename that ends with <code>.js</code> or <code>.css</code>.</p></div><p>The command also generates a <code>.sprockets-manifest-randomhex.json</code> (where <code>randomhex</code> is
a 16-byte random hex string) that contains a list with all your assets and their respective
fingerprints. This is used by the Rails helper methods to avoid handing the
mapping requests back to Sprockets. A typical manifest file looks like this:</p><div class="interstitial code">
<pre><code class="highlight json"><span class="p">{</span><span class="nl">"files"</span><span class="p">:{</span><span class="nl">"application-&lt;fingerprint&gt;.js"</span><span class="p">:{</span><span class="nl">"logical_path"</span><span class="p">:</span><span class="s2">"application.js"</span><span class="p">,</span><span class="nl">"mtime"</span><span class="p">:</span><span class="s2">"2016-12-23T20:12:03-05:00"</span><span class="p">,</span><span class="nl">"size"</span><span class="p">:</span><span class="mi">412383</span><span class="p">,</span><span class="w">
</span><span class="nl">"digest"</span><span class="p">:</span><span class="s2">"&lt;fingerprint&gt;"</span><span class="p">,</span><span class="nl">"integrity"</span><span class="p">:</span><span class="s2">"sha256-&lt;random-string&gt;"</span><span class="p">}},</span><span class="w">
</span><span class="nl">"assets"</span><span class="p">:{</span><span class="nl">"application.js"</span><span class="p">:</span><span class="s2">"application-&lt;fingerprint&gt;.js"</span><span class="p">}}</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="{&quot;files&quot;:{&quot;application-<fingerprint>.js&quot;:{&quot;logical_path&quot;:&quot;application.js&quot;,&quot;mtime&quot;:&quot;2016-12-23T20:12:03-05:00&quot;,&quot;size&quot;:412383,
&quot;digest&quot;:&quot;<fingerprint>&quot;,&quot;integrity&quot;:&quot;sha256-<random-string>&quot;}},
&quot;assets&quot;:{&quot;application.js&quot;:&quot;application-<fingerprint>.js&quot;}}
">Copy</button>
</div>
<p>In your application, there will be more files and assets listed in the manifest,
<code>&lt;fingerprint&gt;</code> and <code>&lt;random-string&gt;</code> will also be generated.</p><p>The default location for the manifest is the root of the location specified in
<code>config.assets.prefix</code> ('/assets' by default).</p><div class="interstitial note"><p>If there are missing precompiled files in production you will get a
<code>Sprockets::Helpers::RailsHelper::AssetPaths::AssetNotPrecompiledError</code>
exception indicating the name of the missing file(s).</p></div><h4 id="far-future-expires-header"><a class="anchorlink" href="#far-future-expires-header"><span>5.1.1</span> Far-future Expires Header</a></h4><p>Precompiled assets exist on the file system and are served directly by your web
server. They do not have far-future headers by default, so to get the benefit of
fingerprinting you'll have to update your server configuration to add those
headers.</p><p>For Apache:</p><div class="interstitial code">
<pre><code class="highlight apache"><span class="c"># The Expires* directives requires the Apache module</span>
<span class="c"># `mod_expires` to be enabled.</span>
<span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> /assets/</span><span class="p">&gt;
</span>  <span class="c"># Use of ETag is discouraged when Last-Modified is present</span>
  <span class="nc">Header</span> <span class="ss">unset</span> ETag
  <span class="nc">FileETag</span> <span class="ss">None</span>
  <span class="c"># RFC says only cache for 1 year</span>
  <span class="nc">ExpiresActive</span> <span class="ss">On</span>
  <span class="nc">ExpiresDefault</span> "access plus 1 year"
<span class="p">&lt;/</span><span class="nl">Location</span><span class="p">&gt;
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="# The Expires* directives requires the Apache module
# `mod_expires` to be enabled.
<Location /assets/>
  # Use of ETag is discouraged when Last-Modified is present
  Header unset ETag
  FileETag None
  # RFC says only cache for 1 year
  ExpiresActive On
  ExpiresDefault &quot;access plus 1 year&quot;
</Location>
">Copy</button>
</div>
<p>For NGINX:</p><div class="interstitial code">
<pre><code class="highlight nginx"><span class="k">location</span> <span class="p">~</span> <span class="sr">^/assets/</span> <span class="p">{</span>
  <span class="kn">expires</span> <span class="s">1y</span><span class="p">;</span>
  <span class="kn">add_header</span> <span class="s">Cache-Control</span> <span class="s">public</span><span class="p">;</span>

  <span class="kn">add_header</span> <span class="s">ETag</span> <span class="s">""</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="location ~ ^/assets/ {
  expires 1y;
  add_header Cache-Control public;

  add_header ETag &quot;&quot;;
}
">Copy</button>
</div>
<h3 id="local-precompilation"><a class="anchorlink" href="#local-precompilation"><span>5.2</span> Local Precompilation</a></h3><p>Sometimes, you may not want or be able to compile assets on the production
server. For instance, you may have limited write access to your production
filesystem, or you may plan to deploy frequently without making any changes to
your assets.</p><p>In such cases, you can precompile assets <em>locally</em> — that is, add a finalized
set of compiled, production-ready assets to your source code repository before
pushing to production. This way, they do not need to be precompiled separately
on the production server upon each deployment.</p><p>As above, you can perform this step using</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">RAILS_ENV</span><span class="o">=</span>production <span class="nb">rails </span>assets:precompile
</code></pre>
<button class="clipboard-button" data-clipboard-text="RAILS_ENV=production rails assets:precompile
">Copy</button>
</div>
<p>Note the following caveats:</p>
<ul>
<li><p>If precompiled assets are available, they will be served — even if they no
longer match the original (uncompiled) assets, <em>even on the development
server.</em></p><p>To ensure that the development server always compiles assets on-the-fly (and
thus always reflects the most recent state of the code), the development
environment <em>must be configured to keep precompiled assets in a different
location than production does.</em> Otherwise, any assets precompiled for use in
production will clobber requests for them in development (<em>i.e.,</em> subsequent
changes you make to assets will not be reflected in the browser).</p><p>You can do this by adding the following line to
<code>config/environments/development.rb</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s2">"/dev-assets"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.prefix = &quot;/dev-assets&quot;
">Copy</button>
</div></li>
<li><p>The asset precompile task in your deployment tool (<em>e.g.,</em> Capistrano) should
be disabled.</p></li>
<li><p>Any necessary compressors or minifiers must be available on your development
system.</p></li>
</ul>
<p>You can also set <code>ENV["SECRET_KEY_BASE_DUMMY"]</code> to trigger the use of a randomly
generated <code>secret_key_base</code> that's stored in a temporary file. This is useful
when precompiling assets for production as part of a build step that otherwise
does not need access to the production secrets.</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nv">SECRET_KEY_BASE_DUMMY</span><span class="o">=</span>1 <span class="nb">bundle exec rails </span>assets:precompile
</code></pre>
<button class="clipboard-button" data-clipboard-text="SECRET_KEY_BASE_DUMMY=1 bundle exec rails assets:precompile
">Copy</button>
</div>
<h3 id="live-compilation"><a class="anchorlink" href="#live-compilation"><span>5.3</span> Live Compilation</a></h3><p>In some circumstances you may wish to use live compilation. In this mode all
requests for assets in the pipeline are handled by Sprockets directly.</p><p>To enable this option set:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.compile = true
">Copy</button>
</div>
<p>On the first request the assets are compiled and cached as outlined in <a href="#assets-cache-store">Assets
Cache Store</a>, and the manifest names used in the helpers
are altered to include the SHA256 hash.</p><p>Sprockets also sets the <code>Cache-Control</code> HTTP header to <code>max-age=31536000</code>. This
signals all caches between your server and the client browser that this content
(the file served) can be cached for 1 year. The effect of this is to reduce the
number of requests for this asset from your server; the asset has a good chance
of being in the local browser cache or some intermediate cache.</p><p>This mode uses more memory, performs more poorly than the default, and is not
recommended.</p><h3 id="cdns"><a class="anchorlink" href="#cdns"><span>5.4</span> CDNs</a></h3><p>CDN stands for <a href="https://en.wikipedia.org/wiki/Content_delivery_network">Content Delivery
Network</a>, they are
primarily designed to cache assets all over the world so that when a browser
requests the asset, a cached copy will be geographically close to that browser.
If you are serving assets directly from your Rails server in production, the
best practice is to use a CDN in front of your application.</p><p>A common pattern for using a CDN is to set your production application as the
"origin" server. This means when a browser requests an asset from the CDN and
there is a cache miss, it will grab the file from your server on the fly and
then cache it. For example if you are running a Rails application on
<code>example.com</code> and have a CDN configured at <code>mycdnsubdomain.fictional-cdn.com</code>,
then when a request is made to <code>mycdnsubdomain.fictional-cdn.com/assets/smile.png</code>,
the CDN will query your server once at
<code>example.com/assets/smile.png</code> and cache the request. The next request to the
CDN that comes in to the same URL will hit the cached copy. When the CDN can
serve an asset directly the request never touches your Rails server. Since the
assets from a CDN are geographically closer to the browser, the request is
faster, and since your server doesn't need to spend time serving assets, it can
focus on serving application code as fast as possible.</p><h4 id="set-up-a-cdn-to-serve-static-assets"><a class="anchorlink" href="#set-up-a-cdn-to-serve-static-assets"><span>5.4.1</span> Set up a CDN to Serve Static Assets</a></h4><p>To set up your CDN you have to have your application running in production on
the internet at a publicly available URL, for example <code>example.com</code>. Next
you'll need to sign up for a CDN service from a cloud hosting provider. When you
do this you need to configure the "origin" of the CDN to point back at your
website <code>example.com</code>. Check your provider for documentation on configuring the
origin server.</p><p>The CDN you provisioned should give you a custom subdomain for your application
such as <code>mycdnsubdomain.fictional-cdn.com</code> (note fictional-cdn.com is not a
valid CDN provider at the time of this writing). Now that you have configured
your CDN server, you need to tell browsers to use your CDN to grab assets
instead of your Rails server directly. You can do this by configuring Rails to
set your CDN as the asset host instead of using a relative path. To set your
asset host in Rails, you need to set <a href="configuring.html#config-asset-host"><code>config.asset_host</code></a> in
<code>config/environments/production.rb</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="s1">'mycdnsubdomain.fictional-cdn.com'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.asset_host = 'mycdnsubdomain.fictional-cdn.com'
">Copy</button>
</div>
<div class="interstitial note"><p>You only need to provide the "host", this is the subdomain and root
domain, you do not need to specify a protocol or "scheme" such as <code>http://</code> or
<code>https://</code>. When a web page is requested, the protocol in the link to your asset
that is generated will match how the webpage is accessed by default.</p></div><p>You can also set this value through an <a href="https://en.wikipedia.org/wiki/Environment_variable">environment
variable</a> to make running a
staging copy of your site easier:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'CDN_HOST'</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.asset_host = ENV['CDN_HOST']
">Copy</button>
</div>
<div class="interstitial note"><p>You would need to set <code>CDN_HOST</code> on your server to <code>mycdnsubdomain
.fictional-cdn.com</code> for this to work.</p></div><p>Once you have configured your server and your CDN, asset paths from helpers such
as:</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">asset_path</span><span class="p">(</span><span class="s1">'smile.png'</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= asset_path('smile.png') %>
">Copy</button>
</div>
<p>Will be rendered as full CDN URLs like <code>http://mycdnsubdomain.fictional-cdn.com/assets/smile.png</code>
(digest omitted for readability).</p><p>If the CDN has a copy of <code>smile.png</code>, it will serve it to the browser, and your
server doesn't even know it was requested. If the CDN does not have a copy, it
will try to find it at the "origin" <code>example.com/assets/smile.png</code>, and then store
it for future use.</p><p>If you want to serve only some assets from your CDN, you can use custom <code>:host</code>
option your asset helper, which overwrites value set in
<a href="configuring.html#config-action-controller-asset-host"><code>config.action_controller.asset_host</code></a>.</p><div class="interstitial code">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">asset_path</span> <span class="s1">'image.png'</span><span class="p">,</span> <span class="ss">host: </span><span class="s1">'mycdnsubdomain.fictional-cdn.com'</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="<%= asset_path 'image.png', host: 'mycdnsubdomain.fictional-cdn.com' %>
">Copy</button>
</div>
<h4 id="customize-cdn-caching-behavior"><a class="anchorlink" href="#customize-cdn-caching-behavior"><span>5.4.2</span> Customize CDN Caching Behavior</a></h4><p>A CDN works by caching content. If the CDN has stale or bad content, then it is
hurting rather than helping your application. The purpose of this section is to
describe general caching behavior of most CDNs. Your specific provider may
behave slightly differently.</p><h5 id="cdn-request-caching"><a class="anchorlink" href="#cdn-request-caching"><span>5.4.2.1</span> CDN Request Caching</a></h5><p>While a CDN is described as being good for caching assets, it actually caches the
entire request. This includes the body of the asset as well as any headers. The
most important one being <code>Cache-Control</code>, which tells the CDN (and web browsers)
how to cache contents. This means that if someone requests an asset that does
not exist, such as <code>/assets/i-dont-exist.png</code>, and your Rails application returns a 404,
then your CDN will likely cache the 404 page if a valid <code>Cache-Control</code> header
is present.</p><h5 id="cdn-header-debugging"><a class="anchorlink" href="#cdn-header-debugging"><span>5.4.2.2</span> CDN Header Debugging</a></h5><p>One way to check the headers are cached properly in your CDN is by using <a href="https://explainshell.com/explain?cmd=curl+-I+http%3A%2F%2Fwww.example.com">curl</a>. You
can request the headers from both your server and your CDN to verify they are
the same:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> http://www.example/assets/application-
<span class="go">d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK
Server: Cowboy
Date: Sun, 24 Aug 2014 20:27:50 GMT
Connection: keep-alive
Last-Modified: Thu, 08 May 2014 01:24:14 GMT
Content-Type: text/css
Cache-Control: public, max-age=2592000
Content-Length: 126560
Via: 1.1 vegur
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="curl -I http://www.example/assets/application-
">Copy</button>
</div>
<p>Versus the CDN copy:</p><div class="interstitial code">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> http://mycdnsubdomain.fictional-cdn.com/application-
<span class="go">d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK Server: Cowboy Last-
Modified: Thu, 08 May 2014 01:24:14 GMT Content-Type: text/css
Cache-Control:
public, max-age=2592000
Via: 1.1 vegur
Content-Length: 126560
Accept-Ranges:
bytes
Date: Sun, 24 Aug 2014 20:28:45 GMT
Via: 1.1 varnish
Age: 885814
Connection: keep-alive
X-Served-By: cache-dfw1828-DFW
X-Cache: HIT
X-Cache-Hits:
68
X-Timer: S1408912125.211638212,VS0,VE0
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="curl -I http://mycdnsubdomain.fictional-cdn.com/application-
">Copy</button>
</div>
<p>Check your CDN documentation for any additional information they may provide
such as <code>X-Cache</code> or for any additional headers they may add.</p><h5 id="cdns-and-the-cache-control-header"><a class="anchorlink" href="#cdns-and-the-cache-control-header"><span>5.4.2.3</span> CDNs and the Cache-Control Header</a></h5><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control"><code>Cache-Control</code></a> header describes how a request can be cached. When no CDN is used, a
browser will use this information to cache contents. This is very helpful for
assets that are not modified so that a browser does not need to re-download a
website's CSS or JavaScript on every request. Generally we want our Rails server
to tell our CDN (and browser) that the asset is "public". That means any cache
can store the request. Also we commonly want to set <code>max-age</code> which is how long
the cache will store the object before invalidating the cache. The <code>max-age</code>
value is set to seconds with a maximum possible value of <code>31536000</code>, which is one
year. You can do this in your Rails application by setting</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=31536000'</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.public_file_server.headers = {
  'Cache-Control' => 'public, max-age=31536000'
}
">Copy</button>
</div>
<p>Now when your application serves an asset in production, the CDN will store the
asset for up to a year. Since most CDNs also cache headers of the request, this
<code>Cache-Control</code> will be passed along to all future browsers seeking this asset.
The browser then knows that it can store this asset for a very long time before
needing to re-request it.</p><h5 id="cdns-and-url-based-cache-invalidation"><a class="anchorlink" href="#cdns-and-url-based-cache-invalidation"><span>5.4.2.4</span> CDNs and URL-based Cache Invalidation</a></h5><p>Most CDNs will cache contents of an asset based on the complete URL. This means
that a request to</p><div class="interstitial code">
<pre><code class="highlight plaintext">http://mycdnsubdomain.fictional-cdn.com/assets/smile-123.png
</code></pre>
<button class="clipboard-button" data-clipboard-text="http://mycdnsubdomain.fictional-cdn.com/assets/smile-123.png
">Copy</button>
</div>
<p>Will be a completely different cache from</p><div class="interstitial code">
<pre><code class="highlight plaintext">http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
</code></pre>
<button class="clipboard-button" data-clipboard-text="http://mycdnsubdomain.fictional-cdn.com/assets/smile.png
">Copy</button>
</div>
<p>If you want to set far future <code>max-age</code> in your <code>Cache-Control</code> (and you do),
then make sure when you change your assets that your cache is invalidated. For
example when changing the smiley face in an image from yellow to blue, you want
all visitors of your site to get the new blue face. When using a CDN with the
Rails asset pipeline <code>config.assets.digest</code> is set to true by default so that
each asset will have a different file name when it is changed. This way you
don't have to ever manually invalidate any items in your cache. By using a
different unique asset name instead, your users get the latest asset.</p><h2 id="customizing-the-pipeline"><a class="anchorlink" href="#customizing-the-pipeline"><span>6</span> Customizing the Pipeline</a></h2><h3 id="css-compression"><a class="anchorlink" href="#css-compression"><span>6.1</span> CSS Compression</a></h3><p>One of the options for compressing CSS is YUI. The <a href="https://yui.github.io/yuicompressor/css.html">YUI CSS
compressor</a> provides
minification.</p><p>The following line enables YUI compression, and requires the <code>yui-compressor</code>
gem.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="ss">:yui</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.css_compressor = :yui
">Copy</button>
</div>
<h3 id="javascript-compression"><a class="anchorlink" href="#javascript-compression"><span>6.2</span> JavaScript Compression</a></h3><p>Possible options for JavaScript compression are <code>:terser</code>, <code>:closure</code> and
<code>:yui</code>. These require the use of the <code>terser</code>, <code>closure-compiler</code> or
<code>yui-compressor</code> gems, respectively.</p><p>Take the <code>terser</code> gem, for example.
This gem wraps <a href="https://github.com/terser/terser">Terser</a> (written for
Node.js) in Ruby. It compresses your code by removing white space and comments,
shortening local variable names, and performing other micro-optimizations such
as changing <code>if</code> and <code>else</code> statements to ternary operators where possible.</p><p>The following line invokes <code>terser</code> for JavaScript compression.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:terser</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.js_compressor = :terser
">Copy</button>
</div>
<div class="interstitial note"><p>You will need an <a href="https://github.com/rails/execjs#readme">ExecJS</a>
supported runtime in order to use <code>terser</code>. If you are using macOS or
Windows you have a JavaScript runtime installed in your operating system.</p></div><div class="interstitial note"><p>The JavaScript compression will also work for your JavaScript files when you are loading your assets through <code>importmap-rails</code> or <code>jsbundling-rails</code> gems.</p></div><h3 id="gzipping-your-assets"><a class="anchorlink" href="#gzipping-your-assets"><span>6.3</span> GZipping your assets</a></h3><p>By default, gzipped version of compiled assets will be generated, along with
the non-gzipped version of assets. Gzipped assets help reduce the transmission
of data over the wire. You can configure this by setting the <code>gzip</code> flag.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">gzip</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># disable gzipped assets generation</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.gzip = false # disable gzipped assets generation
">Copy</button>
</div>
<p>Refer to your web server's documentation for instructions on how to serve gzipped assets.</p><h3 id="using-your-own-compressor"><a class="anchorlink" href="#using-your-own-compressor"><span>6.4</span> Using Your Own Compressor</a></h3><p>The compressor config settings for CSS and JavaScript also take any object.
This object must have a <code>compress</code> method that takes a string as the sole
argument and it must return a string.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Transformer</span>
  <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">do_something_returning_a_string</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Transformer
  def compress(string)
    do_something_returning_a_string(string)
  end
end
">Copy</button>
</div>
<p>To enable this, pass a new object to the config option in <code>application.rb</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">css_compressor</span> <span class="o">=</span> <span class="no">Transformer</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.css_compressor = Transformer.new
">Copy</button>
</div>
<h3 id="changing-the-assets-path"><a class="anchorlink" href="#changing-the-assets-path"><span>6.5</span> Changing the <em>assets</em> Path</a></h3><p>The public path that Sprockets uses by default is <code>/assets</code>.</p><p>This can be changed to something else:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s2">"/some_other_path"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.prefix = &quot;/some_other_path&quot;
">Copy</button>
</div>
<p>This is a handy option if you are updating an older project that didn't use the
asset pipeline and already uses this path or you wish to use this path for
a new resource.</p><h3 id="x-sendfile-headers"><a class="anchorlink" href="#x-sendfile-headers"><span>6.6</span> X-Sendfile Headers</a></h3><p>The X-Sendfile header is a directive to the web server to ignore the response
from the application, and instead serve a specified file from disk. This option
is off by default, but can be enabled if your server supports it. When enabled,
this passes responsibility for serving the file to the web server, which is
faster. Have a look at <a href="https://edgeapi.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_file">send_file</a>
on how to use this feature.</p><p>Apache and NGINX support this option, which can be enabled in
<code>config/environments/production.rb</code>:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="c1"># config.action_dispatch.x_sendfile_header = "X-Sendfile" # for Apache</span>
<span class="c1"># config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for NGINX</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config.action_dispatch.x_sendfile_header = &quot;X-Sendfile&quot; # for Apache
# config.action_dispatch.x_sendfile_header = 'X-Accel-Redirect' # for NGINX
">Copy</button>
</div>
<div class="interstitial warning"><p>If you are upgrading an existing application and intend to use this
option, take care to paste this configuration option only into <code>production.rb</code>
and any other environments you define with production behavior (not
<code>application.rb</code>).</p></div><div class="interstitial info"><p>For further details have a look at the docs of your production web server:</p></div>
<ul>
<li><a href="https://tn123.org/mod_xsendfile/">Apache</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/">NGINX</a></li>
</ul>
<h2 id="assets-cache-store"><a class="anchorlink" href="#assets-cache-store"><span>7</span> Assets Cache Store</a></h2><p>By default, Sprockets caches assets in <code>tmp/cache/assets</code> in development
and production environments. This can be changed as follows:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
  <span class="n">env</span><span class="p">.</span><span class="nf">cache</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Cache</span><span class="p">.</span><span class="nf">lookup_store</span><span class="p">(</span><span class="ss">:memory_store</span><span class="p">,</span>
                                                <span class="p">{</span> <span class="ss">size: </span><span class="mi">32</span><span class="p">.</span><span class="nf">megabytes</span> <span class="p">})</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.configure do |env|
  env.cache = ActiveSupport::Cache.lookup_store(:memory_store,
                                                { size: 32.megabytes })
end
">Copy</button>
</div>
<p>To disable the assets cache store:</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
  <span class="n">env</span><span class="p">.</span><span class="nf">cache</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Cache</span><span class="p">.</span><span class="nf">lookup_store</span><span class="p">(</span><span class="ss">:null_store</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.configure do |env|
  env.cache = ActiveSupport::Cache.lookup_store(:null_store)
end
">Copy</button>
</div>
<h2 id="adding-assets-to-your-gems"><a class="anchorlink" href="#adding-assets-to-your-gems"><span>8</span> Adding Assets to Your Gems</a></h2><p>Assets can also come from external sources in the form of gems.</p><p>A good example of this is the <code>jquery-rails</code> gem.
This gem contains an engine class which inherits from <code>Rails::Engine</code>.
By doing this, Rails is informed that the directory for this
gem may contain assets and the <code>app/assets</code>, <code>lib/assets</code> and
<code>vendor/assets</code> directories of this engine are added to the search path of
Sprockets.</p><h2 id="making-your-library-or-gem-a-pre-processor"><a class="anchorlink" href="#making-your-library-or-gem-a-pre-processor"><span>9</span> Making Your Library or Gem a Pre-Processor</a></h2><p>Sprockets uses Processors, Transformers, Compressors, and Exporters to extend
Sprockets functionality. Have a look at
<a href="https://github.com/rails/sprockets/blob/main/guides/extending_sprockets.md">Extending Sprockets</a>
to learn more. Here we registered a preprocessor to add a comment to the end
of text/css (<code>.css</code>) files.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">AddComment</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">data: </span><span class="n">input</span><span class="p">[</span><span class="ss">:data</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"/* Hello From my sprockets extension */"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module AddComment
  def self.call(input)
    { data: input[:data] + &quot;/* Hello From my sprockets extension */&quot; }
  end
end
">Copy</button>
</div>
<p>Now that you have a module that modifies the input data, it's time to register
it as a preprocessor for your MIME type.</p><div class="interstitial code">
<pre><code class="highlight ruby"><span class="no">Sprockets</span><span class="p">.</span><span class="nf">register_preprocessor</span> <span class="s1">'text/css'</span><span class="p">,</span> <span class="no">AddComment</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Sprockets.register_preprocessor 'text/css', AddComment
">Copy</button>
</div>
<h2 id="alternative-libraries"><a class="anchorlink" href="#alternative-libraries"><span>10</span> Alternative Libraries</a></h2><p>Over the years there have been multiple default approaches for handling the assets. The web evolved and we started to see more and more JavaScript-heavy applications. In The Rails Doctrine we believe that <a href="https://rubyonrails.org/doctrine#omakase">The Menu Is Omakase</a> so we focused on the default setup: <strong>Sprockets with Import Maps</strong>.</p><p>We are aware that there are no one-size-fits-it-all solutions for the various JavaScript and CSS frameworks/extensions available. There are other bundling libraries in the Rails ecosystem that should empower you in the cases where the default setup isn't enough.</p><h3 id="jsbundling-rails"><a class="anchorlink" href="#jsbundling-rails"><span>10.1</span> jsbundling-rails</a></h3><p><a href="https://github.com/rails/jsbundling-rails"><code>jsbundling-rails</code></a> is a JavaScript run-time dependent alternative to the <code>importmap-rails</code> way of bundling JS with <a href="https://bun.sh">Bun</a>,&nbsp;<a href="https://esbuild.github.io/">esbuild</a>,&nbsp;<a href="https://rollupjs.org/">rollup.js</a>, or&nbsp;<a href="https://webpack.js.org/">Webpack</a>.</p><p>The gem provides a build task in <code>package.json</code> to watch for changes and automatically generate output in development. For production, it automatically hooks <code>javascript:build</code> task into <code>assets:precompile</code> task to ensure that all your package dependencies have been installed and JavaScript has been built for all entry points.</p><p><strong>When to use instead of <code>importmap-rails</code>?</strong> If your JavaScript code depends on transpiling so if you are using <a href="https://babeljs.io/">Babel</a>, <a href="https://www.typescriptlang.org/">TypeScript</a> or React JSX format then <code>jsbundling-rails</code> is the correct way to go.</p><h3 id="webpacker-shakapacker"><a class="anchorlink" href="#webpacker-shakapacker"><span>10.2</span> Webpacker/Shakapacker</a></h3><p><a href="https://github.com/rails/webpacker"><code>Webpacker</code></a> was the default JavaScript pre-processor and bundler for Rails 5 and 6. It has now been retired. A successor called <a href="https://github.com/shakacode/shakapacker"><code>shakapacker</code></a> exists, but is not maintained by the Rails team or project.</p><p>Unlike other libraries in this list <code>webpacker</code>/<code>shakapacker</code> is completely independent of Sprockets and could process both JavaScript and CSS files.</p><div class="interstitial note"><p>Read the <a href="https://github.com/rails/jsbundling-rails/blob/main/docs/comparison_with_webpacker.md">Comparison with Webpacker</a> document to understand the differences between <code>jsbundling-rails</code> and <code>webpacker</code>/<code>shakapacker</code>.</p></div><h3 id="cssbundling-rails"><a class="anchorlink" href="#cssbundling-rails"><span>10.3</span> cssbundling-rails</a></h3><p><a href="https://github.com/rails/cssbundling-rails"><code>cssbundling-rails</code></a> allows bundling and processing of your CSS using <a href="https://tailwindcss.com/">Tailwind CSS</a>, <a href="https://getbootstrap.com/">Bootstrap</a>, <a href="https://bulma.io/">Bulma</a>, <a href="https://postcss.org/">PostCSS</a>, or <a href="https://sass-lang.com/">Dart Sass</a>, then delivers the CSS via the asset pipeline.</p><p>It works in a similar way to <code>jsbundling-rails</code> so adds the Node.js dependency to your application with <code>yarn build:css --watch</code> process to regenerate your stylesheets in development and hooks into <code>assets:precompile</code> task in production.</p><p><strong>What's the difference between Sprockets?</strong> Sprockets on its own is not able to transpile the Sass into CSS, Node.js is required to generate the <code>.css</code> files from your <code>.sass</code>  files. Once the <code>.css</code> files are generated then Sprockets is able to deliver them to your clients.</p><div class="interstitial note"><p><code>cssbundling-rails</code> relies on Node to process the CSS. The <code>dartsass-rails</code> and <code>tailwindcss-rails</code> gems use standalone versions of Tailwind CSS and Dart Sass, meaning no Node dependency. If you are using <code>importmap-rails</code> to handle your JavaScripts and <code>dartsass-rails</code> or <code>tailwindcss-rails</code> for CSS you could completely avoid the Node dependency resulting in a less complex solution.</p></div><h3 id="dartsass-rails"><a class="anchorlink" href="#dartsass-rails"><span>10.4</span> dartsass-rails</a></h3><p>If you want to use <a href="https://sass-lang.com/">Sass</a> in your application, <a href="https://github.com/rails/dartsass-rails"><code>dartsass-rails</code></a> comes as a replacement for the legacy <code>sassc-rails</code> gem. <code>dartsass-rails</code> uses the Dart Sass implementation in favour of deprecated in 2020 <a href="https://sass-lang.com/blog/libsass-is-deprecated">LibSass</a> used by <code>sassc-rails</code>.</p><p>Unlike <code>sassc-rails</code> the new gem is not directly integrated with Sprockets. Please refer to the <a href="https://github.com/rails/dartsass-rails">gem homepage</a> for installation/migration instructions.</p><div class="interstitial warning"><p>The popular <code>sassc-rails</code> gem is unmaintained since 2019.</p></div><h3 id="tailwindcss-rails"><a class="anchorlink" href="#tailwindcss-rails"><span>10.5</span> tailwindcss-rails</a></h3><p><a href="https://github.com/rails/tailwindcss-rails"><code>tailwindcss-rails</code></a> is a wrapper gem for <a href="https://tailwindcss.com/blog/standalone-cli">the standalone executable version</a> of Tailwind CSS v3 framework. Used for new applications when <code>--css tailwind</code> is provided to the <code>rails new</code> command. Provides a <code>watch</code> process to automatically generate Tailwind output in development. For production it hooks into <code>assets:precompile</code> task.</p>
        <hr>
        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>.
        </p>
      </div>
    </div>
  </main>

  <hr class="hide" />
  <footer id="page_footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </footer>
</body>
</html>
